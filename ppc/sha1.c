begin_unit
begin_comment
comment|/*  * SHA-1 implementation.  *  * Copyright (C) 2005 Paul Mackerras<paulus@samba.org>  *  * This version assumes we are running on a big-endian machine.  * It calls an external sha1_core() to process blocks of 64 bytes.  */
end_comment
begin_include
include|#
directive|include
file|<stdio.h>
end_include
begin_include
include|#
directive|include
file|<string.h>
end_include
begin_include
include|#
directive|include
file|"sha1.h"
end_include
begin_function_decl
specifier|extern
name|void
name|sha1_core
parameter_list|(
name|uint32_t
modifier|*
name|hash
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|p
parameter_list|,
name|unsigned
name|int
name|nblocks
parameter_list|)
function_decl|;
end_function_decl
begin_function
DECL|function|SHA1_Init
name|int
name|SHA1_Init
parameter_list|(
name|SHA_CTX
modifier|*
name|c
parameter_list|)
block|{
name|c
operator|->
name|hash
index|[
literal|0
index|]
operator|=
literal|0x67452301
expr_stmt|;
name|c
operator|->
name|hash
index|[
literal|1
index|]
operator|=
literal|0xEFCDAB89
expr_stmt|;
name|c
operator|->
name|hash
index|[
literal|2
index|]
operator|=
literal|0x98BADCFE
expr_stmt|;
name|c
operator|->
name|hash
index|[
literal|3
index|]
operator|=
literal|0x10325476
expr_stmt|;
name|c
operator|->
name|hash
index|[
literal|4
index|]
operator|=
literal|0xC3D2E1F0
expr_stmt|;
name|c
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|cnt
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function
begin_function
DECL|function|SHA1_Update
name|int
name|SHA1_Update
parameter_list|(
name|SHA_CTX
modifier|*
name|c
parameter_list|,
specifier|const
name|void
modifier|*
name|ptr
parameter_list|,
name|unsigned
name|long
name|n
parameter_list|)
block|{
name|unsigned
name|long
name|nb
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|p
init|=
name|ptr
decl_stmt|;
name|c
operator|->
name|len
operator|+=
name|n
operator|<<
literal|3
expr_stmt|;
while|while
condition|(
name|n
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|cnt
operator|||
name|n
operator|<
literal|64
condition|)
block|{
name|nb
operator|=
literal|64
operator|-
name|c
operator|->
name|cnt
expr_stmt|;
if|if
condition|(
name|nb
operator|>
name|n
condition|)
name|nb
operator|=
name|n
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|c
operator|->
name|buf
operator|.
name|b
index|[
name|c
operator|->
name|cnt
index|]
argument_list|,
name|p
argument_list|,
name|nb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|->
name|cnt
operator|+=
name|nb
operator|)
operator|==
literal|64
condition|)
block|{
name|sha1_core
argument_list|(
name|c
operator|->
name|hash
argument_list|,
name|c
operator|->
name|buf
operator|.
name|b
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|c
operator|->
name|cnt
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|nb
operator|=
name|n
operator|>>
literal|6
expr_stmt|;
name|sha1_core
argument_list|(
name|c
operator|->
name|hash
argument_list|,
name|p
argument_list|,
name|nb
argument_list|)
expr_stmt|;
name|nb
operator|<<=
literal|6
expr_stmt|;
block|}
name|n
operator|-=
name|nb
expr_stmt|;
name|p
operator|+=
name|nb
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function
begin_function
DECL|function|SHA1_Final
name|int
name|SHA1_Final
parameter_list|(
name|unsigned
name|char
modifier|*
name|hash
parameter_list|,
name|SHA_CTX
modifier|*
name|c
parameter_list|)
block|{
name|unsigned
name|int
name|cnt
init|=
name|c
operator|->
name|cnt
decl_stmt|;
name|c
operator|->
name|buf
operator|.
name|b
index|[
name|cnt
operator|++
index|]
operator|=
literal|0x80
expr_stmt|;
if|if
condition|(
name|cnt
operator|>
literal|56
condition|)
block|{
if|if
condition|(
name|cnt
operator|<
literal|64
condition|)
name|memset
argument_list|(
operator|&
name|c
operator|->
name|buf
operator|.
name|b
index|[
name|cnt
index|]
argument_list|,
literal|0
argument_list|,
literal|64
operator|-
name|cnt
argument_list|)
expr_stmt|;
name|sha1_core
argument_list|(
name|c
operator|->
name|hash
argument_list|,
name|c
operator|->
name|buf
operator|.
name|b
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|<
literal|56
condition|)
name|memset
argument_list|(
operator|&
name|c
operator|->
name|buf
operator|.
name|b
index|[
name|cnt
index|]
argument_list|,
literal|0
argument_list|,
literal|56
operator|-
name|cnt
argument_list|)
expr_stmt|;
name|c
operator|->
name|buf
operator|.
name|l
index|[
literal|7
index|]
operator|=
name|c
operator|->
name|len
expr_stmt|;
name|sha1_core
argument_list|(
name|c
operator|->
name|hash
argument_list|,
name|c
operator|->
name|buf
operator|.
name|b
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|hash
argument_list|,
name|c
operator|->
name|hash
argument_list|,
literal|20
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function
end_unit
