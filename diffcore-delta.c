begin_unit
begin_include
include|#
directive|include
file|"cache.h"
end_include
begin_include
include|#
directive|include
file|"diff.h"
end_include
begin_include
include|#
directive|include
file|"diffcore.h"
end_include
begin_struct
DECL|struct|linehash
struct|struct
name|linehash
block|{
DECL|member|bytes
name|unsigned
name|long
name|bytes
decl_stmt|;
DECL|member|hash
name|unsigned
name|long
name|hash
decl_stmt|;
block|}
struct|;
end_struct
begin_function
DECL|function|hash_extended_line
specifier|static
name|unsigned
name|long
name|hash_extended_line
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
modifier|*
name|buf_p
parameter_list|,
name|unsigned
name|long
name|left
parameter_list|)
block|{
comment|/* An extended line is zero or more whitespace letters (including LF) 	 * followed by one non whitespace letter followed by zero or more 	 * non LF, and terminated with by a LF (or EOF). 	 */
specifier|const
name|unsigned
name|char
modifier|*
name|bol
init|=
operator|*
name|buf_p
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|buf
init|=
name|bol
decl_stmt|;
name|unsigned
name|long
name|hashval
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|left
condition|)
block|{
name|unsigned
name|c
init|=
operator|*
name|buf
operator|++
decl_stmt|;
if|if
condition|(
operator|!
name|c
condition|)
goto|goto
name|binary
goto|;
name|left
operator|--
expr_stmt|;
if|if
condition|(
literal|' '
operator|<
name|c
condition|)
block|{
name|hashval
operator|=
name|c
expr_stmt|;
break|break;
block|}
block|}
while|while
condition|(
name|left
condition|)
block|{
name|unsigned
name|c
init|=
operator|*
name|buf
operator|++
decl_stmt|;
if|if
condition|(
operator|!
name|c
condition|)
goto|goto
name|binary
goto|;
name|left
operator|--
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\n'
condition|)
break|break;
if|if
condition|(
literal|' '
operator|<
name|c
condition|)
name|hashval
operator|=
name|hashval
operator|*
literal|11
operator|+
name|c
expr_stmt|;
block|}
operator|*
name|buf_p
operator|=
name|buf
expr_stmt|;
return|return
name|hashval
return|;
name|binary
label|:
operator|*
name|buf_p
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function
begin_function
DECL|function|linehash_compare
specifier|static
name|int
name|linehash_compare
parameter_list|(
specifier|const
name|void
modifier|*
name|a_
parameter_list|,
specifier|const
name|void
modifier|*
name|b_
parameter_list|)
block|{
name|struct
name|linehash
modifier|*
name|a
init|=
operator|(
expr|struct
name|linehash
operator|*
operator|)
name|a_
decl_stmt|;
name|struct
name|linehash
modifier|*
name|b
init|=
operator|(
expr|struct
name|linehash
operator|*
operator|)
name|b_
decl_stmt|;
if|if
condition|(
name|a
operator|->
name|hash
operator|<
name|b
operator|->
name|hash
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|a
operator|->
name|hash
operator|>
name|b
operator|->
name|hash
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function
begin_function
DECL|function|hash_lines
specifier|static
name|struct
name|linehash
modifier|*
name|hash_lines
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|unsigned
name|long
name|size
parameter_list|)
block|{
specifier|const
name|unsigned
name|char
modifier|*
name|eobuf
init|=
name|buf
operator|+
name|size
decl_stmt|;
name|struct
name|linehash
modifier|*
name|line
init|=
name|NULL
decl_stmt|;
name|int
name|alloc
init|=
literal|0
decl_stmt|,
name|used
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|buf
operator|<
name|eobuf
condition|)
block|{
specifier|const
name|unsigned
name|char
modifier|*
name|ptr
init|=
name|buf
decl_stmt|;
name|unsigned
name|long
name|hash
init|=
name|hash_extended_line
argument_list|(
operator|&
name|buf
argument_list|,
name|eobuf
operator|-
name|ptr
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
block|{
name|free
argument_list|(
name|line
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|alloc
operator|<=
name|used
condition|)
block|{
name|alloc
operator|=
name|alloc_nr
argument_list|(
name|alloc
argument_list|)
expr_stmt|;
name|line
operator|=
name|xrealloc
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|line
argument_list|)
operator|*
name|alloc
argument_list|)
expr_stmt|;
block|}
name|line
index|[
name|used
index|]
operator|.
name|bytes
operator|=
name|buf
operator|-
name|ptr
expr_stmt|;
name|line
index|[
name|used
index|]
operator|.
name|hash
operator|=
name|hash
expr_stmt|;
name|used
operator|++
expr_stmt|;
block|}
name|qsort
argument_list|(
name|line
argument_list|,
name|used
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|line
argument_list|)
argument_list|,
name|linehash_compare
argument_list|)
expr_stmt|;
comment|/* Terminate the list */
if|if
condition|(
name|alloc
operator|<=
name|used
condition|)
name|line
operator|=
name|xrealloc
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|line
argument_list|)
operator|*
operator|(
name|used
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|line
index|[
name|used
index|]
operator|.
name|bytes
operator|=
name|line
index|[
name|used
index|]
operator|.
name|hash
operator|=
literal|0
expr_stmt|;
return|return
name|line
return|;
block|}
end_function
begin_function
DECL|function|diffcore_count_changes
name|int
name|diffcore_count_changes
parameter_list|(
name|void
modifier|*
name|src
parameter_list|,
name|unsigned
name|long
name|src_size
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|unsigned
name|long
name|dst_size
parameter_list|,
name|unsigned
name|long
name|delta_limit
parameter_list|,
name|unsigned
name|long
modifier|*
name|src_copied
parameter_list|,
name|unsigned
name|long
modifier|*
name|literal_added
parameter_list|)
block|{
name|struct
name|linehash
modifier|*
name|src_lines
decl_stmt|,
modifier|*
name|dst_lines
decl_stmt|;
name|unsigned
name|long
name|sc
decl_stmt|,
name|la
decl_stmt|;
name|src_lines
operator|=
name|hash_lines
argument_list|(
name|src
argument_list|,
name|src_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|src_lines
condition|)
return|return
operator|-
literal|1
return|;
name|dst_lines
operator|=
name|hash_lines
argument_list|(
name|dst
argument_list|,
name|dst_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dst_lines
condition|)
block|{
name|free
argument_list|(
name|src_lines
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|sc
operator|=
name|la
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|src_lines
operator|->
name|bytes
operator|&&
name|dst_lines
operator|->
name|bytes
condition|)
block|{
name|int
name|cmp
init|=
name|linehash_compare
argument_list|(
name|src_lines
argument_list|,
name|dst_lines
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|cmp
condition|)
block|{
name|sc
operator|+=
name|src_lines
operator|->
name|bytes
expr_stmt|;
name|src_lines
operator|++
expr_stmt|;
name|dst_lines
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|cmp
operator|<
literal|0
condition|)
block|{
name|src_lines
operator|++
expr_stmt|;
continue|continue;
block|}
name|la
operator|+=
name|dst_lines
operator|->
name|bytes
expr_stmt|;
name|dst_lines
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|dst_lines
operator|->
name|bytes
condition|)
block|{
name|la
operator|+=
name|dst_lines
operator|->
name|bytes
expr_stmt|;
name|dst_lines
operator|++
expr_stmt|;
block|}
operator|*
name|src_copied
operator|=
name|sc
expr_stmt|;
operator|*
name|literal_added
operator|=
name|la
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function
end_unit
