begin_unit
begin_include
include|#
directive|include
file|"userdiff.h"
end_include
begin_include
include|#
directive|include
file|"cache.h"
end_include
begin_include
include|#
directive|include
file|"attr.h"
end_include
begin_decl_stmt
DECL|variable|drivers
specifier|static
name|struct
name|userdiff_driver
modifier|*
name|drivers
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|ndrivers
specifier|static
name|int
name|ndrivers
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|drivers_alloc
specifier|static
name|int
name|drivers_alloc
decl_stmt|;
end_decl_stmt
begin_define
DECL|macro|FUNCNAME
define|#
directive|define
name|FUNCNAME
parameter_list|(
name|name
parameter_list|,
name|pattern
parameter_list|)
define|\
value|{ name, NULL, { pattern, REG_EXTENDED } }
end_define
begin_decl_stmt
DECL|variable|builtin_drivers
specifier|static
name|struct
name|userdiff_driver
name|builtin_drivers
index|[]
init|=
block|{
name|FUNCNAME
argument_list|(
literal|"html"
argument_list|,
literal|"^[ \t]*(<[Hh][1-6][ \t].*>.*)$"
argument_list|)
block|,
name|FUNCNAME
argument_list|(
literal|"java"
argument_list|,
literal|"!^[ \t]*(catch|do|for|if|instanceof|new|return|switch|throw|while)\n"
literal|"^[ \t]*(([ \t]*[A-Za-z_][A-Za-z_0-9]*){2,}[ \t]*\\([^;]*)$"
argument_list|)
block|,
name|FUNCNAME
argument_list|(
literal|"objc"
argument_list|,
comment|/* Negate C statements that can look like functions */
literal|"!^[ \t]*(do|for|if|else|return|switch|while)\n"
comment|/* Objective-C methods */
literal|"^[ \t]*([-+][ \t]*\\([ \t]*[A-Za-z_][A-Za-z_0-9* \t]*\\)[ \t]*[A-Za-z_].*)$\n"
comment|/* C functions */
literal|"^[ \t]*(([ \t]*[A-Za-z_][A-Za-z_0-9]*){2,}[ \t]*\\([^;]*)$\n"
comment|/* Objective-C class/protocol definitions */
literal|"^(@(implementation|interface|protocol)[ \t].*)$"
argument_list|)
block|,
name|FUNCNAME
argument_list|(
literal|"pascal"
argument_list|,
literal|"^((procedure|function|constructor|destructor|interface|"
literal|"implementation|initialization|finalization)[ \t]*.*)$"
literal|"\n"
literal|"^(.*=[ \t]*(class|record).*)$"
argument_list|)
block|,
name|FUNCNAME
argument_list|(
literal|"php"
argument_list|,
literal|"^[\t ]*((function|class).*)"
argument_list|)
block|,
name|FUNCNAME
argument_list|(
literal|"python"
argument_list|,
literal|"^[ \t]*((class|def)[ \t].*)$"
argument_list|)
block|,
name|FUNCNAME
argument_list|(
literal|"ruby"
argument_list|,
literal|"^[ \t]*((class|module|def)[ \t].*)$"
argument_list|)
block|,
name|FUNCNAME
argument_list|(
literal|"bibtex"
argument_list|,
literal|"(@[a-zA-Z]{1,}[ \t]*\\{{0,1}[ \t]*[^ \t\"@',\\#}{~%]*).*$"
argument_list|)
block|,
name|FUNCNAME
argument_list|(
literal|"tex"
argument_list|,
literal|"^(\\\\((sub)*section|chapter|part)\\*{0,1}\\{.*)$"
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt
begin_undef
DECL|macro|FUNCNAME
undef|#
directive|undef
name|FUNCNAME
end_undef
begin_decl_stmt
DECL|variable|driver_true
specifier|static
name|struct
name|userdiff_driver
name|driver_true
init|=
block|{
literal|"diff=true"
block|,
name|NULL
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|USERDIFF_ATTR_TRUE
name|struct
name|userdiff_driver
modifier|*
name|USERDIFF_ATTR_TRUE
init|=
operator|&
name|driver_true
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|driver_false
specifier|static
name|struct
name|userdiff_driver
name|driver_false
init|=
block|{
literal|"!diff"
block|,
name|NULL
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|USERDIFF_ATTR_FALSE
name|struct
name|userdiff_driver
modifier|*
name|USERDIFF_ATTR_FALSE
init|=
operator|&
name|driver_false
decl_stmt|;
end_decl_stmt
begin_function
DECL|function|userdiff_find_by_namelen
specifier|static
name|struct
name|userdiff_driver
modifier|*
name|userdiff_find_by_namelen
parameter_list|(
specifier|const
name|char
modifier|*
name|k
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ndrivers
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|userdiff_driver
modifier|*
name|drv
init|=
name|drivers
operator|+
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|drv
operator|->
name|name
argument_list|,
name|k
argument_list|,
name|len
argument_list|)
operator|&&
operator|!
name|drv
operator|->
name|name
index|[
name|len
index|]
condition|)
return|return
name|drv
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|builtin_drivers
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|userdiff_driver
modifier|*
name|drv
init|=
name|builtin_drivers
operator|+
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|drv
operator|->
name|name
argument_list|,
name|k
argument_list|,
name|len
argument_list|)
operator|&&
operator|!
name|drv
operator|->
name|name
index|[
name|len
index|]
condition|)
return|return
name|drv
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function
begin_function
DECL|function|parse_driver
specifier|static
name|struct
name|userdiff_driver
modifier|*
name|parse_driver
parameter_list|(
specifier|const
name|char
modifier|*
name|var
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|)
block|{
name|struct
name|userdiff_driver
modifier|*
name|drv
decl_stmt|;
specifier|const
name|char
modifier|*
name|dot
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|namelen
decl_stmt|;
if|if
condition|(
name|prefixcmp
argument_list|(
name|var
argument_list|,
literal|"diff."
argument_list|)
condition|)
return|return
name|NULL
return|;
name|dot
operator|=
name|strrchr
argument_list|(
name|var
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
if|if
condition|(
name|dot
operator|==
name|var
operator|+
literal|4
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|type
argument_list|,
name|dot
operator|+
literal|1
argument_list|)
condition|)
return|return
name|NULL
return|;
name|name
operator|=
name|var
operator|+
literal|5
expr_stmt|;
name|namelen
operator|=
name|dot
operator|-
name|name
expr_stmt|;
name|drv
operator|=
name|userdiff_find_by_namelen
argument_list|(
name|name
argument_list|,
name|namelen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drv
condition|)
block|{
name|ALLOC_GROW
argument_list|(
name|drivers
argument_list|,
name|ndrivers
operator|+
literal|1
argument_list|,
name|drivers_alloc
argument_list|)
expr_stmt|;
name|drv
operator|=
operator|&
name|drivers
index|[
name|ndrivers
operator|++
index|]
expr_stmt|;
name|memset
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|drv
argument_list|)
argument_list|)
expr_stmt|;
name|drv
operator|->
name|name
operator|=
name|xmemdupz
argument_list|(
name|name
argument_list|,
name|namelen
argument_list|)
expr_stmt|;
block|}
return|return
name|drv
return|;
block|}
end_function
begin_function
DECL|function|parse_funcname
specifier|static
name|int
name|parse_funcname
parameter_list|(
name|struct
name|userdiff_funcname
modifier|*
name|f
parameter_list|,
specifier|const
name|char
modifier|*
name|k
parameter_list|,
specifier|const
name|char
modifier|*
name|v
parameter_list|,
name|int
name|cflags
parameter_list|)
block|{
if|if
condition|(
name|git_config_string
argument_list|(
operator|&
name|f
operator|->
name|pattern
argument_list|,
name|k
argument_list|,
name|v
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|f
operator|->
name|cflags
operator|=
name|cflags
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function
begin_function
DECL|function|parse_string
specifier|static
name|int
name|parse_string
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|d
parameter_list|,
specifier|const
name|char
modifier|*
name|k
parameter_list|,
specifier|const
name|char
modifier|*
name|v
parameter_list|)
block|{
if|if
condition|(
name|git_config_string
argument_list|(
name|d
argument_list|,
name|k
argument_list|,
name|v
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|1
return|;
block|}
end_function
begin_function
DECL|function|userdiff_config_basic
name|int
name|userdiff_config_basic
parameter_list|(
specifier|const
name|char
modifier|*
name|k
parameter_list|,
specifier|const
name|char
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|userdiff_driver
modifier|*
name|drv
decl_stmt|;
if|if
condition|(
operator|(
name|drv
operator|=
name|parse_driver
argument_list|(
name|k
argument_list|,
name|v
argument_list|,
literal|"funcname"
argument_list|)
operator|)
condition|)
return|return
name|parse_funcname
argument_list|(
operator|&
name|drv
operator|->
name|funcname
argument_list|,
name|k
argument_list|,
name|v
argument_list|,
literal|0
argument_list|)
return|;
if|if
condition|(
operator|(
name|drv
operator|=
name|parse_driver
argument_list|(
name|k
argument_list|,
name|v
argument_list|,
literal|"xfuncname"
argument_list|)
operator|)
condition|)
return|return
name|parse_funcname
argument_list|(
operator|&
name|drv
operator|->
name|funcname
argument_list|,
name|k
argument_list|,
name|v
argument_list|,
name|REG_EXTENDED
argument_list|)
return|;
return|return
literal|0
return|;
block|}
end_function
begin_function
DECL|function|userdiff_config_porcelain
name|int
name|userdiff_config_porcelain
parameter_list|(
specifier|const
name|char
modifier|*
name|k
parameter_list|,
specifier|const
name|char
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|userdiff_driver
modifier|*
name|drv
decl_stmt|;
if|if
condition|(
operator|(
name|drv
operator|=
name|parse_driver
argument_list|(
name|k
argument_list|,
name|v
argument_list|,
literal|"command"
argument_list|)
operator|)
condition|)
return|return
name|parse_string
argument_list|(
operator|&
name|drv
operator|->
name|external
argument_list|,
name|k
argument_list|,
name|v
argument_list|)
return|;
return|return
literal|0
return|;
block|}
end_function
begin_function
DECL|function|userdiff_find_by_name
name|struct
name|userdiff_driver
modifier|*
name|userdiff_find_by_name
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|len
init|=
name|strlen
argument_list|(
name|name
argument_list|)
decl_stmt|;
return|return
name|userdiff_find_by_namelen
argument_list|(
name|name
argument_list|,
name|len
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|userdiff_find_by_path
name|struct
name|userdiff_driver
modifier|*
name|userdiff_find_by_path
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
specifier|static
name|struct
name|git_attr
modifier|*
name|attr
decl_stmt|;
name|struct
name|git_attr_check
name|check
decl_stmt|;
if|if
condition|(
operator|!
name|attr
condition|)
name|attr
operator|=
name|git_attr
argument_list|(
literal|"diff"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|check
operator|.
name|attr
operator|=
name|attr
expr_stmt|;
if|if
condition|(
operator|!
name|path
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|git_checkattr
argument_list|(
name|path
argument_list|,
literal|1
argument_list|,
operator|&
name|check
argument_list|)
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|ATTR_TRUE
argument_list|(
name|check
operator|.
name|value
argument_list|)
condition|)
return|return
operator|&
name|driver_true
return|;
if|if
condition|(
name|ATTR_FALSE
argument_list|(
name|check
operator|.
name|value
argument_list|)
condition|)
return|return
operator|&
name|driver_false
return|;
if|if
condition|(
name|ATTR_UNSET
argument_list|(
name|check
operator|.
name|value
argument_list|)
condition|)
return|return
name|NULL
return|;
return|return
name|userdiff_find_by_name
argument_list|(
name|check
operator|.
name|value
argument_list|)
return|;
block|}
end_function
end_unit
