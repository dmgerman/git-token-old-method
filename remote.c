begin_unit
begin_include
include|#
directive|include
file|"cache.h"
end_include
begin_include
include|#
directive|include
file|"remote.h"
end_include
begin_include
include|#
directive|include
file|"refs.h"
end_include
begin_decl_stmt
DECL|variable|remotes
specifier|static
name|struct
name|remote
modifier|*
modifier|*
name|remotes
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|allocated_remotes
specifier|static
name|int
name|allocated_remotes
decl_stmt|;
end_decl_stmt
begin_define
DECL|macro|BUF_SIZE
define|#
directive|define
name|BUF_SIZE
value|(2048)
end_define
begin_decl_stmt
DECL|variable|buffer
specifier|static
name|char
name|buffer
index|[
name|BUF_SIZE
index|]
decl_stmt|;
end_decl_stmt
begin_function
DECL|function|add_push_refspec
specifier|static
name|void
name|add_push_refspec
parameter_list|(
name|struct
name|remote
modifier|*
name|remote
parameter_list|,
specifier|const
name|char
modifier|*
name|ref
parameter_list|)
block|{
name|int
name|nr
init|=
name|remote
operator|->
name|push_refspec_nr
operator|+
literal|1
decl_stmt|;
name|remote
operator|->
name|push_refspec
operator|=
name|xrealloc
argument_list|(
name|remote
operator|->
name|push_refspec
argument_list|,
name|nr
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|remote
operator|->
name|push_refspec
index|[
name|nr
operator|-
literal|1
index|]
operator|=
name|ref
expr_stmt|;
name|remote
operator|->
name|push_refspec_nr
operator|=
name|nr
expr_stmt|;
block|}
end_function
begin_function
DECL|function|add_uri
specifier|static
name|void
name|add_uri
parameter_list|(
name|struct
name|remote
modifier|*
name|remote
parameter_list|,
specifier|const
name|char
modifier|*
name|uri
parameter_list|)
block|{
name|int
name|nr
init|=
name|remote
operator|->
name|uri_nr
operator|+
literal|1
decl_stmt|;
name|remote
operator|->
name|uri
operator|=
name|xrealloc
argument_list|(
name|remote
operator|->
name|uri
argument_list|,
name|nr
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|remote
operator|->
name|uri
index|[
name|nr
operator|-
literal|1
index|]
operator|=
name|uri
expr_stmt|;
name|remote
operator|->
name|uri_nr
operator|=
name|nr
expr_stmt|;
block|}
end_function
begin_function
DECL|function|make_remote
specifier|static
name|struct
name|remote
modifier|*
name|make_remote
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|empty
init|=
operator|-
literal|1
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|allocated_remotes
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|remotes
index|[
name|i
index|]
condition|)
block|{
if|if
condition|(
name|empty
operator|<
literal|0
condition|)
name|empty
operator|=
name|i
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|len
condition|?
operator|(
operator|!
name|strncmp
argument_list|(
name|name
argument_list|,
name|remotes
index|[
name|i
index|]
operator|->
name|name
argument_list|,
name|len
argument_list|)
operator|&&
operator|!
name|remotes
index|[
name|i
index|]
operator|->
name|name
index|[
name|len
index|]
operator|)
else|:
operator|!
name|strcmp
argument_list|(
name|name
argument_list|,
name|remotes
index|[
name|i
index|]
operator|->
name|name
argument_list|)
condition|)
return|return
name|remotes
index|[
name|i
index|]
return|;
block|}
block|}
if|if
condition|(
name|empty
operator|<
literal|0
condition|)
block|{
name|empty
operator|=
name|allocated_remotes
expr_stmt|;
name|allocated_remotes
operator|+=
name|allocated_remotes
condition|?
name|allocated_remotes
else|:
literal|1
expr_stmt|;
name|remotes
operator|=
name|xrealloc
argument_list|(
name|remotes
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|remotes
argument_list|)
operator|*
name|allocated_remotes
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|remotes
operator|+
name|empty
argument_list|,
literal|0
argument_list|,
operator|(
name|allocated_remotes
operator|-
name|empty
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|remotes
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|remotes
index|[
name|empty
index|]
operator|=
name|xcalloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|remote
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
condition|)
name|remotes
index|[
name|empty
index|]
operator|->
name|name
operator|=
name|xstrndup
argument_list|(
name|name
argument_list|,
name|len
argument_list|)
expr_stmt|;
else|else
name|remotes
index|[
name|empty
index|]
operator|->
name|name
operator|=
name|xstrdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
name|remotes
index|[
name|empty
index|]
return|;
block|}
end_function
begin_function
DECL|function|read_remotes_file
specifier|static
name|void
name|read_remotes_file
parameter_list|(
name|struct
name|remote
modifier|*
name|remote
parameter_list|)
block|{
name|FILE
modifier|*
name|f
init|=
name|fopen
argument_list|(
name|git_path
argument_list|(
literal|"remotes/%s"
argument_list|,
name|remote
operator|->
name|name
argument_list|)
argument_list|,
literal|"r"
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
return|return;
while|while
condition|(
name|fgets
argument_list|(
name|buffer
argument_list|,
name|BUF_SIZE
argument_list|,
name|f
argument_list|)
condition|)
block|{
name|int
name|value_list
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|!
name|prefixcmp
argument_list|(
name|buffer
argument_list|,
literal|"URL:"
argument_list|)
condition|)
block|{
name|value_list
operator|=
literal|0
expr_stmt|;
name|s
operator|=
name|buffer
operator|+
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|prefixcmp
argument_list|(
name|buffer
argument_list|,
literal|"Push:"
argument_list|)
condition|)
block|{
name|value_list
operator|=
literal|1
expr_stmt|;
name|s
operator|=
name|buffer
operator|+
literal|5
expr_stmt|;
block|}
else|else
continue|continue;
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|s
argument_list|)
condition|)
name|s
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|s
condition|)
continue|continue;
name|p
operator|=
name|s
operator|+
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
while|while
condition|(
name|isspace
argument_list|(
name|p
index|[
operator|-
literal|1
index|]
argument_list|)
condition|)
operator|*
operator|--
name|p
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|value_list
condition|)
block|{
case|case
literal|0
case|:
name|add_uri
argument_list|(
name|remote
argument_list|,
name|xstrdup
argument_list|(
name|s
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|add_push_refspec
argument_list|(
name|remote
argument_list|,
name|xstrdup
argument_list|(
name|s
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|read_branches_file
specifier|static
name|void
name|read_branches_file
parameter_list|(
name|struct
name|remote
modifier|*
name|remote
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|slash
init|=
name|strchr
argument_list|(
name|remote
operator|->
name|name
argument_list|,
literal|'/'
argument_list|)
decl_stmt|;
name|int
name|n
init|=
name|slash
condition|?
name|slash
operator|-
name|remote
operator|->
name|name
else|:
literal|1000
decl_stmt|;
name|FILE
modifier|*
name|f
init|=
name|fopen
argument_list|(
name|git_path
argument_list|(
literal|"branches/%.*s"
argument_list|,
name|n
argument_list|,
name|remote
operator|->
name|name
argument_list|)
argument_list|,
literal|"r"
argument_list|)
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
return|return;
name|s
operator|=
name|fgets
argument_list|(
name|buffer
argument_list|,
name|BUF_SIZE
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s
condition|)
return|return;
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|s
argument_list|)
condition|)
name|s
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|s
condition|)
return|return;
name|p
operator|=
name|s
operator|+
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
while|while
condition|(
name|isspace
argument_list|(
name|p
index|[
operator|-
literal|1
index|]
argument_list|)
condition|)
operator|*
operator|--
name|p
operator|=
literal|0
expr_stmt|;
name|len
operator|=
name|p
operator|-
name|s
expr_stmt|;
if|if
condition|(
name|slash
condition|)
name|len
operator|+=
name|strlen
argument_list|(
name|slash
argument_list|)
expr_stmt|;
name|p
operator|=
name|xmalloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|p
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|slash
condition|)
name|strcat
argument_list|(
name|p
argument_list|,
name|slash
argument_list|)
expr_stmt|;
name|add_uri
argument_list|(
name|remote
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
end_function
begin_decl_stmt
DECL|variable|default_remote_name
specifier|static
name|char
modifier|*
name|default_remote_name
init|=
name|NULL
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|current_branch
specifier|static
specifier|const
name|char
modifier|*
name|current_branch
init|=
name|NULL
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|current_branch_len
specifier|static
name|int
name|current_branch_len
init|=
literal|0
decl_stmt|;
end_decl_stmt
begin_function
DECL|function|handle_config
specifier|static
name|int
name|handle_config
parameter_list|(
specifier|const
name|char
modifier|*
name|key
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
specifier|const
name|char
modifier|*
name|subkey
decl_stmt|;
name|struct
name|remote
modifier|*
name|remote
decl_stmt|;
if|if
condition|(
operator|!
name|prefixcmp
argument_list|(
name|key
argument_list|,
literal|"branch."
argument_list|)
operator|&&
name|current_branch
operator|&&
operator|!
name|strncmp
argument_list|(
name|key
operator|+
literal|7
argument_list|,
name|current_branch
argument_list|,
name|current_branch_len
argument_list|)
operator|&&
operator|!
name|strcmp
argument_list|(
name|key
operator|+
literal|7
operator|+
name|current_branch_len
argument_list|,
literal|".remote"
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|default_remote_name
argument_list|)
expr_stmt|;
name|default_remote_name
operator|=
name|xstrdup
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|prefixcmp
argument_list|(
name|key
argument_list|,
literal|"remote."
argument_list|)
condition|)
return|return
literal|0
return|;
name|name
operator|=
name|key
operator|+
literal|7
expr_stmt|;
name|subkey
operator|=
name|strrchr
argument_list|(
name|name
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|subkey
condition|)
return|return
name|error
argument_list|(
literal|"Config with no key for remote %s"
argument_list|,
name|name
argument_list|)
return|;
if|if
condition|(
operator|*
name|subkey
operator|==
literal|'/'
condition|)
block|{
name|warning
argument_list|(
literal|"Config remote shorthand cannot begin with '/': %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|remote
operator|=
name|make_remote
argument_list|(
name|name
argument_list|,
name|subkey
operator|-
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|value
condition|)
block|{
comment|/* if we ever have a boolean variable, e.g. "remote.*.disabled" 		 * [remote "frotz"] 		 *      disabled 		 * is a valid way to set it to true; we get NULL in value so 		 * we need to handle it here. 		 * 		 * if (!strcmp(subkey, ".disabled")) { 		 *      val = git_config_bool(key, value); 		 *      return 0; 		 * } else 		 * 		 */
return|return
literal|0
return|;
comment|/* ignore unknown booleans */
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|subkey
argument_list|,
literal|".url"
argument_list|)
condition|)
block|{
name|add_uri
argument_list|(
name|remote
argument_list|,
name|xstrdup
argument_list|(
name|value
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|subkey
argument_list|,
literal|".push"
argument_list|)
condition|)
block|{
name|add_push_refspec
argument_list|(
name|remote
argument_list|,
name|xstrdup
argument_list|(
name|value
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|subkey
argument_list|,
literal|".receivepack"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|remote
operator|->
name|receivepack
condition|)
name|remote
operator|->
name|receivepack
operator|=
name|xstrdup
argument_list|(
name|value
argument_list|)
expr_stmt|;
else|else
name|error
argument_list|(
literal|"more than one receivepack given, using the first"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function
begin_function
DECL|function|read_config
specifier|static
name|void
name|read_config
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|char
name|sha1
index|[
literal|20
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|head_ref
decl_stmt|;
name|int
name|flag
decl_stmt|;
if|if
condition|(
name|default_remote_name
condition|)
comment|// did this already
return|return;
name|default_remote_name
operator|=
name|xstrdup
argument_list|(
literal|"origin"
argument_list|)
expr_stmt|;
name|current_branch
operator|=
name|NULL
expr_stmt|;
name|head_ref
operator|=
name|resolve_ref
argument_list|(
literal|"HEAD"
argument_list|,
name|sha1
argument_list|,
literal|0
argument_list|,
operator|&
name|flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|head_ref
operator|&&
operator|(
name|flag
operator|&
name|REF_ISSYMREF
operator|)
operator|&&
operator|!
name|prefixcmp
argument_list|(
name|head_ref
argument_list|,
literal|"refs/heads/"
argument_list|)
condition|)
block|{
name|current_branch
operator|=
name|head_ref
operator|+
name|strlen
argument_list|(
literal|"refs/heads/"
argument_list|)
expr_stmt|;
name|current_branch_len
operator|=
name|strlen
argument_list|(
name|current_branch
argument_list|)
expr_stmt|;
block|}
name|git_config
argument_list|(
name|handle_config
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|remote_get
name|struct
name|remote
modifier|*
name|remote_get
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|remote
modifier|*
name|ret
decl_stmt|;
name|read_config
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|name
condition|)
name|name
operator|=
name|default_remote_name
expr_stmt|;
name|ret
operator|=
name|make_remote
argument_list|(
name|name
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
index|[
literal|0
index|]
operator|!=
literal|'/'
condition|)
block|{
if|if
condition|(
operator|!
name|ret
operator|->
name|uri
condition|)
name|read_remotes_file
argument_list|(
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
operator|->
name|uri
condition|)
name|read_branches_file
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ret
operator|->
name|uri
condition|)
name|add_uri
argument_list|(
name|ret
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
operator|->
name|uri
condition|)
return|return
name|NULL
return|;
return|return
name|ret
return|;
block|}
end_function
end_unit
