begin_unit
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'subprocess'
newline|'\n'
name|'import'
name|'sys'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|GitExporter
name|'class'
name|'GitExporter'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""An exporter for testgit repositories.\n\n    The exporter simply delegates to git fast-export.\n    """'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'repo'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Creates a new exporter for the specified repo.\n        """'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'repo'
op|'='
name|'repo'
newline|'\n'
nl|'\n'
DECL|member|export_repo
dedent|''
name|'def'
name|'export_repo'
op|'('
name|'self'
op|','
name|'base'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Exports a fast-export stream for the given directory.\n\n        Simply delegates to git fast-epxort and pipes it through sed\n        to make the refs show up under the prefix rather than the\n        default refs/heads. This is to demonstrate how the export\n        data can be stored under it\'s own ref (using the refspec\n        capability).\n        """'
newline|'\n'
nl|'\n'
name|'dirname'
op|'='
name|'self'
op|'.'
name|'repo'
op|'.'
name|'get_base_path'
op|'('
name|'base'
op|')'
newline|'\n'
name|'path'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'abspath'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'dirname'
op|','
string|"'testgit.marks'"
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'dirname'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'dirname'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'print'
string|'"feature relative-marks"'
newline|'\n'
name|'if'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'dirname'
op|','
string|"'git.marks'"
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'print'
string|'"feature import-marks=%s/git.marks"'
op|'%'
name|'self'
op|'.'
name|'repo'
op|'.'
name|'hash'
newline|'\n'
dedent|''
name|'print'
string|'"feature export-marks=%s/git.marks"'
op|'%'
name|'self'
op|'.'
name|'repo'
op|'.'
name|'hash'
newline|'\n'
name|'sys'
op|'.'
name|'stdout'
op|'.'
name|'flush'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'args'
op|'='
op|'['
string|'"git"'
op|','
string|'"--git-dir="'
op|'+'
name|'self'
op|'.'
name|'repo'
op|'.'
name|'gitpath'
op|','
string|'"fast-export"'
op|','
string|'"--export-marks="'
op|'+'
name|'path'
op|']'
newline|'\n'
nl|'\n'
name|'if'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'args'
op|'.'
name|'append'
op|'('
string|'"--import-marks="'
op|'+'
name|'path'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'args'
op|'.'
name|'append'
op|'('
string|'"HEAD"'
op|')'
newline|'\n'
nl|'\n'
name|'p1'
op|'='
name|'subprocess'
op|'.'
name|'Popen'
op|'('
name|'args'
op|','
name|'stdout'
op|'='
name|'subprocess'
op|'.'
name|'PIPE'
op|')'
newline|'\n'
nl|'\n'
name|'args'
op|'='
op|'['
string|'"sed"'
op|','
string|'"s_refs/heads/_"'
op|'+'
name|'self'
op|'.'
name|'repo'
op|'.'
name|'prefix'
op|'+'
string|'"_g"'
op|']'
newline|'\n'
nl|'\n'
name|'child'
op|'='
name|'subprocess'
op|'.'
name|'Popen'
op|'('
name|'args'
op|','
name|'stdin'
op|'='
name|'p1'
op|'.'
name|'stdout'
op|')'
newline|'\n'
name|'if'
name|'child'
op|'.'
name|'wait'
op|'('
op|')'
op|'!='
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'CalledProcessError'
newline|'\n'
dedent|''
dedent|''
dedent|''
endmarker|''
end_unit
