begin_unit
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'subprocess'
newline|'\n'
nl|'\n'
DECL|function|sanitize
name|'def'
name|'sanitize'
op|'('
name|'rev'
op|','
name|'sep'
op|'='
string|"'\\t'"
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Converts a for-each-ref line to a name/value pair.\n    """'
newline|'\n'
nl|'\n'
name|'splitrev'
op|'='
name|'rev'
op|'.'
name|'split'
op|'('
name|'sep'
op|')'
newline|'\n'
name|'branchval'
op|'='
name|'splitrev'
op|'['
number|'0'
op|']'
newline|'\n'
name|'branchname'
op|'='
name|'splitrev'
op|'['
number|'1'
op|']'
op|'.'
name|'strip'
op|'('
op|')'
newline|'\n'
name|'if'
name|'branchname'
op|'.'
name|'startswith'
op|'('
string|'"refs/heads/"'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'branchname'
op|'='
name|'branchname'
op|'['
number|'11'
op|':'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'return'
name|'branchname'
op|','
name|'branchval'
newline|'\n'
nl|'\n'
DECL|function|is_remote
dedent|''
name|'def'
name|'is_remote'
op|'('
name|'url'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Checks whether the specified value is a remote url.\n    """'
newline|'\n'
nl|'\n'
name|'prefixes'
op|'='
op|'['
string|'"http"'
op|','
string|'"file"'
op|','
string|'"git"'
op|']'
newline|'\n'
nl|'\n'
name|'return'
name|'any'
op|'('
name|'url'
op|'.'
name|'startswith'
op|'('
name|'i'
op|')'
name|'for'
name|'i'
name|'in'
name|'prefixes'
op|')'
newline|'\n'
nl|'\n'
DECL|class|GitRepo
dedent|''
name|'class'
name|'GitRepo'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Repo object representing a repo.\n    """'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'path'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Initializes a new repo at the given path.\n        """'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'path'
op|'='
name|'path'
newline|'\n'
name|'self'
op|'.'
name|'head'
op|'='
name|'None'
newline|'\n'
name|'self'
op|'.'
name|'revmap'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'local'
op|'='
name|'not'
name|'is_remote'
op|'('
name|'self'
op|'.'
name|'path'
op|')'
newline|'\n'
nl|'\n'
name|'if'
op|'('
name|'self'
op|'.'
name|'path'
op|'.'
name|'endswith'
op|'('
string|"'.git'"
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'gitpath'
op|'='
name|'self'
op|'.'
name|'path'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'gitpath'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'path'
op|','
string|"'.git'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'self'
op|'.'
name|'local'
name|'and'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'self'
op|'.'
name|'gitpath'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'self'
op|'.'
name|'gitpath'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_revs
dedent|''
dedent|''
name|'def'
name|'get_revs'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Fetches all revs from the remote.\n        """'
newline|'\n'
nl|'\n'
name|'args'
op|'='
op|'['
string|'"git"'
op|','
string|'"ls-remote"'
op|','
name|'self'
op|'.'
name|'gitpath'
op|']'
newline|'\n'
name|'path'
op|'='
string|'".cached_revs"'
newline|'\n'
name|'ofile'
op|'='
name|'open'
op|'('
name|'path'
op|','
string|'"w"'
op|')'
newline|'\n'
nl|'\n'
name|'subprocess'
op|'.'
name|'check_call'
op|'('
name|'args'
op|','
name|'stdout'
op|'='
name|'ofile'
op|')'
newline|'\n'
name|'output'
op|'='
name|'open'
op|'('
name|'path'
op|')'
op|'.'
name|'readlines'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'revmap'
op|'='
name|'dict'
op|'('
name|'sanitize'
op|'('
name|'i'
op|')'
name|'for'
name|'i'
name|'in'
name|'output'
op|')'
newline|'\n'
name|'if'
string|'"HEAD"'
name|'in'
name|'self'
op|'.'
name|'revmap'
op|':'
newline|'\n'
indent|'            '
name|'del'
name|'self'
op|'.'
name|'revmap'
op|'['
string|'"HEAD"'
op|']'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'revs'
op|'='
name|'self'
op|'.'
name|'revmap'
op|'.'
name|'keys'
op|'('
op|')'
newline|'\n'
name|'ofile'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_head
dedent|''
name|'def'
name|'get_head'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Determines the head of a local repo.\n        """'
newline|'\n'
nl|'\n'
name|'if'
name|'not'
name|'self'
op|'.'
name|'local'
op|':'
newline|'\n'
indent|'            '
name|'return'
newline|'\n'
nl|'\n'
dedent|''
name|'path'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'gitpath'
op|','
string|'"HEAD"'
op|')'
newline|'\n'
name|'head'
op|'='
name|'open'
op|'('
name|'path'
op|')'
op|'.'
name|'readline'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'head'
op|','
name|'_'
op|'='
name|'sanitize'
op|'('
name|'head'
op|','
string|"' '"
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
