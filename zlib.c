begin_unit
begin_comment
comment|/*  * zlib wrappers to make sure we don't silently miss errors  * at init time.  */
end_comment
begin_include
include|#
directive|include
file|"cache.h"
end_include
begin_function
DECL|function|zerr_to_string
specifier|static
specifier|const
name|char
modifier|*
name|zerr_to_string
parameter_list|(
name|int
name|status
parameter_list|)
block|{
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|Z_MEM_ERROR
case|:
return|return
literal|"out of memory"
return|;
case|case
name|Z_VERSION_ERROR
case|:
return|return
literal|"wrong version"
return|;
case|case
name|Z_NEED_DICT
case|:
return|return
literal|"needs dictionary"
return|;
case|case
name|Z_DATA_ERROR
case|:
return|return
literal|"data stream error"
return|;
case|case
name|Z_STREAM_ERROR
case|:
return|return
literal|"stream consistency error"
return|;
default|default:
return|return
literal|"unknown error"
return|;
block|}
block|}
end_function
begin_function
DECL|function|git_inflate_init
name|void
name|git_inflate_init
parameter_list|(
name|z_streamp
name|strm
parameter_list|)
block|{
name|int
name|status
init|=
name|inflateInit
argument_list|(
name|strm
argument_list|)
decl_stmt|;
if|if
condition|(
name|status
operator|==
name|Z_OK
condition|)
return|return;
name|die
argument_list|(
literal|"inflateInit: %s (%s)"
argument_list|,
name|zerr_to_string
argument_list|(
name|status
argument_list|)
argument_list|,
name|strm
operator|->
name|msg
condition|?
name|strm
operator|->
name|msg
else|:
literal|"no message"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|git_inflate_end
name|void
name|git_inflate_end
parameter_list|(
name|z_streamp
name|strm
parameter_list|)
block|{
name|int
name|status
init|=
name|inflateEnd
argument_list|(
name|strm
argument_list|)
decl_stmt|;
if|if
condition|(
name|status
operator|==
name|Z_OK
condition|)
return|return;
name|error
argument_list|(
literal|"inflateEnd: %s (%s)"
argument_list|,
name|zerr_to_string
argument_list|(
name|status
argument_list|)
argument_list|,
name|strm
operator|->
name|msg
condition|?
name|strm
operator|->
name|msg
else|:
literal|"no message"
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|git_inflate
name|int
name|git_inflate
parameter_list|(
name|z_streamp
name|strm
parameter_list|,
name|int
name|flush
parameter_list|)
block|{
name|int
name|status
init|=
name|inflate
argument_list|(
name|strm
argument_list|,
name|flush
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
comment|/* Z_BUF_ERROR: normal, needs more space in the output buffer */
case|case
name|Z_BUF_ERROR
case|:
case|case
name|Z_OK
case|:
case|case
name|Z_STREAM_END
case|:
return|return
name|status
return|;
case|case
name|Z_MEM_ERROR
case|:
name|die
argument_list|(
literal|"inflate: out of memory"
argument_list|)
expr_stmt|;
default|default:
break|break;
block|}
name|error
argument_list|(
literal|"inflate: %s (%s)"
argument_list|,
name|zerr_to_string
argument_list|(
name|status
argument_list|)
argument_list|,
name|strm
operator|->
name|msg
condition|?
name|strm
operator|->
name|msg
else|:
literal|"no message"
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function
end_unit
