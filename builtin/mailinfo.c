begin_unit
begin_comment
comment|/*  * Another stupid program, this one parsing the headers of an  * email to figure out authorship and subject  */
end_comment
begin_include
include|#
directive|include
file|"cache.h"
end_include
begin_include
include|#
directive|include
file|"builtin.h"
end_include
begin_include
include|#
directive|include
file|"utf8.h"
end_include
begin_include
include|#
directive|include
file|"strbuf.h"
end_include
begin_include
include|#
directive|include
file|"mailinfo.h"
end_include
begin_decl_stmt
DECL|variable|mailinfo_usage
specifier|static
specifier|const
name|char
name|mailinfo_usage
index|[]
init|=
literal|"git mailinfo [-k | -b] [-m | --message-id] [-u | --encoding=<encoding> | -n] [--scissors | --no-scissors]<msg><patch>< mail>info"
decl_stmt|;
end_decl_stmt
begin_function
DECL|function|cmd_mailinfo
name|int
name|cmd_mailinfo
parameter_list|(
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|def_charset
decl_stmt|;
name|struct
name|mailinfo
name|mi
decl_stmt|;
name|int
name|status
decl_stmt|;
comment|/* NEEDSWORK: might want to do the optional .git/ directory 	 * discovery 	 */
name|setup_mailinfo
argument_list|(
operator|&
name|mi
argument_list|)
expr_stmt|;
name|def_charset
operator|=
name|get_commit_output_encoding
argument_list|()
expr_stmt|;
name|mi
operator|.
name|metainfo_charset
operator|=
name|def_charset
expr_stmt|;
while|while
condition|(
literal|1
operator|<
name|argc
operator|&&
name|argv
index|[
literal|1
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"-k"
argument_list|)
condition|)
name|mi
operator|.
name|keep_subject
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"-b"
argument_list|)
condition|)
name|mi
operator|.
name|keep_non_patch_brackets_in_subject
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"-m"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"--message-id"
argument_list|)
condition|)
name|mi
operator|.
name|add_message_id
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"-u"
argument_list|)
condition|)
name|mi
operator|.
name|metainfo_charset
operator|=
name|def_charset
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"-n"
argument_list|)
condition|)
name|mi
operator|.
name|metainfo_charset
operator|=
name|NULL
expr_stmt|;
elseif|else
if|if
condition|(
name|starts_with
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"--encoding="
argument_list|)
condition|)
name|mi
operator|.
name|metainfo_charset
operator|=
name|argv
index|[
literal|1
index|]
operator|+
literal|11
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"--scissors"
argument_list|)
condition|)
name|mi
operator|.
name|use_scissors
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"--no-scissors"
argument_list|)
condition|)
name|mi
operator|.
name|use_scissors
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"--no-inbody-headers"
argument_list|)
condition|)
name|mi
operator|.
name|use_inbody_headers
operator|=
literal|0
expr_stmt|;
else|else
name|usage
argument_list|(
name|mailinfo_usage
argument_list|)
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|!=
literal|3
condition|)
name|usage
argument_list|(
name|mailinfo_usage
argument_list|)
expr_stmt|;
name|mi
operator|.
name|input
operator|=
name|stdin
expr_stmt|;
name|mi
operator|.
name|output
operator|=
name|stdout
expr_stmt|;
name|status
operator|=
operator|!
operator|!
name|mailinfo
argument_list|(
operator|&
name|mi
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|clear_mailinfo
argument_list|(
operator|&
name|mi
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function
end_unit
