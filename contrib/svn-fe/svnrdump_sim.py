begin_unit
comment|'#!/usr/bin/python'
nl|'\n'
string|'"""\nSimulates svnrdump by replaying an existing dump from a file, taking care\nof the specified revision range.\nTo simulate incremental imports the environment variable SVNRMAX can be set\nto the highest revision that should be available.\n"""'
newline|'\n'
name|'import'
name|'sys'
op|','
name|'os'
newline|'\n'
nl|'\n'
name|'if'
name|'sys'
op|'.'
name|'hexversion'
op|'<'
number|'0x02040000'
op|':'
newline|'\n'
comment|'# The limiter is the ValueError() calls. This may be too conservative'
nl|'\n'
indent|'        '
name|'sys'
op|'.'
name|'stderr'
op|'.'
name|'write'
op|'('
string|'"svnrdump-sim.py: requires Python 2.4 or later.\\n"'
op|')'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|function|getrevlimit
dedent|''
name|'def'
name|'getrevlimit'
op|'('
op|')'
op|':'
newline|'\n'
indent|'        '
name|'var'
op|'='
string|"'SVNRMAX'"
newline|'\n'
name|'if'
name|'os'
op|'.'
name|'environ'
op|'.'
name|'has_key'
op|'('
name|'var'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'os'
op|'.'
name|'environ'
op|'['
name|'var'
op|']'
newline|'\n'
dedent|''
name|'return'
name|'None'
newline|'\n'
nl|'\n'
DECL|function|writedump
dedent|''
name|'def'
name|'writedump'
op|'('
name|'url'
op|','
name|'lower'
op|','
name|'upper'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'url'
op|'.'
name|'startswith'
op|'('
string|"'sim://'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'filename'
op|'='
name|'url'
op|'['
number|'6'
op|':'
op|']'
newline|'\n'
name|'if'
name|'filename'
op|'['
op|'-'
number|'1'
op|']'
op|'=='
string|"'/'"
op|':'
name|'filename'
op|'='
name|'filename'
op|'['
op|':'
op|'-'
number|'1'
op|']'
comment|'#remove terminating slash'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'ValueError'
op|'('
string|"'sim:// url required'"
op|')'
newline|'\n'
dedent|''
name|'f'
op|'='
name|'open'
op|'('
name|'filename'
op|','
string|"'r'"
op|')'
op|';'
newline|'\n'
name|'state'
op|'='
string|"'header'"
newline|'\n'
name|'wroterev'
op|'='
name|'False'
newline|'\n'
name|'while'
op|'('
name|'True'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'l'
op|'='
name|'f'
op|'.'
name|'readline'
op|'('
op|')'
newline|'\n'
name|'if'
name|'l'
op|'=='
string|"''"
op|':'
name|'break'
newline|'\n'
name|'if'
name|'state'
op|'=='
string|"'header'"
name|'and'
name|'l'
op|'.'
name|'startswith'
op|'('
string|"'Revision-number: '"
op|')'
op|':'
newline|'\n'
indent|'                        '
name|'state'
op|'='
string|"'prefix'"
newline|'\n'
dedent|''
name|'if'
name|'state'
op|'=='
string|"'prefix'"
name|'and'
name|'l'
op|'=='
string|"'Revision-number: %s\\n'"
op|'%'
name|'lower'
op|':'
newline|'\n'
indent|'                        '
name|'state'
op|'='
string|"'selection'"
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'upper'
op|'=='
string|"'HEAD'"
name|'and'
name|'state'
op|'=='
string|"'selection'"
name|'and'
name|'l'
op|'=='
string|"'Revision-number: %s\\n'"
op|'%'
name|'upper'
op|':'
newline|'\n'
indent|'                        '
name|'break'
op|';'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'state'
op|'=='
string|"'header'"
name|'or'
name|'state'
op|'=='
string|"'selection'"
op|':'
newline|'\n'
indent|'                        '
name|'if'
name|'state'
op|'=='
string|"'selection'"
op|':'
name|'wroterev'
op|'='
name|'True'
newline|'\n'
name|'sys'
op|'.'
name|'stdout'
op|'.'
name|'write'
op|'('
name|'l'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'wroterev'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'__name__'
op|'=='
string|'"__main__"'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
op|'('
name|'len'
op|'('
name|'sys'
op|'.'
name|'argv'
op|')'
name|'in'
op|'('
number|'3'
op|','
number|'4'
op|','
number|'5'
op|')'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'print'
string|'"usage: %s dump URL -rLOWER:UPPER"'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
number|'1'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'sys'
op|'.'
name|'argv'
op|'['
number|'1'
op|']'
op|'=='
string|"'dump'"
op|':'
name|'raise'
name|'NotImplementedError'
op|'('
string|'\'only "dump" is suppported.\''
op|')'
newline|'\n'
DECL|variable|url
name|'url'
op|'='
name|'sys'
op|'.'
name|'argv'
op|'['
number|'2'
op|']'
newline|'\n'
DECL|variable|r
name|'r'
op|'='
op|'('
string|"'0'"
op|','
string|"'HEAD'"
op|')'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'sys'
op|'.'
name|'argv'
op|')'
op|'=='
number|'4'
name|'and'
name|'sys'
op|'.'
name|'argv'
op|'['
number|'3'
op|']'
op|'['
number|'0'
op|':'
number|'2'
op|']'
op|'=='
string|"'-r'"
op|':'
newline|'\n'
DECL|variable|r
indent|'                '
name|'r'
op|'='
name|'sys'
op|'.'
name|'argv'
op|'['
number|'3'
op|']'
op|'['
number|'2'
op|':'
op|']'
op|'.'
name|'lstrip'
op|'('
op|')'
op|'.'
name|'split'
op|'('
string|"':'"
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'getrevlimit'
op|'('
op|')'
name|'is'
name|'None'
op|':'
name|'r'
op|'['
number|'1'
op|']'
op|'='
name|'getrevlimit'
op|'('
op|')'
newline|'\n'
name|'if'
name|'writedump'
op|'('
name|'url'
op|','
name|'r'
op|'['
number|'0'
op|']'
op|','
name|'r'
op|'['
number|'1'
op|']'
op|')'
op|':'
name|'ret'
op|'='
number|'0'
newline|'\n'
name|'else'
op|':'
name|'ret'
op|'='
number|'1'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
name|'ret'
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit
