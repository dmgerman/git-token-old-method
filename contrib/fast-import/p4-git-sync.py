begin_unit
comment|'#!/usr/bin/env python'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# p4-git-sync.py'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Author: Simon Hausmann <hausmann@kde.org>'
nl|'\n'
comment|'# Copyright: 2007 Simon Hausmann <hausmann@kde.org>'
nl|'\n'
comment|'#            2007 Trolltech ASA'
nl|'\n'
comment|'# License: MIT <http://www.opensource.org/licenses/mit-license.php>'
nl|'\n'
comment|'#'
nl|'\n'
nl|'\n'
name|'import'
name|'os'
op|','
name|'string'
op|','
name|'shelve'
op|','
name|'stat'
newline|'\n'
name|'import'
name|'getopt'
op|','
name|'sys'
op|','
name|'marshal'
op|','
name|'tempfile'
newline|'\n'
nl|'\n'
DECL|function|p4CmdList
name|'def'
name|'p4CmdList'
op|'('
name|'cmd'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'cmd'
op|'='
string|'"p4 -G %s"'
op|'%'
name|'cmd'
newline|'\n'
name|'pipe'
op|'='
name|'os'
op|'.'
name|'popen'
op|'('
name|'cmd'
op|','
string|'"rb"'
op|')'
newline|'\n'
nl|'\n'
name|'result'
op|'='
op|'['
op|']'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'while'
name|'True'
op|':'
newline|'\n'
indent|'            '
name|'entry'
op|'='
name|'marshal'
op|'.'
name|'load'
op|'('
name|'pipe'
op|')'
newline|'\n'
name|'result'
op|'.'
name|'append'
op|'('
name|'entry'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'EOFError'
op|':'
newline|'\n'
indent|'        '
name|'pass'
newline|'\n'
dedent|''
name|'pipe'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'return'
name|'result'
newline|'\n'
nl|'\n'
DECL|function|p4Cmd
dedent|''
name|'def'
name|'p4Cmd'
op|'('
name|'cmd'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'list'
op|'='
name|'p4CmdList'
op|'('
name|'cmd'
op|')'
newline|'\n'
name|'result'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'entry'
name|'in'
name|'list'
op|':'
newline|'\n'
indent|'        '
name|'result'
op|'.'
name|'update'
op|'('
name|'entry'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'result'
op|';'
newline|'\n'
nl|'\n'
DECL|function|die
dedent|''
name|'def'
name|'die'
op|'('
name|'msg'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'sys'
op|'.'
name|'stderr'
op|'.'
name|'write'
op|'('
name|'msg'
op|'+'
string|'"\\n"'
op|')'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
number|'1'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'    '
name|'opts'
op|','
name|'args'
op|'='
name|'getopt'
op|'.'
name|'getopt'
op|'('
name|'sys'
op|'.'
name|'argv'
op|'['
number|'1'
op|':'
op|']'
op|','
string|'""'
op|','
op|'['
string|'"continue"'
op|','
string|'"git-dir="'
op|','
string|'"origin="'
op|','
string|'"reset"'
op|','
string|'"master="'
op|','
nl|'\n'
string|'"submit-log-subst="'
op|','
string|'"log-substitutions="'
op|','
string|'"noninteractive"'
op|','
nl|'\n'
string|'"dry-run"'
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'getopt'
op|'.'
name|'GetoptError'
op|':'
newline|'\n'
indent|'    '
name|'print'
string|'"fixme, syntax error"'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|logSubstitutions
dedent|''
name|'logSubstitutions'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'logSubstitutions'
op|'['
string|'"<enter description here>"'
op|']'
op|'='
string|'"%log%"'
newline|'\n'
name|'logSubstitutions'
op|'['
string|'"\\tDetails:"'
op|']'
op|'='
string|'"\\tDetails:  %log%"'
newline|'\n'
DECL|variable|gitdir
name|'gitdir'
op|'='
name|'os'
op|'.'
name|'environ'
op|'.'
name|'get'
op|'('
string|'"GIT_DIR"'
op|','
string|'""'
op|')'
newline|'\n'
DECL|variable|origin
name|'origin'
op|'='
string|'"origin"'
newline|'\n'
DECL|variable|master
name|'master'
op|'='
string|'""'
newline|'\n'
DECL|variable|firstTime
name|'firstTime'
op|'='
name|'True'
newline|'\n'
DECL|variable|reset
name|'reset'
op|'='
name|'False'
newline|'\n'
DECL|variable|interactive
name|'interactive'
op|'='
name|'True'
newline|'\n'
DECL|variable|dryRun
name|'dryRun'
op|'='
name|'False'
newline|'\n'
nl|'\n'
name|'for'
name|'o'
op|','
name|'a'
name|'in'
name|'opts'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'o'
op|'=='
string|'"--git-dir"'
op|':'
newline|'\n'
indent|'        '
name|'gitdir'
op|'='
name|'a'
newline|'\n'
dedent|''
name|'elif'
name|'o'
op|'=='
string|'"--origin"'
op|':'
newline|'\n'
indent|'        '
name|'origin'
op|'='
name|'a'
newline|'\n'
dedent|''
name|'elif'
name|'o'
op|'=='
string|'"--master"'
op|':'
newline|'\n'
indent|'        '
name|'master'
op|'='
name|'a'
newline|'\n'
dedent|''
name|'elif'
name|'o'
op|'=='
string|'"--continue"'
op|':'
newline|'\n'
indent|'        '
name|'firstTime'
op|'='
name|'False'
newline|'\n'
dedent|''
name|'elif'
name|'o'
op|'=='
string|'"--reset"'
op|':'
newline|'\n'
indent|'        '
name|'reset'
op|'='
name|'True'
newline|'\n'
name|'firstTime'
op|'='
name|'True'
newline|'\n'
dedent|''
name|'elif'
name|'o'
op|'=='
string|'"--submit-log-subst"'
op|':'
newline|'\n'
indent|'        '
name|'key'
op|'='
name|'a'
op|'.'
name|'split'
op|'('
string|'"%"'
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'value'
op|'='
name|'a'
op|'.'
name|'split'
op|'('
string|'"%"'
op|')'
op|'['
number|'1'
op|']'
newline|'\n'
name|'logSubstitutions'
op|'['
name|'key'
op|']'
op|'='
name|'value'
newline|'\n'
dedent|''
name|'elif'
name|'o'
op|'=='
string|'"--log-substitutions"'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'line'
name|'in'
name|'open'
op|'('
name|'a'
op|','
string|'"r"'
op|')'
op|'.'
name|'readlines'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'tokens'
op|'='
name|'line'
op|'['
op|':'
op|'-'
number|'1'
op|']'
op|'.'
name|'split'
op|'('
string|'"="'
op|')'
newline|'\n'
name|'logSubstitutions'
op|'['
name|'tokens'
op|'['
number|'0'
op|']'
op|']'
op|'='
name|'tokens'
op|'['
number|'1'
op|']'
newline|'\n'
dedent|''
dedent|''
name|'elif'
name|'o'
op|'=='
string|'"--noninteractive"'
op|':'
newline|'\n'
indent|'        '
name|'interactive'
op|'='
name|'False'
newline|'\n'
dedent|''
name|'elif'
name|'o'
op|'=='
string|'"--dry-run"'
op|':'
newline|'\n'
indent|'        '
name|'dryRun'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'len'
op|'('
name|'gitdir'
op|')'
op|'=='
number|'0'
op|':'
newline|'\n'
DECL|variable|gitdir
indent|'    '
name|'gitdir'
op|'='
string|'".git"'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'    '
name|'os'
op|'.'
name|'environ'
op|'['
string|'"GIT_DIR"'
op|']'
op|'='
name|'gitdir'
newline|'\n'
nl|'\n'
DECL|variable|configFile
dedent|''
name|'configFile'
op|'='
name|'gitdir'
op|'+'
string|'"/p4-git-sync.cfg"'
newline|'\n'
nl|'\n'
DECL|variable|origin
name|'origin'
op|'='
string|'"origin"'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'args'
op|')'
op|'=='
number|'1'
op|':'
newline|'\n'
DECL|variable|origin
indent|'    '
name|'origin'
op|'='
name|'args'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'master'
op|')'
op|'=='
number|'0'
op|':'
newline|'\n'
indent|'    '
name|'sys'
op|'.'
name|'stdout'
op|'.'
name|'write'
op|'('
string|'"Auto-detecting current branch: "'
op|')'
newline|'\n'
DECL|variable|master
name|'master'
op|'='
name|'os'
op|'.'
name|'popen'
op|'('
string|'"git-name-rev HEAD"'
op|')'
op|'.'
name|'read'
op|'('
op|')'
op|'.'
name|'split'
op|'('
string|'" "'
op|')'
op|'['
number|'1'
op|']'
op|'['
op|':'
op|'-'
number|'1'
op|']'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'master'
op|')'
op|'=='
number|'0'
name|'or'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
string|'"%s/refs/heads/%s"'
op|'%'
op|'('
name|'gitdir'
op|','
name|'master'
op|')'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'die'
op|'('
string|'"\\nFailed to detect current branch! Aborting!"'
op|')'
op|';'
newline|'\n'
dedent|''
name|'sys'
op|'.'
name|'stdout'
op|'.'
name|'write'
op|'('
string|'"%s\\n"'
op|'%'
name|'master'
op|')'
newline|'\n'
nl|'\n'
DECL|function|system
dedent|''
name|'def'
name|'system'
op|'('
name|'cmd'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'os'
op|'.'
name|'system'
op|'('
name|'cmd'
op|')'
op|'!='
number|'0'
op|':'
newline|'\n'
indent|'        '
name|'die'
op|'('
string|'"command failed: %s"'
op|'%'
name|'cmd'
op|')'
newline|'\n'
nl|'\n'
DECL|function|check
dedent|''
dedent|''
name|'def'
name|'check'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'len'
op|'('
name|'p4CmdList'
op|'('
string|'"opened ..."'
op|')'
op|')'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'        '
name|'die'
op|'('
string|'"You have files opened with perforce! Close them before starting the sync."'
op|')'
newline|'\n'
nl|'\n'
DECL|function|start
dedent|''
dedent|''
name|'def'
name|'start'
op|'('
name|'config'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'len'
op|'('
name|'config'
op|')'
op|'>'
number|'0'
name|'and'
name|'not'
name|'reset'
op|':'
newline|'\n'
indent|'        '
name|'die'
op|'('
string|'"Cannot start sync. Previous sync config found at %s"'
op|'%'
name|'configFile'
op|')'
newline|'\n'
nl|'\n'
comment|'#if len(os.popen("git-update-index --refresh").read()) > 0:'
nl|'\n'
comment|'#    die("Your working tree is not clean. Check with git status!")'
nl|'\n'
nl|'\n'
dedent|''
name|'commits'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'line'
name|'in'
name|'os'
op|'.'
name|'popen'
op|'('
string|'"git-rev-list --no-merges %s..%s"'
op|'%'
op|'('
name|'origin'
op|','
name|'master'
op|')'
op|')'
op|'.'
name|'readlines'
op|'('
op|')'
op|':'
newline|'\n'
indent|'        '
name|'commits'
op|'.'
name|'append'
op|'('
name|'line'
op|'['
op|':'
op|'-'
number|'1'
op|']'
op|')'
newline|'\n'
dedent|''
name|'commits'
op|'.'
name|'reverse'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'config'
op|'['
string|'"commits"'
op|']'
op|'='
name|'commits'
newline|'\n'
nl|'\n'
name|'print'
string|'"Creating temporary p4-sync branch from %s ..."'
op|'%'
name|'origin'
newline|'\n'
name|'system'
op|'('
string|'"git checkout -f -b p4-sync %s"'
op|'%'
name|'origin'
op|')'
newline|'\n'
nl|'\n'
comment|'#    print "Cleaning index..."'
nl|'\n'
comment|'#    system("git checkout -f")'
nl|'\n'
nl|'\n'
DECL|function|prepareLogMessage
dedent|''
name|'def'
name|'prepareLogMessage'
op|'('
name|'template'
op|','
name|'message'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'result'
op|'='
string|'""'
newline|'\n'
nl|'\n'
name|'for'
name|'line'
name|'in'
name|'template'
op|'.'
name|'split'
op|'('
string|'"\\n"'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'line'
op|'.'
name|'startswith'
op|'('
string|'"#"'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'result'
op|'+='
name|'line'
op|'+'
string|'"\\n"'
newline|'\n'
name|'continue'
newline|'\n'
nl|'\n'
dedent|''
name|'substituted'
op|'='
name|'False'
newline|'\n'
name|'for'
name|'key'
name|'in'
name|'logSubstitutions'
op|'.'
name|'keys'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'line'
op|'.'
name|'find'
op|'('
name|'key'
op|')'
op|'!='
op|'-'
number|'1'
op|':'
newline|'\n'
indent|'                '
name|'value'
op|'='
name|'logSubstitutions'
op|'['
name|'key'
op|']'
newline|'\n'
name|'value'
op|'='
name|'value'
op|'.'
name|'replace'
op|'('
string|'"%log%"'
op|','
name|'message'
op|')'
newline|'\n'
name|'if'
name|'value'
op|'!='
string|'"@remove@"'
op|':'
newline|'\n'
indent|'                    '
name|'result'
op|'+='
name|'line'
op|'.'
name|'replace'
op|'('
name|'key'
op|','
name|'value'
op|')'
op|'+'
string|'"\\n"'
newline|'\n'
dedent|''
name|'substituted'
op|'='
name|'True'
newline|'\n'
name|'break'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'not'
name|'substituted'
op|':'
newline|'\n'
indent|'            '
name|'result'
op|'+='
name|'line'
op|'+'
string|'"\\n"'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'return'
name|'result'
newline|'\n'
nl|'\n'
DECL|function|apply
dedent|''
name|'def'
name|'apply'
op|'('
name|'id'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'global'
name|'interactive'
newline|'\n'
name|'print'
string|'"Applying %s"'
op|'%'
op|'('
name|'os'
op|'.'
name|'popen'
op|'('
string|'"git-log --max-count=1 --pretty=oneline %s"'
op|'%'
name|'id'
op|')'
op|'.'
name|'read'
op|'('
op|')'
op|')'
newline|'\n'
name|'diff'
op|'='
name|'os'
op|'.'
name|'popen'
op|'('
string|'"git diff-tree -r --name-status \\"%s^\\" \\"%s\\""'
op|'%'
op|'('
name|'id'
op|','
name|'id'
op|')'
op|')'
op|'.'
name|'readlines'
op|'('
op|')'
newline|'\n'
name|'filesToAdd'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'filesToDelete'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'line'
name|'in'
name|'diff'
op|':'
newline|'\n'
indent|'        '
name|'modifier'
op|'='
name|'line'
op|'['
number|'0'
op|']'
newline|'\n'
name|'path'
op|'='
name|'line'
op|'['
number|'1'
op|':'
op|']'
op|'.'
name|'strip'
op|'('
op|')'
newline|'\n'
name|'if'
name|'modifier'
op|'=='
string|'"M"'
op|':'
newline|'\n'
indent|'            '
name|'system'
op|'('
string|'"p4 edit %s"'
op|'%'
name|'path'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'modifier'
op|'=='
string|'"A"'
op|':'
newline|'\n'
indent|'            '
name|'filesToAdd'
op|'.'
name|'add'
op|'('
name|'path'
op|')'
newline|'\n'
name|'if'
name|'path'
name|'in'
name|'filesToDelete'
op|':'
newline|'\n'
indent|'                '
name|'filesToDelete'
op|'.'
name|'remove'
op|'('
name|'path'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'elif'
name|'modifier'
op|'=='
string|'"D"'
op|':'
newline|'\n'
indent|'            '
name|'filesToDelete'
op|'.'
name|'add'
op|'('
name|'path'
op|')'
newline|'\n'
name|'if'
name|'path'
name|'in'
name|'filesToAdd'
op|':'
newline|'\n'
indent|'                '
name|'filesToAdd'
op|'.'
name|'remove'
op|'('
name|'path'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'die'
op|'('
string|'"unknown modifier %s for %s"'
op|'%'
op|'('
name|'modifier'
op|','
name|'path'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'system'
op|'('
string|'"git-diff-files --name-only -z | git-update-index --remove -z --stdin"'
op|')'
newline|'\n'
name|'system'
op|'('
string|'"git cherry-pick --no-commit \\"%s\\""'
op|'%'
name|'id'
op|')'
newline|'\n'
comment|'#system("git format-patch --stdout -k \\"%s^\\"..\\"%s\\" | git-am -k" % (id, id))'
nl|'\n'
comment|'#system("git branch -D tmp")'
nl|'\n'
comment|'#system("git checkout -f -b tmp \\"%s^\\"" % id)'
nl|'\n'
nl|'\n'
name|'for'
name|'f'
name|'in'
name|'filesToAdd'
op|':'
newline|'\n'
indent|'        '
name|'system'
op|'('
string|'"p4 add %s"'
op|'%'
name|'f'
op|')'
newline|'\n'
dedent|''
name|'for'
name|'f'
name|'in'
name|'filesToDelete'
op|':'
newline|'\n'
indent|'        '
name|'system'
op|'('
string|'"p4 revert %s"'
op|'%'
name|'f'
op|')'
newline|'\n'
name|'system'
op|'('
string|'"p4 delete %s"'
op|'%'
name|'f'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'logMessage'
op|'='
string|'""'
newline|'\n'
name|'foundTitle'
op|'='
name|'False'
newline|'\n'
name|'for'
name|'log'
name|'in'
name|'os'
op|'.'
name|'popen'
op|'('
string|'"git-cat-file commit %s"'
op|'%'
name|'id'
op|')'
op|'.'
name|'readlines'
op|'('
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'foundTitle'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'len'
op|'('
name|'log'
op|')'
op|'=='
number|'1'
op|':'
newline|'\n'
indent|'                '
name|'foundTitle'
op|'='
number|'1'
newline|'\n'
dedent|''
name|'continue'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'logMessage'
op|')'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'logMessage'
op|'+='
string|'"\\t"'
newline|'\n'
dedent|''
name|'logMessage'
op|'+='
name|'log'
newline|'\n'
nl|'\n'
dedent|''
name|'template'
op|'='
name|'os'
op|'.'
name|'popen'
op|'('
string|'"p4 change -o"'
op|')'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'interactive'
op|':'
newline|'\n'
indent|'        '
name|'submitTemplate'
op|'='
name|'prepareLogMessage'
op|'('
name|'template'
op|','
name|'logMessage'
op|')'
newline|'\n'
name|'diff'
op|'='
name|'os'
op|'.'
name|'popen'
op|'('
string|'"p4 diff -du ..."'
op|')'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'newFile'
name|'in'
name|'filesToAdd'
op|':'
newline|'\n'
indent|'            '
name|'diff'
op|'+='
string|'"==== new file ====\\n"'
newline|'\n'
name|'diff'
op|'+='
string|'"--- /dev/null\\n"'
newline|'\n'
name|'diff'
op|'+='
string|'"+++ %s\\n"'
op|'%'
name|'newFile'
newline|'\n'
name|'f'
op|'='
name|'open'
op|'('
name|'newFile'
op|','
string|'"r"'
op|')'
newline|'\n'
name|'for'
name|'line'
name|'in'
name|'f'
op|'.'
name|'readlines'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'diff'
op|'+='
string|'"+"'
op|'+'
name|'line'
newline|'\n'
dedent|''
name|'f'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'pipe'
op|'='
name|'os'
op|'.'
name|'popen'
op|'('
string|'"less"'
op|','
string|'"w"'
op|')'
newline|'\n'
name|'pipe'
op|'.'
name|'write'
op|'('
name|'submitTemplate'
op|'+'
name|'diff'
op|')'
newline|'\n'
name|'pipe'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'response'
op|'='
string|'"e"'
newline|'\n'
name|'while'
name|'response'
op|'=='
string|'"e"'
op|':'
newline|'\n'
indent|'            '
name|'response'
op|'='
name|'raw_input'
op|'('
string|'"Do you want to submit this change (y/e/n)? "'
op|')'
newline|'\n'
name|'if'
name|'response'
op|'=='
string|'"e"'
op|':'
newline|'\n'
indent|'                '
op|'['
name|'handle'
op|','
name|'fileName'
op|']'
op|'='
name|'tempfile'
op|'.'
name|'mkstemp'
op|'('
op|')'
newline|'\n'
name|'tmpFile'
op|'='
name|'os'
op|'.'
name|'fdopen'
op|'('
name|'handle'
op|','
string|'"w+"'
op|')'
newline|'\n'
name|'tmpFile'
op|'.'
name|'write'
op|'('
name|'submitTemplate'
op|')'
newline|'\n'
name|'tmpFile'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'editor'
op|'='
name|'os'
op|'.'
name|'environ'
op|'.'
name|'get'
op|'('
string|'"EDITOR"'
op|','
string|'"vi"'
op|')'
newline|'\n'
name|'system'
op|'('
name|'editor'
op|'+'
string|'" "'
op|'+'
name|'fileName'
op|')'
newline|'\n'
name|'tmpFile'
op|'='
name|'open'
op|'('
name|'fileName'
op|','
string|'"r"'
op|')'
newline|'\n'
name|'submitTemplate'
op|'='
name|'tmpFile'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'tmpFile'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'os'
op|'.'
name|'remove'
op|'('
name|'fileName'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'response'
op|'=='
string|'"y"'
name|'or'
name|'response'
op|'=='
string|'"yes"'
op|':'
newline|'\n'
indent|'           '
name|'if'
name|'dryRun'
op|':'
newline|'\n'
indent|'               '
name|'print'
name|'submitTemplate'
newline|'\n'
name|'raw_input'
op|'('
string|'"Press return to continue..."'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'pipe'
op|'='
name|'os'
op|'.'
name|'popen'
op|'('
string|'"p4 submit -i"'
op|','
string|'"w"'
op|')'
newline|'\n'
name|'pipe'
op|'.'
name|'write'
op|'('
name|'submitTemplate'
op|')'
newline|'\n'
name|'pipe'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'print'
string|'"Not submitting!"'
newline|'\n'
name|'interactive'
op|'='
name|'False'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'fileName'
op|'='
string|'"submit.txt"'
newline|'\n'
name|'file'
op|'='
name|'open'
op|'('
name|'fileName'
op|','
string|'"w+"'
op|')'
newline|'\n'
name|'file'
op|'.'
name|'write'
op|'('
name|'prepareLogMessage'
op|'('
name|'template'
op|','
name|'logMessage'
op|')'
op|')'
newline|'\n'
name|'file'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'print'
string|'"Perforce submit template written as %s. Please review/edit and then use p4 submit -i < %s to submit directly!"'
op|'%'
op|'('
name|'fileName'
op|','
name|'fileName'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'check'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|variable|config
name|'config'
op|'='
name|'shelve'
op|'.'
name|'open'
op|'('
name|'configFile'
op|','
name|'writeback'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'firstTime'
op|':'
newline|'\n'
indent|'    '
name|'start'
op|'('
name|'config'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|commits
dedent|''
name|'commits'
op|'='
name|'config'
op|'.'
name|'get'
op|'('
string|'"commits"'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'while'
name|'len'
op|'('
name|'commits'
op|')'
op|'>'
number|'0'
op|':'
newline|'\n'
DECL|variable|firstTime
indent|'    '
name|'firstTime'
op|'='
name|'False'
newline|'\n'
DECL|variable|commit
name|'commit'
op|'='
name|'commits'
op|'['
number|'0'
op|']'
newline|'\n'
DECL|variable|commits
name|'commits'
op|'='
name|'commits'
op|'['
number|'1'
op|':'
op|']'
newline|'\n'
name|'config'
op|'['
string|'"commits"'
op|']'
op|'='
name|'commits'
newline|'\n'
name|'apply'
op|'('
name|'commit'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'interactive'
op|':'
newline|'\n'
indent|'        '
name|'break'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'config'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'commits'
op|')'
op|'=='
number|'0'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'firstTime'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|'"No changes found to apply between %s and current HEAD"'
op|'%'
name|'origin'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|'"All changes applied!"'
newline|'\n'
name|'print'
string|'"Deleting temporary p4-sync branch and going back to %s"'
op|'%'
name|'master'
newline|'\n'
name|'system'
op|'('
string|'"git checkout %s"'
op|'%'
name|'master'
op|')'
newline|'\n'
name|'system'
op|'('
string|'"git branch -D p4-sync"'
op|')'
newline|'\n'
name|'print'
string|'"Cleaning out your perforce checkout by doing p4 edit ... ; p4 revert ..."'
newline|'\n'
name|'system'
op|'('
string|'"p4 edit ... >/dev/null"'
op|')'
newline|'\n'
name|'system'
op|'('
string|'"p4 revert ... >/dev/null"'
op|')'
newline|'\n'
dedent|''
name|'os'
op|'.'
name|'remove'
op|'('
name|'configFile'
op|')'
newline|'\n'
nl|'\n'
dedent|''
endmarker|''
end_unit
