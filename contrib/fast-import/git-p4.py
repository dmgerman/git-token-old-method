begin_unit
comment|'#!/usr/bin/env python'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# git-p4.py -- A tool for bidirectional operation between a Perforce depot and git.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Author: Simon Hausmann <hausmann@kde.org>'
nl|'\n'
comment|'# License: MIT <http://www.opensource.org/licenses/mit-license.php>'
nl|'\n'
comment|'#'
nl|'\n'
nl|'\n'
name|'import'
name|'optparse'
op|','
name|'sys'
op|','
name|'os'
op|','
name|'marshal'
op|','
name|'popen2'
newline|'\n'
nl|'\n'
DECL|function|p4CmdList
name|'def'
name|'p4CmdList'
op|'('
name|'cmd'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'cmd'
op|'='
string|'"p4 -G %s"'
op|'%'
name|'cmd'
newline|'\n'
name|'pipe'
op|'='
name|'os'
op|'.'
name|'popen'
op|'('
name|'cmd'
op|','
string|'"rb"'
op|')'
newline|'\n'
nl|'\n'
name|'result'
op|'='
op|'['
op|']'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'while'
name|'True'
op|':'
newline|'\n'
indent|'            '
name|'entry'
op|'='
name|'marshal'
op|'.'
name|'load'
op|'('
name|'pipe'
op|')'
newline|'\n'
name|'result'
op|'.'
name|'append'
op|'('
name|'entry'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'EOFError'
op|':'
newline|'\n'
indent|'        '
name|'pass'
newline|'\n'
dedent|''
name|'pipe'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'return'
name|'result'
newline|'\n'
nl|'\n'
DECL|function|p4Cmd
dedent|''
name|'def'
name|'p4Cmd'
op|'('
name|'cmd'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'list'
op|'='
name|'p4CmdList'
op|'('
name|'cmd'
op|')'
newline|'\n'
name|'result'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'entry'
name|'in'
name|'list'
op|':'
newline|'\n'
indent|'        '
name|'result'
op|'.'
name|'update'
op|'('
name|'entry'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'result'
op|';'
newline|'\n'
nl|'\n'
DECL|function|die
dedent|''
name|'def'
name|'die'
op|'('
name|'msg'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'sys'
op|'.'
name|'stderr'
op|'.'
name|'write'
op|'('
name|'msg'
op|'+'
string|'"\\n"'
op|')'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|function|currentGitBranch
dedent|''
name|'def'
name|'currentGitBranch'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
name|'return'
name|'os'
op|'.'
name|'popen'
op|'('
string|'"git-name-rev HEAD"'
op|')'
op|'.'
name|'read'
op|'('
op|')'
op|'.'
name|'split'
op|'('
string|'" "'
op|')'
op|'['
number|'1'
op|']'
op|'['
op|':'
op|'-'
number|'1'
op|']'
newline|'\n'
nl|'\n'
DECL|class|P4Debug
dedent|''
name|'class'
name|'P4Debug'
op|':'
newline|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'options'
op|'='
op|'['
nl|'\n'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'description'
op|'='
string|'"A tool to debug the output of p4 -G."'
newline|'\n'
nl|'\n'
DECL|member|run
dedent|''
name|'def'
name|'run'
op|'('
name|'self'
op|','
name|'args'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'output'
name|'in'
name|'p4CmdList'
op|'('
string|'" "'
op|'.'
name|'join'
op|'('
name|'args'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'print'
name|'output'
newline|'\n'
nl|'\n'
DECL|class|P4CleanTags
dedent|''
dedent|''
dedent|''
name|'class'
name|'P4CleanTags'
op|':'
newline|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'options'
op|'='
op|'['
nl|'\n'
comment|'#                optparse.make_option("--branch", dest="branch", default="refs/heads/master")'
nl|'\n'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'description'
op|'='
string|'"A tool to remove stale unused tags from incremental perforce imports."'
newline|'\n'
DECL|member|run
dedent|''
name|'def'
name|'run'
op|'('
name|'self'
op|','
name|'args'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'branch'
op|'='
name|'currentGitBranch'
op|'('
op|')'
newline|'\n'
name|'print'
string|'"Cleaning out stale p4 import tags..."'
newline|'\n'
name|'sout'
op|','
name|'sin'
op|','
name|'serr'
op|'='
name|'popen2'
op|'.'
name|'popen3'
op|'('
string|'"git-name-rev --tags `git-rev-parse %s`"'
op|'%'
name|'branch'
op|')'
newline|'\n'
name|'output'
op|'='
name|'sout'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'tagIdx'
op|'='
name|'output'
op|'.'
name|'index'
op|'('
string|'" tags/p4/"'
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'            '
name|'print'
string|'"Cannot find any p4/* tag. Nothing to do."'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
number|'0'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'caretIdx'
op|'='
name|'output'
op|'.'
name|'index'
op|'('
string|'"^"'
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'            '
name|'caretIdx'
op|'='
name|'len'
op|'('
name|'output'
op|')'
op|'-'
number|'1'
newline|'\n'
dedent|''
name|'rev'
op|'='
name|'int'
op|'('
name|'output'
op|'['
name|'tagIdx'
op|'+'
number|'9'
op|':'
name|'caretIdx'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'allTags'
op|'='
name|'os'
op|'.'
name|'popen'
op|'('
string|'"git tag -l p4/"'
op|')'
op|'.'
name|'readlines'
op|'('
op|')'
newline|'\n'
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
name|'len'
op|'('
name|'allTags'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'allTags'
op|'['
name|'i'
op|']'
op|'='
name|'int'
op|'('
name|'allTags'
op|'['
name|'i'
op|']'
op|'['
number|'3'
op|':'
op|'-'
number|'1'
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'allTags'
op|'.'
name|'sort'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'allTags'
op|'.'
name|'remove'
op|'('
name|'rev'
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'rev'
name|'in'
name|'allTags'
op|':'
newline|'\n'
indent|'            '
name|'print'
name|'os'
op|'.'
name|'popen'
op|'('
string|'"git tag -d p4/%s"'
op|'%'
name|'rev'
op|')'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'print'
string|'"%s tags removed."'
op|'%'
name|'len'
op|'('
name|'allTags'
op|')'
newline|'\n'
nl|'\n'
DECL|function|printUsage
dedent|''
dedent|''
name|'def'
name|'printUsage'
op|'('
name|'commands'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'print'
string|'"usage: %s <command> [options]"'
op|'%'
name|'sys'
op|'.'
name|'argv'
op|'['
number|'0'
op|']'
newline|'\n'
name|'print'
string|'""'
newline|'\n'
name|'print'
string|'"valid commands: %s"'
op|'%'
string|'", "'
op|'.'
name|'join'
op|'('
name|'commands'
op|')'
newline|'\n'
name|'print'
string|'""'
newline|'\n'
name|'print'
string|'"Try %s <command> --help for command specific help."'
op|'%'
name|'sys'
op|'.'
name|'argv'
op|'['
number|'0'
op|']'
newline|'\n'
name|'print'
string|'""'
newline|'\n'
nl|'\n'
DECL|variable|commands
dedent|''
name|'commands'
op|'='
op|'{'
nl|'\n'
string|'"debug"'
op|':'
name|'P4Debug'
op|'('
op|')'
op|','
nl|'\n'
string|'"clean-tags"'
op|':'
name|'P4CleanTags'
op|'('
op|')'
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'sys'
op|'.'
name|'argv'
op|'['
number|'1'
op|':'
op|']'
op|')'
op|'=='
number|'0'
op|':'
newline|'\n'
indent|'    '
name|'printUsage'
op|'('
name|'commands'
op|'.'
name|'keys'
op|'('
op|')'
op|')'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
number|'2'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|cmd
dedent|''
name|'cmd'
op|'='
string|'""'
newline|'\n'
DECL|variable|cmdName
name|'cmdName'
op|'='
name|'sys'
op|'.'
name|'argv'
op|'['
number|'1'
op|']'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'    '
name|'cmd'
op|'='
name|'commands'
op|'['
name|'cmdName'
op|']'
newline|'\n'
dedent|''
name|'except'
name|'KeyError'
op|':'
newline|'\n'
indent|'    '
name|'print'
string|'"unknown command %s"'
op|'%'
name|'cmdName'
newline|'\n'
name|'print'
string|'""'
newline|'\n'
name|'printUsage'
op|'('
name|'commands'
op|'.'
name|'keys'
op|'('
op|')'
op|')'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
number|'2'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|parser
dedent|''
name|'parser'
op|'='
name|'optparse'
op|'.'
name|'OptionParser'
op|'('
string|'"usage: %prog "'
op|'+'
name|'cmdName'
op|'+'
string|'" [options]"'
op|','
name|'cmd'
op|'.'
name|'options'
op|','
nl|'\n'
DECL|variable|description
name|'description'
op|'='
name|'cmd'
op|'.'
name|'description'
op|')'
newline|'\n'
nl|'\n'
op|'('
name|'cmd'
op|','
name|'args'
op|')'
op|'='
name|'parser'
op|'.'
name|'parse_args'
op|'('
name|'sys'
op|'.'
name|'argv'
op|'['
number|'2'
op|':'
op|']'
op|','
name|'cmd'
op|')'
op|';'
newline|'\n'
nl|'\n'
name|'cmd'
op|'.'
name|'run'
op|'('
name|'args'
op|')'
newline|'\n'
endmarker|''
end_unit
