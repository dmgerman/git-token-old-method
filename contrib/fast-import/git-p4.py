begin_unit
comment|'#!/usr/bin/env python'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# git-p4.py -- A tool for bidirectional operation between a Perforce depot and git.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Author: Simon Hausmann <hausmann@kde.org>'
nl|'\n'
comment|'# License: MIT <http://www.opensource.org/licenses/mit-license.php>'
nl|'\n'
comment|'#'
nl|'\n'
nl|'\n'
name|'import'
name|'optparse'
op|','
name|'sys'
op|','
name|'os'
op|','
name|'marshal'
op|','
name|'popen2'
op|','
name|'shelve'
newline|'\n'
name|'import'
name|'tempfile'
newline|'\n'
nl|'\n'
DECL|variable|gitdir
name|'gitdir'
op|'='
name|'os'
op|'.'
name|'environ'
op|'.'
name|'get'
op|'('
string|'"GIT_DIR"'
op|','
string|'""'
op|')'
newline|'\n'
nl|'\n'
DECL|function|p4CmdList
name|'def'
name|'p4CmdList'
op|'('
name|'cmd'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'cmd'
op|'='
string|'"p4 -G %s"'
op|'%'
name|'cmd'
newline|'\n'
name|'pipe'
op|'='
name|'os'
op|'.'
name|'popen'
op|'('
name|'cmd'
op|','
string|'"rb"'
op|')'
newline|'\n'
nl|'\n'
name|'result'
op|'='
op|'['
op|']'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'while'
name|'True'
op|':'
newline|'\n'
indent|'            '
name|'entry'
op|'='
name|'marshal'
op|'.'
name|'load'
op|'('
name|'pipe'
op|')'
newline|'\n'
name|'result'
op|'.'
name|'append'
op|'('
name|'entry'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'EOFError'
op|':'
newline|'\n'
indent|'        '
name|'pass'
newline|'\n'
dedent|''
name|'pipe'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'return'
name|'result'
newline|'\n'
nl|'\n'
DECL|function|p4Cmd
dedent|''
name|'def'
name|'p4Cmd'
op|'('
name|'cmd'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'list'
op|'='
name|'p4CmdList'
op|'('
name|'cmd'
op|')'
newline|'\n'
name|'result'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'entry'
name|'in'
name|'list'
op|':'
newline|'\n'
indent|'        '
name|'result'
op|'.'
name|'update'
op|'('
name|'entry'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'result'
op|';'
newline|'\n'
nl|'\n'
DECL|function|die
dedent|''
name|'def'
name|'die'
op|'('
name|'msg'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'sys'
op|'.'
name|'stderr'
op|'.'
name|'write'
op|'('
name|'msg'
op|'+'
string|'"\\n"'
op|')'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|function|currentGitBranch
dedent|''
name|'def'
name|'currentGitBranch'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
name|'return'
name|'os'
op|'.'
name|'popen'
op|'('
string|'"git-name-rev HEAD"'
op|')'
op|'.'
name|'read'
op|'('
op|')'
op|'.'
name|'split'
op|'('
string|'" "'
op|')'
op|'['
number|'1'
op|']'
op|'['
op|':'
op|'-'
number|'1'
op|']'
newline|'\n'
nl|'\n'
DECL|function|isValidGitDir
dedent|''
name|'def'
name|'isValidGitDir'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'path'
op|'+'
string|'"/HEAD"'
op|')'
name|'and'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'path'
op|'+'
string|'"/refs"'
op|')'
name|'and'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'path'
op|'+'
string|'"/objects"'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'True'
op|';'
newline|'\n'
dedent|''
name|'return'
name|'False'
newline|'\n'
nl|'\n'
DECL|function|system
dedent|''
name|'def'
name|'system'
op|'('
name|'cmd'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'os'
op|'.'
name|'system'
op|'('
name|'cmd'
op|')'
op|'!='
number|'0'
op|':'
newline|'\n'
indent|'        '
name|'die'
op|'('
string|'"command failed: %s"'
op|'%'
name|'cmd'
op|')'
newline|'\n'
nl|'\n'
DECL|class|P4Debug
dedent|''
dedent|''
name|'class'
name|'P4Debug'
op|':'
newline|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'options'
op|'='
op|'['
nl|'\n'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'description'
op|'='
string|'"A tool to debug the output of p4 -G."'
newline|'\n'
nl|'\n'
DECL|member|run
dedent|''
name|'def'
name|'run'
op|'('
name|'self'
op|','
name|'args'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'output'
name|'in'
name|'p4CmdList'
op|'('
string|'" "'
op|'.'
name|'join'
op|'('
name|'args'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'print'
name|'output'
newline|'\n'
nl|'\n'
DECL|class|P4CleanTags
dedent|''
dedent|''
dedent|''
name|'class'
name|'P4CleanTags'
op|':'
newline|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'options'
op|'='
op|'['
nl|'\n'
comment|'#                optparse.make_option("--branch", dest="branch", default="refs/heads/master")'
nl|'\n'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'description'
op|'='
string|'"A tool to remove stale unused tags from incremental perforce imports."'
newline|'\n'
DECL|member|run
dedent|''
name|'def'
name|'run'
op|'('
name|'self'
op|','
name|'args'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'branch'
op|'='
name|'currentGitBranch'
op|'('
op|')'
newline|'\n'
name|'print'
string|'"Cleaning out stale p4 import tags..."'
newline|'\n'
name|'sout'
op|','
name|'sin'
op|','
name|'serr'
op|'='
name|'popen2'
op|'.'
name|'popen3'
op|'('
string|'"git-name-rev --tags `git-rev-parse %s`"'
op|'%'
name|'branch'
op|')'
newline|'\n'
name|'output'
op|'='
name|'sout'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'tagIdx'
op|'='
name|'output'
op|'.'
name|'index'
op|'('
string|'" tags/p4/"'
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'            '
name|'print'
string|'"Cannot find any p4/* tag. Nothing to do."'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
number|'0'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'caretIdx'
op|'='
name|'output'
op|'.'
name|'index'
op|'('
string|'"^"'
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'            '
name|'caretIdx'
op|'='
name|'len'
op|'('
name|'output'
op|')'
op|'-'
number|'1'
newline|'\n'
dedent|''
name|'rev'
op|'='
name|'int'
op|'('
name|'output'
op|'['
name|'tagIdx'
op|'+'
number|'9'
op|':'
name|'caretIdx'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'allTags'
op|'='
name|'os'
op|'.'
name|'popen'
op|'('
string|'"git tag -l p4/"'
op|')'
op|'.'
name|'readlines'
op|'('
op|')'
newline|'\n'
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
name|'len'
op|'('
name|'allTags'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'allTags'
op|'['
name|'i'
op|']'
op|'='
name|'int'
op|'('
name|'allTags'
op|'['
name|'i'
op|']'
op|'['
number|'3'
op|':'
op|'-'
number|'1'
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'allTags'
op|'.'
name|'sort'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'allTags'
op|'.'
name|'remove'
op|'('
name|'rev'
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'rev'
name|'in'
name|'allTags'
op|':'
newline|'\n'
indent|'            '
name|'print'
name|'os'
op|'.'
name|'popen'
op|'('
string|'"git tag -d p4/%s"'
op|'%'
name|'rev'
op|')'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'print'
string|'"%s tags removed."'
op|'%'
name|'len'
op|'('
name|'allTags'
op|')'
newline|'\n'
nl|'\n'
DECL|class|P4Sync
dedent|''
dedent|''
name|'class'
name|'P4Sync'
op|':'
newline|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'options'
op|'='
op|'['
nl|'\n'
name|'optparse'
op|'.'
name|'make_option'
op|'('
string|'"--continue"'
op|','
name|'action'
op|'='
string|'"store_false"'
op|','
name|'dest'
op|'='
string|'"firstTime"'
op|')'
op|','
nl|'\n'
name|'optparse'
op|'.'
name|'make_option'
op|'('
string|'"--origin"'
op|','
name|'dest'
op|'='
string|'"origin"'
op|')'
op|','
nl|'\n'
name|'optparse'
op|'.'
name|'make_option'
op|'('
string|'"--reset"'
op|','
name|'action'
op|'='
string|'"store_true"'
op|','
name|'dest'
op|'='
string|'"reset"'
op|')'
op|','
nl|'\n'
name|'optparse'
op|'.'
name|'make_option'
op|'('
string|'"--master"'
op|','
name|'dest'
op|'='
string|'"master"'
op|')'
op|','
nl|'\n'
name|'optparse'
op|'.'
name|'make_option'
op|'('
string|'"--log-substitutions"'
op|','
name|'dest'
op|'='
string|'"substFile"'
op|')'
op|','
nl|'\n'
name|'optparse'
op|'.'
name|'make_option'
op|'('
string|'"--noninteractive"'
op|','
name|'action'
op|'='
string|'"store_false"'
op|')'
op|','
nl|'\n'
name|'optparse'
op|'.'
name|'make_option'
op|'('
string|'"--dry-run"'
op|','
name|'action'
op|'='
string|'"store_true"'
op|')'
nl|'\n'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'description'
op|'='
string|'"Submit changes from git to the perforce depot."'
newline|'\n'
name|'self'
op|'.'
name|'firstTime'
op|'='
name|'True'
newline|'\n'
name|'self'
op|'.'
name|'reset'
op|'='
name|'False'
newline|'\n'
name|'self'
op|'.'
name|'interactive'
op|'='
name|'True'
newline|'\n'
name|'self'
op|'.'
name|'dryRun'
op|'='
name|'False'
newline|'\n'
name|'self'
op|'.'
name|'substFile'
op|'='
string|'""'
newline|'\n'
name|'self'
op|'.'
name|'firstTime'
op|'='
name|'True'
newline|'\n'
name|'self'
op|'.'
name|'origin'
op|'='
string|'"origin"'
newline|'\n'
name|'self'
op|'.'
name|'master'
op|'='
string|'""'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'logSubstitutions'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'logSubstitutions'
op|'['
string|'"<enter description here>"'
op|']'
op|'='
string|'"%log%"'
newline|'\n'
name|'self'
op|'.'
name|'logSubstitutions'
op|'['
string|'"\\tDetails:"'
op|']'
op|'='
string|'"\\tDetails:  %log%"'
newline|'\n'
nl|'\n'
DECL|member|check
dedent|''
name|'def'
name|'check'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'len'
op|'('
name|'p4CmdList'
op|'('
string|'"opened ..."'
op|')'
op|')'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'die'
op|'('
string|'"You have files opened with perforce! Close them before starting the sync."'
op|')'
newline|'\n'
nl|'\n'
DECL|member|start
dedent|''
dedent|''
name|'def'
name|'start'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'len'
op|'('
name|'self'
op|'.'
name|'config'
op|')'
op|'>'
number|'0'
name|'and'
name|'not'
name|'self'
op|'.'
name|'reset'
op|':'
newline|'\n'
indent|'            '
name|'die'
op|'('
string|'"Cannot start sync. Previous sync config found at %s"'
op|'%'
name|'self'
op|'.'
name|'configFile'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'commits'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'line'
name|'in'
name|'os'
op|'.'
name|'popen'
op|'('
string|'"git-rev-list --no-merges %s..%s"'
op|'%'
op|'('
name|'self'
op|'.'
name|'origin'
op|','
name|'self'
op|'.'
name|'master'
op|')'
op|')'
op|'.'
name|'readlines'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'commits'
op|'.'
name|'append'
op|'('
name|'line'
op|'['
op|':'
op|'-'
number|'1'
op|']'
op|')'
newline|'\n'
dedent|''
name|'commits'
op|'.'
name|'reverse'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'config'
op|'['
string|'"commits"'
op|']'
op|'='
name|'commits'
newline|'\n'
nl|'\n'
name|'print'
string|'"Creating temporary p4-sync branch from %s ..."'
op|'%'
name|'self'
op|'.'
name|'origin'
newline|'\n'
name|'system'
op|'('
string|'"git checkout -f -b p4-sync %s"'
op|'%'
name|'self'
op|'.'
name|'origin'
op|')'
newline|'\n'
nl|'\n'
DECL|member|prepareLogMessage
dedent|''
name|'def'
name|'prepareLogMessage'
op|'('
name|'self'
op|','
name|'template'
op|','
name|'message'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'result'
op|'='
string|'""'
newline|'\n'
nl|'\n'
name|'for'
name|'line'
name|'in'
name|'template'
op|'.'
name|'split'
op|'('
string|'"\\n"'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'line'
op|'.'
name|'startswith'
op|'('
string|'"#"'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'result'
op|'+='
name|'line'
op|'+'
string|'"\\n"'
newline|'\n'
name|'continue'
newline|'\n'
nl|'\n'
dedent|''
name|'substituted'
op|'='
name|'False'
newline|'\n'
name|'for'
name|'key'
name|'in'
name|'self'
op|'.'
name|'logSubstitutions'
op|'.'
name|'keys'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'line'
op|'.'
name|'find'
op|'('
name|'key'
op|')'
op|'!='
op|'-'
number|'1'
op|':'
newline|'\n'
indent|'                    '
name|'value'
op|'='
name|'self'
op|'.'
name|'logSubstitutions'
op|'['
name|'key'
op|']'
newline|'\n'
name|'value'
op|'='
name|'value'
op|'.'
name|'replace'
op|'('
string|'"%log%"'
op|','
name|'message'
op|')'
newline|'\n'
name|'if'
name|'value'
op|'!='
string|'"@remove@"'
op|':'
newline|'\n'
indent|'                        '
name|'result'
op|'+='
name|'line'
op|'.'
name|'replace'
op|'('
name|'key'
op|','
name|'value'
op|')'
op|'+'
string|'"\\n"'
newline|'\n'
dedent|''
name|'substituted'
op|'='
name|'True'
newline|'\n'
name|'break'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'not'
name|'substituted'
op|':'
newline|'\n'
indent|'                '
name|'result'
op|'+='
name|'line'
op|'+'
string|'"\\n"'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'return'
name|'result'
newline|'\n'
nl|'\n'
DECL|member|apply
dedent|''
name|'def'
name|'apply'
op|'('
name|'self'
op|','
name|'id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|'"Applying %s"'
op|'%'
op|'('
name|'os'
op|'.'
name|'popen'
op|'('
string|'"git-log --max-count=1 --pretty=oneline %s"'
op|'%'
name|'id'
op|')'
op|'.'
name|'read'
op|'('
op|')'
op|')'
newline|'\n'
name|'diff'
op|'='
name|'os'
op|'.'
name|'popen'
op|'('
string|'"git diff-tree -r --name-status \\"%s^\\" \\"%s\\""'
op|'%'
op|'('
name|'id'
op|','
name|'id'
op|')'
op|')'
op|'.'
name|'readlines'
op|'('
op|')'
newline|'\n'
name|'filesToAdd'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'filesToDelete'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'line'
name|'in'
name|'diff'
op|':'
newline|'\n'
indent|'            '
name|'modifier'
op|'='
name|'line'
op|'['
number|'0'
op|']'
newline|'\n'
name|'path'
op|'='
name|'line'
op|'['
number|'1'
op|':'
op|']'
op|'.'
name|'strip'
op|'('
op|')'
newline|'\n'
name|'if'
name|'modifier'
op|'=='
string|'"M"'
op|':'
newline|'\n'
indent|'                '
name|'system'
op|'('
string|'"p4 edit %s"'
op|'%'
name|'path'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'modifier'
op|'=='
string|'"A"'
op|':'
newline|'\n'
indent|'                '
name|'filesToAdd'
op|'.'
name|'add'
op|'('
name|'path'
op|')'
newline|'\n'
name|'if'
name|'path'
name|'in'
name|'filesToDelete'
op|':'
newline|'\n'
indent|'                    '
name|'filesToDelete'
op|'.'
name|'remove'
op|'('
name|'path'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'elif'
name|'modifier'
op|'=='
string|'"D"'
op|':'
newline|'\n'
indent|'                '
name|'filesToDelete'
op|'.'
name|'add'
op|'('
name|'path'
op|')'
newline|'\n'
name|'if'
name|'path'
name|'in'
name|'filesToAdd'
op|':'
newline|'\n'
indent|'                    '
name|'filesToAdd'
op|'.'
name|'remove'
op|'('
name|'path'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'die'
op|'('
string|'"unknown modifier %s for %s"'
op|'%'
op|'('
name|'modifier'
op|','
name|'path'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'system'
op|'('
string|'"git-diff-files --name-only -z | git-update-index --remove -z --stdin"'
op|')'
newline|'\n'
name|'system'
op|'('
string|'"git cherry-pick --no-commit \\"%s\\""'
op|'%'
name|'id'
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'f'
name|'in'
name|'filesToAdd'
op|':'
newline|'\n'
indent|'            '
name|'system'
op|'('
string|'"p4 add %s"'
op|'%'
name|'f'
op|')'
newline|'\n'
dedent|''
name|'for'
name|'f'
name|'in'
name|'filesToDelete'
op|':'
newline|'\n'
indent|'            '
name|'system'
op|'('
string|'"p4 revert %s"'
op|'%'
name|'f'
op|')'
newline|'\n'
name|'system'
op|'('
string|'"p4 delete %s"'
op|'%'
name|'f'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'logMessage'
op|'='
string|'""'
newline|'\n'
name|'foundTitle'
op|'='
name|'False'
newline|'\n'
name|'for'
name|'log'
name|'in'
name|'os'
op|'.'
name|'popen'
op|'('
string|'"git-cat-file commit %s"'
op|'%'
name|'id'
op|')'
op|'.'
name|'readlines'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'foundTitle'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'len'
op|'('
name|'log'
op|')'
op|'=='
number|'1'
op|':'
newline|'\n'
indent|'                    '
name|'foundTitle'
op|'='
number|'1'
newline|'\n'
dedent|''
name|'continue'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'logMessage'
op|')'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'                '
name|'logMessage'
op|'+='
string|'"\\t"'
newline|'\n'
dedent|''
name|'logMessage'
op|'+='
name|'log'
newline|'\n'
nl|'\n'
dedent|''
name|'template'
op|'='
name|'os'
op|'.'
name|'popen'
op|'('
string|'"p4 change -o"'
op|')'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'self'
op|'.'
name|'interactive'
op|':'
newline|'\n'
indent|'            '
name|'submitTemplate'
op|'='
name|'self'
op|'.'
name|'prepareLogMessage'
op|'('
name|'template'
op|','
name|'logMessage'
op|')'
newline|'\n'
name|'diff'
op|'='
name|'os'
op|'.'
name|'popen'
op|'('
string|'"p4 diff -du ..."'
op|')'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'newFile'
name|'in'
name|'filesToAdd'
op|':'
newline|'\n'
indent|'                '
name|'diff'
op|'+='
string|'"==== new file ====\\n"'
newline|'\n'
name|'diff'
op|'+='
string|'"--- /dev/null\\n"'
newline|'\n'
name|'diff'
op|'+='
string|'"+++ %s\\n"'
op|'%'
name|'newFile'
newline|'\n'
name|'f'
op|'='
name|'open'
op|'('
name|'newFile'
op|','
string|'"r"'
op|')'
newline|'\n'
name|'for'
name|'line'
name|'in'
name|'f'
op|'.'
name|'readlines'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'diff'
op|'+='
string|'"+"'
op|'+'
name|'line'
newline|'\n'
dedent|''
name|'f'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'pipe'
op|'='
name|'os'
op|'.'
name|'popen'
op|'('
string|'"less"'
op|','
string|'"w"'
op|')'
newline|'\n'
name|'pipe'
op|'.'
name|'write'
op|'('
name|'submitTemplate'
op|'+'
name|'diff'
op|')'
newline|'\n'
name|'pipe'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'response'
op|'='
string|'"e"'
newline|'\n'
name|'while'
name|'response'
op|'=='
string|'"e"'
op|':'
newline|'\n'
indent|'                '
name|'response'
op|'='
name|'raw_input'
op|'('
string|'"Do you want to submit this change (y/e/n)? "'
op|')'
newline|'\n'
name|'if'
name|'response'
op|'=='
string|'"e"'
op|':'
newline|'\n'
indent|'                    '
op|'['
name|'handle'
op|','
name|'fileName'
op|']'
op|'='
name|'tempfile'
op|'.'
name|'mkstemp'
op|'('
op|')'
newline|'\n'
name|'tmpFile'
op|'='
name|'os'
op|'.'
name|'fdopen'
op|'('
name|'handle'
op|','
string|'"w+"'
op|')'
newline|'\n'
name|'tmpFile'
op|'.'
name|'write'
op|'('
name|'submitTemplate'
op|')'
newline|'\n'
name|'tmpFile'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'editor'
op|'='
name|'os'
op|'.'
name|'environ'
op|'.'
name|'get'
op|'('
string|'"EDITOR"'
op|','
string|'"vi"'
op|')'
newline|'\n'
name|'system'
op|'('
name|'editor'
op|'+'
string|'" "'
op|'+'
name|'fileName'
op|')'
newline|'\n'
name|'tmpFile'
op|'='
name|'open'
op|'('
name|'fileName'
op|','
string|'"r"'
op|')'
newline|'\n'
name|'submitTemplate'
op|'='
name|'tmpFile'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'tmpFile'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'os'
op|'.'
name|'remove'
op|'('
name|'fileName'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'response'
op|'=='
string|'"y"'
name|'or'
name|'response'
op|'=='
string|'"yes"'
op|':'
newline|'\n'
indent|'               '
name|'if'
name|'self'
op|'.'
name|'dryRun'
op|':'
newline|'\n'
indent|'                   '
name|'print'
name|'submitTemplate'
newline|'\n'
name|'raw_input'
op|'('
string|'"Press return to continue..."'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'pipe'
op|'='
name|'os'
op|'.'
name|'popen'
op|'('
string|'"p4 submit -i"'
op|','
string|'"w"'
op|')'
newline|'\n'
name|'pipe'
op|'.'
name|'write'
op|'('
name|'submitTemplate'
op|')'
newline|'\n'
name|'pipe'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'print'
string|'"Not submitting!"'
newline|'\n'
name|'self'
op|'.'
name|'interactive'
op|'='
name|'False'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'fileName'
op|'='
string|'"submit.txt"'
newline|'\n'
name|'file'
op|'='
name|'open'
op|'('
name|'fileName'
op|','
string|'"w+"'
op|')'
newline|'\n'
name|'file'
op|'.'
name|'write'
op|'('
name|'self'
op|'.'
name|'prepareLogMessage'
op|'('
name|'template'
op|','
name|'logMessage'
op|')'
op|')'
newline|'\n'
name|'file'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'print'
string|'"Perforce submit template written as %s. Please review/edit and then use p4 submit -i < %s to submit directly!"'
op|'%'
op|'('
name|'fileName'
op|','
name|'fileName'
op|')'
newline|'\n'
nl|'\n'
DECL|member|run
dedent|''
dedent|''
name|'def'
name|'run'
op|'('
name|'self'
op|','
name|'args'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'reset'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'firstTime'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'self'
op|'.'
name|'substFile'
op|')'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'line'
name|'in'
name|'open'
op|'('
name|'self'
op|'.'
name|'substFile'
op|','
string|'"r"'
op|')'
op|'.'
name|'readlines'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'tokens'
op|'='
name|'line'
op|'['
op|':'
op|'-'
number|'1'
op|']'
op|'.'
name|'split'
op|'('
string|'"="'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'logSubstitutions'
op|'['
name|'tokens'
op|'['
number|'0'
op|']'
op|']'
op|'='
name|'tokens'
op|'['
number|'1'
op|']'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'len'
op|'('
name|'self'
op|'.'
name|'master'
op|')'
op|'=='
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'master'
op|'='
name|'currentGitBranch'
op|'('
op|')'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'self'
op|'.'
name|'master'
op|')'
op|'=='
number|'0'
name|'or'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
string|'"%s/refs/heads/%s"'
op|'%'
op|'('
name|'gitdir'
op|','
name|'self'
op|'.'
name|'master'
op|')'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'die'
op|'('
string|'"Detecting current git branch failed!"'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'check'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'configFile'
op|'='
name|'gitdir'
op|'+'
string|'"/p4-git-sync.cfg"'
newline|'\n'
name|'self'
op|'.'
name|'config'
op|'='
name|'shelve'
op|'.'
name|'open'
op|'('
name|'self'
op|'.'
name|'configFile'
op|','
name|'writeback'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'self'
op|'.'
name|'firstTime'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'start'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'commits'
op|'='
name|'self'
op|'.'
name|'config'
op|'.'
name|'get'
op|'('
string|'"commits"'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'while'
name|'len'
op|'('
name|'commits'
op|')'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'firstTime'
op|'='
name|'False'
newline|'\n'
name|'commit'
op|'='
name|'commits'
op|'['
number|'0'
op|']'
newline|'\n'
name|'commits'
op|'='
name|'commits'
op|'['
number|'1'
op|':'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'config'
op|'['
string|'"commits"'
op|']'
op|'='
name|'commits'
newline|'\n'
name|'self'
op|'.'
name|'apply'
op|'('
name|'commit'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'self'
op|'.'
name|'interactive'
op|':'
newline|'\n'
indent|'                '
name|'break'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'config'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'commits'
op|')'
op|'=='
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'self'
op|'.'
name|'firstTime'
op|':'
newline|'\n'
indent|'                '
name|'print'
string|'"No changes found to apply between %s and current HEAD"'
op|'%'
name|'self'
op|'.'
name|'origin'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'print'
string|'"All changes applied!"'
newline|'\n'
name|'print'
string|'"Deleting temporary p4-sync branch and going back to %s"'
op|'%'
name|'self'
op|'.'
name|'master'
newline|'\n'
name|'system'
op|'('
string|'"git checkout %s"'
op|'%'
name|'self'
op|'.'
name|'master'
op|')'
newline|'\n'
name|'system'
op|'('
string|'"git branch -D p4-sync"'
op|')'
newline|'\n'
name|'print'
string|'"Cleaning out your perforce checkout by doing p4 edit ... ; p4 revert ..."'
newline|'\n'
name|'system'
op|'('
string|'"p4 edit ... >/dev/null"'
op|')'
newline|'\n'
name|'system'
op|'('
string|'"p4 revert ... >/dev/null"'
op|')'
newline|'\n'
dedent|''
name|'os'
op|'.'
name|'remove'
op|'('
name|'self'
op|'.'
name|'configFile'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|printUsage
dedent|''
dedent|''
dedent|''
name|'def'
name|'printUsage'
op|'('
name|'commands'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'print'
string|'"usage: %s <command> [options]"'
op|'%'
name|'sys'
op|'.'
name|'argv'
op|'['
number|'0'
op|']'
newline|'\n'
name|'print'
string|'""'
newline|'\n'
name|'print'
string|'"valid commands: %s"'
op|'%'
string|'", "'
op|'.'
name|'join'
op|'('
name|'commands'
op|')'
newline|'\n'
name|'print'
string|'""'
newline|'\n'
name|'print'
string|'"Try %s <command> --help for command specific help."'
op|'%'
name|'sys'
op|'.'
name|'argv'
op|'['
number|'0'
op|']'
newline|'\n'
name|'print'
string|'""'
newline|'\n'
nl|'\n'
DECL|variable|commands
dedent|''
name|'commands'
op|'='
op|'{'
nl|'\n'
string|'"debug"'
op|':'
name|'P4Debug'
op|'('
op|')'
op|','
nl|'\n'
string|'"clean-tags"'
op|':'
name|'P4CleanTags'
op|'('
op|')'
op|','
nl|'\n'
string|'"sync-to-perforce"'
op|':'
name|'P4Sync'
op|'('
op|')'
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'sys'
op|'.'
name|'argv'
op|'['
number|'1'
op|':'
op|']'
op|')'
op|'=='
number|'0'
op|':'
newline|'\n'
indent|'    '
name|'printUsage'
op|'('
name|'commands'
op|'.'
name|'keys'
op|'('
op|')'
op|')'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
number|'2'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|cmd
dedent|''
name|'cmd'
op|'='
string|'""'
newline|'\n'
DECL|variable|cmdName
name|'cmdName'
op|'='
name|'sys'
op|'.'
name|'argv'
op|'['
number|'1'
op|']'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'    '
name|'cmd'
op|'='
name|'commands'
op|'['
name|'cmdName'
op|']'
newline|'\n'
dedent|''
name|'except'
name|'KeyError'
op|':'
newline|'\n'
indent|'    '
name|'print'
string|'"unknown command %s"'
op|'%'
name|'cmdName'
newline|'\n'
name|'print'
string|'""'
newline|'\n'
name|'printUsage'
op|'('
name|'commands'
op|'.'
name|'keys'
op|'('
op|')'
op|')'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
number|'2'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|options
dedent|''
name|'options'
op|'='
name|'cmd'
op|'.'
name|'options'
newline|'\n'
name|'cmd'
op|'.'
name|'gitdir'
op|'='
name|'gitdir'
newline|'\n'
name|'options'
op|'.'
name|'append'
op|'('
name|'optparse'
op|'.'
name|'make_option'
op|'('
string|'"--git-dir"'
op|','
name|'dest'
op|'='
string|'"gitdir"'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|parser
name|'parser'
op|'='
name|'optparse'
op|'.'
name|'OptionParser'
op|'('
string|'"usage: %prog "'
op|'+'
name|'cmdName'
op|'+'
string|'" [options]"'
op|','
name|'options'
op|','
nl|'\n'
DECL|variable|description
name|'description'
op|'='
name|'cmd'
op|'.'
name|'description'
op|')'
newline|'\n'
nl|'\n'
op|'('
name|'cmd'
op|','
name|'args'
op|')'
op|'='
name|'parser'
op|'.'
name|'parse_args'
op|'('
name|'sys'
op|'.'
name|'argv'
op|'['
number|'2'
op|':'
op|']'
op|','
name|'cmd'
op|')'
op|';'
newline|'\n'
nl|'\n'
DECL|variable|gitdir
name|'gitdir'
op|'='
name|'cmd'
op|'.'
name|'gitdir'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'gitdir'
op|')'
op|'=='
number|'0'
op|':'
newline|'\n'
DECL|variable|gitdir
indent|'    '
name|'gitdir'
op|'='
string|'".git"'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'not'
name|'isValidGitDir'
op|'('
name|'gitdir'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'isValidGitDir'
op|'('
name|'gitdir'
op|'+'
string|'"/.git"'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'gitdir'
op|'+='
string|'"/.git"'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'dir'
op|'('
string|'"fatal: cannot locate git repository at %s"'
op|'%'
name|'gitdir'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'os'
op|'.'
name|'environ'
op|'['
string|'"GIT_DIR"'
op|']'
op|'='
name|'gitdir'
newline|'\n'
nl|'\n'
name|'cmd'
op|'.'
name|'run'
op|'('
name|'args'
op|')'
newline|'\n'
endmarker|''
end_unit
