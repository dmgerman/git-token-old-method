begin_unit
begin_define
DECL|macro|_POSIX_C_SOURCE
define|#
directive|define
name|_POSIX_C_SOURCE
value|200112L
end_define
begin_include
include|#
directive|include
file|<sys/stat.h>
end_include
begin_comment
comment|/* *stat, S_IS* */
end_comment
begin_include
include|#
directive|include
file|<sys/types.h>
end_include
begin_comment
comment|/* mode_t       */
end_comment
begin_function
DECL|function|mode_native_to_git
specifier|static
specifier|inline
name|mode_t
name|mode_native_to_git
parameter_list|(
name|mode_t
name|native_mode
parameter_list|)
block|{
name|mode_t
name|perm_bits
init|=
name|native_mode
operator|&
literal|07777
decl_stmt|;
if|if
condition|(
name|S_ISREG
argument_list|(
name|native_mode
argument_list|)
condition|)
return|return
literal|0100000
operator||
name|perm_bits
return|;
if|if
condition|(
name|S_ISDIR
argument_list|(
name|native_mode
argument_list|)
condition|)
return|return
literal|0040000
operator||
name|perm_bits
return|;
if|if
condition|(
name|S_ISLNK
argument_list|(
name|native_mode
argument_list|)
condition|)
return|return
literal|0120000
operator||
name|perm_bits
return|;
if|if
condition|(
name|S_ISBLK
argument_list|(
name|native_mode
argument_list|)
condition|)
return|return
literal|0060000
operator||
name|perm_bits
return|;
if|if
condition|(
name|S_ISCHR
argument_list|(
name|native_mode
argument_list|)
condition|)
return|return
literal|0020000
operator||
name|perm_bits
return|;
if|if
condition|(
name|S_ISFIFO
argument_list|(
name|native_mode
argument_list|)
condition|)
return|return
literal|0010000
operator||
name|perm_bits
return|;
if|if
condition|(
name|S_ISSOCK
argument_list|(
name|native_mode
argument_list|)
condition|)
return|return
literal|0140000
operator||
name|perm_bits
return|;
comment|/* Non-standard type bits were given. */
return|return
name|perm_bits
return|;
block|}
end_function
begin_function
DECL|function|git_stat
name|int
name|git_stat
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|struct
name|stat
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|rc
init|=
name|stat
argument_list|(
name|path
argument_list|,
name|buf
argument_list|)
decl_stmt|;
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
name|buf
operator|->
name|st_mode
operator|=
name|mode_native_to_git
argument_list|(
name|buf
operator|->
name|st_mode
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function
begin_function
DECL|function|git_fstat
name|int
name|git_fstat
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|stat
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|rc
init|=
name|fstat
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|)
decl_stmt|;
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
name|buf
operator|->
name|st_mode
operator|=
name|mode_native_to_git
argument_list|(
name|buf
operator|->
name|st_mode
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function
begin_function
DECL|function|git_lstat
name|int
name|git_lstat
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|struct
name|stat
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|rc
init|=
name|lstat
argument_list|(
name|path
argument_list|,
name|buf
argument_list|)
decl_stmt|;
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
name|buf
operator|->
name|st_mode
operator|=
name|mode_native_to_git
argument_list|(
name|buf
operator|->
name|st_mode
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function
end_unit
