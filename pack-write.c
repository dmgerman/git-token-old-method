begin_unit
begin_include
include|#
directive|include
file|"cache.h"
end_include
begin_include
include|#
directive|include
file|"pack.h"
end_include
begin_function
DECL|function|fixup_pack_header_footer
name|void
name|fixup_pack_header_footer
parameter_list|(
name|int
name|pack_fd
parameter_list|,
name|unsigned
name|char
modifier|*
name|pack_file_sha1
parameter_list|,
specifier|const
name|char
modifier|*
name|pack_name
parameter_list|,
name|uint32_t
name|object_count
parameter_list|)
block|{
specifier|static
specifier|const
name|int
name|buf_sz
init|=
literal|128
operator|*
literal|1024
decl_stmt|;
name|SHA_CTX
name|c
decl_stmt|;
name|struct
name|pack_header
name|hdr
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
if|if
condition|(
name|lseek
argument_list|(
name|pack_fd
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
name|die
argument_list|(
literal|"Failed seeking to start: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|read_in_full
argument_list|(
name|pack_fd
argument_list|,
operator|&
name|hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
condition|)
name|die
argument_list|(
literal|"Unable to reread header of %s: %s"
argument_list|,
name|pack_name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lseek
argument_list|(
name|pack_fd
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
name|die
argument_list|(
literal|"Failed seeking to start: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|hdr
operator|.
name|hdr_entries
operator|=
name|htonl
argument_list|(
name|object_count
argument_list|)
expr_stmt|;
name|write_or_die
argument_list|(
name|pack_fd
argument_list|,
operator|&
name|hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
name|SHA1_Init
argument_list|(
operator|&
name|c
argument_list|)
expr_stmt|;
name|SHA1_Update
argument_list|(
operator|&
name|c
argument_list|,
operator|&
name|hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
name|buf
operator|=
name|xmalloc
argument_list|(
name|buf_sz
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|ssize_t
name|n
init|=
name|xread
argument_list|(
name|pack_fd
argument_list|,
name|buf
argument_list|,
name|buf_sz
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|n
condition|)
break|break;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
name|die
argument_list|(
literal|"Failed to checksum %s: %s"
argument_list|,
name|pack_name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|SHA1_Update
argument_list|(
operator|&
name|c
argument_list|,
name|buf
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|SHA1_Final
argument_list|(
name|pack_file_sha1
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|write_or_die
argument_list|(
name|pack_fd
argument_list|,
name|pack_file_sha1
argument_list|,
literal|20
argument_list|)
expr_stmt|;
block|}
end_function
end_unit
