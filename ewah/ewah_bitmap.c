begin_unit
begin_comment
comment|/**  * Copyright 2013, GitHub, Inc  * Copyright 2009-2013, Daniel Lemire, Cliff Moon,  *	David McIntosh, Robert Becho, Google Inc. and Veronika Zenz  *  * This program is free software; you can redistribute it and/or  * modify it under the terms of the GNU General Public License  * as published by the Free Software Foundation; either version 2  * of the License, or (at your option) any later version.  *  * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.  */
end_comment
begin_include
include|#
directive|include
file|"git-compat-util.h"
end_include
begin_include
include|#
directive|include
file|"ewok.h"
end_include
begin_include
include|#
directive|include
file|"ewok_rlw.h"
end_include
begin_function
DECL|function|min_size
specifier|static
specifier|inline
name|size_t
name|min_size
parameter_list|(
name|size_t
name|a
parameter_list|,
name|size_t
name|b
parameter_list|)
block|{
return|return
name|a
operator|<
name|b
condition|?
name|a
else|:
name|b
return|;
block|}
end_function
begin_function
DECL|function|max_size
specifier|static
specifier|inline
name|size_t
name|max_size
parameter_list|(
name|size_t
name|a
parameter_list|,
name|size_t
name|b
parameter_list|)
block|{
return|return
name|a
operator|>
name|b
condition|?
name|a
else|:
name|b
return|;
block|}
end_function
begin_function
DECL|function|buffer_grow
specifier|static
specifier|inline
name|void
name|buffer_grow
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|self
parameter_list|,
name|size_t
name|new_size
parameter_list|)
block|{
name|size_t
name|rlw_offset
init|=
operator|(
name|uint8_t
operator|*
operator|)
name|self
operator|->
name|rlw
operator|-
operator|(
name|uint8_t
operator|*
operator|)
name|self
operator|->
name|buffer
decl_stmt|;
if|if
condition|(
name|self
operator|->
name|alloc_size
operator|>=
name|new_size
condition|)
return|return;
name|self
operator|->
name|alloc_size
operator|=
name|new_size
expr_stmt|;
name|self
operator|->
name|buffer
operator|=
name|ewah_realloc
argument_list|(
name|self
operator|->
name|buffer
argument_list|,
name|self
operator|->
name|alloc_size
operator|*
sizeof|sizeof
argument_list|(
name|eword_t
argument_list|)
argument_list|)
expr_stmt|;
name|self
operator|->
name|rlw
operator|=
name|self
operator|->
name|buffer
operator|+
operator|(
name|rlw_offset
operator|/
sizeof|sizeof
argument_list|(
name|eword_t
argument_list|)
operator|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|buffer_push
specifier|static
specifier|inline
name|void
name|buffer_push
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|self
parameter_list|,
name|eword_t
name|value
parameter_list|)
block|{
if|if
condition|(
name|self
operator|->
name|buffer_size
operator|+
literal|1
operator|>=
name|self
operator|->
name|alloc_size
condition|)
name|buffer_grow
argument_list|(
name|self
argument_list|,
name|self
operator|->
name|buffer_size
operator|*
literal|3
operator|/
literal|2
argument_list|)
expr_stmt|;
name|self
operator|->
name|buffer
index|[
name|self
operator|->
name|buffer_size
operator|++
index|]
operator|=
name|value
expr_stmt|;
block|}
end_function
begin_function
DECL|function|buffer_push_rlw
specifier|static
name|void
name|buffer_push_rlw
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|self
parameter_list|,
name|eword_t
name|value
parameter_list|)
block|{
name|buffer_push
argument_list|(
name|self
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|self
operator|->
name|rlw
operator|=
name|self
operator|->
name|buffer
operator|+
name|self
operator|->
name|buffer_size
operator|-
literal|1
expr_stmt|;
block|}
end_function
begin_function
DECL|function|add_empty_words
specifier|static
name|size_t
name|add_empty_words
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|self
parameter_list|,
name|int
name|v
parameter_list|,
name|size_t
name|number
parameter_list|)
block|{
name|size_t
name|added
init|=
literal|0
decl_stmt|;
name|eword_t
name|runlen
decl_stmt|,
name|can_add
decl_stmt|;
if|if
condition|(
name|rlw_get_run_bit
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
operator|!=
name|v
operator|&&
name|rlw_size
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rlw_set_run_bit
argument_list|(
name|self
operator|->
name|rlw
argument_list|,
name|v
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rlw_get_literal_words
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
operator|!=
literal|0
operator|||
name|rlw_get_run_bit
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
operator|!=
name|v
condition|)
block|{
name|buffer_push_rlw
argument_list|(
name|self
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
condition|)
name|rlw_set_run_bit
argument_list|(
name|self
operator|->
name|rlw
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|added
operator|++
expr_stmt|;
block|}
name|runlen
operator|=
name|rlw_get_running_len
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
expr_stmt|;
name|can_add
operator|=
name|min_size
argument_list|(
name|number
argument_list|,
name|RLW_LARGEST_RUNNING_COUNT
operator|-
name|runlen
argument_list|)
expr_stmt|;
name|rlw_set_running_len
argument_list|(
name|self
operator|->
name|rlw
argument_list|,
name|runlen
operator|+
name|can_add
argument_list|)
expr_stmt|;
name|number
operator|-=
name|can_add
expr_stmt|;
while|while
condition|(
name|number
operator|>=
name|RLW_LARGEST_RUNNING_COUNT
condition|)
block|{
name|buffer_push_rlw
argument_list|(
name|self
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|added
operator|++
expr_stmt|;
if|if
condition|(
name|v
condition|)
name|rlw_set_run_bit
argument_list|(
name|self
operator|->
name|rlw
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|rlw_set_running_len
argument_list|(
name|self
operator|->
name|rlw
argument_list|,
name|RLW_LARGEST_RUNNING_COUNT
argument_list|)
expr_stmt|;
name|number
operator|-=
name|RLW_LARGEST_RUNNING_COUNT
expr_stmt|;
block|}
if|if
condition|(
name|number
operator|>
literal|0
condition|)
block|{
name|buffer_push_rlw
argument_list|(
name|self
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|added
operator|++
expr_stmt|;
if|if
condition|(
name|v
condition|)
name|rlw_set_run_bit
argument_list|(
name|self
operator|->
name|rlw
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|rlw_set_running_len
argument_list|(
name|self
operator|->
name|rlw
argument_list|,
name|number
argument_list|)
expr_stmt|;
block|}
return|return
name|added
return|;
block|}
end_function
begin_function
DECL|function|ewah_add_empty_words
name|size_t
name|ewah_add_empty_words
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|self
parameter_list|,
name|int
name|v
parameter_list|,
name|size_t
name|number
parameter_list|)
block|{
if|if
condition|(
name|number
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|self
operator|->
name|bit_size
operator|+=
name|number
operator|*
name|BITS_IN_EWORD
expr_stmt|;
return|return
name|add_empty_words
argument_list|(
name|self
argument_list|,
name|v
argument_list|,
name|number
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|add_literal
specifier|static
name|size_t
name|add_literal
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|self
parameter_list|,
name|eword_t
name|new_data
parameter_list|)
block|{
name|eword_t
name|current_num
init|=
name|rlw_get_literal_words
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
decl_stmt|;
if|if
condition|(
name|current_num
operator|>=
name|RLW_LARGEST_LITERAL_COUNT
condition|)
block|{
name|buffer_push_rlw
argument_list|(
name|self
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rlw_set_literal_words
argument_list|(
name|self
operator|->
name|rlw
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|buffer_push
argument_list|(
name|self
argument_list|,
name|new_data
argument_list|)
expr_stmt|;
return|return
literal|2
return|;
block|}
name|rlw_set_literal_words
argument_list|(
name|self
operator|->
name|rlw
argument_list|,
name|current_num
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* sanity check */
name|assert
argument_list|(
name|rlw_get_literal_words
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
operator|==
name|current_num
operator|+
literal|1
argument_list|)
expr_stmt|;
name|buffer_push
argument_list|(
name|self
argument_list|,
name|new_data
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function
begin_function
DECL|function|ewah_add_dirty_words
name|void
name|ewah_add_dirty_words
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|self
parameter_list|,
specifier|const
name|eword_t
modifier|*
name|buffer
parameter_list|,
name|size_t
name|number
parameter_list|,
name|int
name|negate
parameter_list|)
block|{
name|size_t
name|literals
decl_stmt|,
name|can_add
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|literals
operator|=
name|rlw_get_literal_words
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
expr_stmt|;
name|can_add
operator|=
name|min_size
argument_list|(
name|number
argument_list|,
name|RLW_LARGEST_LITERAL_COUNT
operator|-
name|literals
argument_list|)
expr_stmt|;
name|rlw_set_literal_words
argument_list|(
name|self
operator|->
name|rlw
argument_list|,
name|literals
operator|+
name|can_add
argument_list|)
expr_stmt|;
if|if
condition|(
name|self
operator|->
name|buffer_size
operator|+
name|can_add
operator|>=
name|self
operator|->
name|alloc_size
condition|)
name|buffer_grow
argument_list|(
name|self
argument_list|,
operator|(
name|self
operator|->
name|buffer_size
operator|+
name|can_add
operator|)
operator|*
literal|3
operator|/
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|negate
condition|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|can_add
condition|;
operator|++
name|i
control|)
name|self
operator|->
name|buffer
index|[
name|self
operator|->
name|buffer_size
operator|++
index|]
operator|=
operator|~
name|buffer
index|[
name|i
index|]
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|self
operator|->
name|buffer
operator|+
name|self
operator|->
name|buffer_size
argument_list|,
name|buffer
argument_list|,
name|can_add
operator|*
sizeof|sizeof
argument_list|(
name|eword_t
argument_list|)
argument_list|)
expr_stmt|;
name|self
operator|->
name|buffer_size
operator|+=
name|can_add
expr_stmt|;
block|}
name|self
operator|->
name|bit_size
operator|+=
name|can_add
operator|*
name|BITS_IN_EWORD
expr_stmt|;
if|if
condition|(
name|number
operator|-
name|can_add
operator|==
literal|0
condition|)
break|break;
name|buffer_push_rlw
argument_list|(
name|self
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|buffer
operator|+=
name|can_add
expr_stmt|;
name|number
operator|-=
name|can_add
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|add_empty_word
specifier|static
name|size_t
name|add_empty_word
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|self
parameter_list|,
name|int
name|v
parameter_list|)
block|{
name|int
name|no_literal
init|=
operator|(
name|rlw_get_literal_words
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
operator|==
literal|0
operator|)
decl_stmt|;
name|eword_t
name|run_len
init|=
name|rlw_get_running_len
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
decl_stmt|;
if|if
condition|(
name|no_literal
operator|&&
name|run_len
operator|==
literal|0
condition|)
block|{
name|rlw_set_run_bit
argument_list|(
name|self
operator|->
name|rlw
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rlw_get_run_bit
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
operator|==
name|v
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|no_literal
operator|&&
name|rlw_get_run_bit
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
operator|==
name|v
operator|&&
name|run_len
operator|<
name|RLW_LARGEST_RUNNING_COUNT
condition|)
block|{
name|rlw_set_running_len
argument_list|(
name|self
operator|->
name|rlw
argument_list|,
name|run_len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rlw_get_running_len
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
operator|==
name|run_len
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
block|{
name|buffer_push_rlw
argument_list|(
name|self
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rlw_get_running_len
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rlw_get_run_bit
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rlw_get_literal_words
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|rlw_set_run_bit
argument_list|(
name|self
operator|->
name|rlw
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rlw_get_run_bit
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
operator|==
name|v
argument_list|)
expr_stmt|;
name|rlw_set_running_len
argument_list|(
name|self
operator|->
name|rlw
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rlw_get_running_len
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rlw_get_literal_words
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
end_function
begin_function
DECL|function|ewah_add
name|size_t
name|ewah_add
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|self
parameter_list|,
name|eword_t
name|word
parameter_list|)
block|{
name|self
operator|->
name|bit_size
operator|+=
name|BITS_IN_EWORD
expr_stmt|;
if|if
condition|(
name|word
operator|==
literal|0
condition|)
return|return
name|add_empty_word
argument_list|(
name|self
argument_list|,
literal|0
argument_list|)
return|;
if|if
condition|(
name|word
operator|==
call|(
name|eword_t
call|)
argument_list|(
operator|~
literal|0
argument_list|)
condition|)
return|return
name|add_empty_word
argument_list|(
name|self
argument_list|,
literal|1
argument_list|)
return|;
return|return
name|add_literal
argument_list|(
name|self
argument_list|,
name|word
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|ewah_set
name|void
name|ewah_set
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|self
parameter_list|,
name|size_t
name|i
parameter_list|)
block|{
specifier|const
name|size_t
name|dist
init|=
operator|(
name|i
operator|+
name|BITS_IN_EWORD
operator|)
operator|/
name|BITS_IN_EWORD
operator|-
operator|(
name|self
operator|->
name|bit_size
operator|+
name|BITS_IN_EWORD
operator|-
literal|1
operator|)
operator|/
name|BITS_IN_EWORD
decl_stmt|;
name|assert
argument_list|(
name|i
operator|>=
name|self
operator|->
name|bit_size
argument_list|)
expr_stmt|;
name|self
operator|->
name|bit_size
operator|=
name|i
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|dist
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|dist
operator|>
literal|1
condition|)
name|add_empty_words
argument_list|(
name|self
argument_list|,
literal|0
argument_list|,
name|dist
operator|-
literal|1
argument_list|)
expr_stmt|;
name|add_literal
argument_list|(
name|self
argument_list|,
operator|(
name|eword_t
operator|)
literal|1
operator|<<
operator|(
name|i
operator|%
name|BITS_IN_EWORD
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rlw_get_literal_words
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rlw_set_running_len
argument_list|(
name|self
operator|->
name|rlw
argument_list|,
name|rlw_get_running_len
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|add_literal
argument_list|(
name|self
argument_list|,
operator|(
name|eword_t
operator|)
literal|1
operator|<<
operator|(
name|i
operator|%
name|BITS_IN_EWORD
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|self
operator|->
name|buffer
index|[
name|self
operator|->
name|buffer_size
operator|-
literal|1
index|]
operator||=
operator|(
operator|(
name|eword_t
operator|)
literal|1
operator|<<
operator|(
name|i
operator|%
name|BITS_IN_EWORD
operator|)
operator|)
expr_stmt|;
comment|/* check if we just completed a stream of 1s */
if|if
condition|(
name|self
operator|->
name|buffer
index|[
name|self
operator|->
name|buffer_size
operator|-
literal|1
index|]
operator|==
call|(
name|eword_t
call|)
argument_list|(
operator|~
literal|0
argument_list|)
condition|)
block|{
name|self
operator|->
name|buffer
index|[
operator|--
name|self
operator|->
name|buffer_size
index|]
operator|=
literal|0
expr_stmt|;
name|rlw_set_literal_words
argument_list|(
name|self
operator|->
name|rlw
argument_list|,
name|rlw_get_literal_words
argument_list|(
name|self
operator|->
name|rlw
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|add_empty_word
argument_list|(
name|self
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|ewah_each_bit
name|void
name|ewah_each_bit
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|self
parameter_list|,
name|void
function_decl|(
modifier|*
name|callback
function_decl|)
parameter_list|(
name|size_t
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|payload
parameter_list|)
block|{
name|size_t
name|pos
init|=
literal|0
decl_stmt|;
name|size_t
name|pointer
init|=
literal|0
decl_stmt|;
name|size_t
name|k
decl_stmt|;
while|while
condition|(
name|pointer
operator|<
name|self
operator|->
name|buffer_size
condition|)
block|{
name|eword_t
modifier|*
name|word
init|=
operator|&
name|self
operator|->
name|buffer
index|[
name|pointer
index|]
decl_stmt|;
if|if
condition|(
name|rlw_get_run_bit
argument_list|(
name|word
argument_list|)
condition|)
block|{
name|size_t
name|len
init|=
name|rlw_get_running_len
argument_list|(
name|word
argument_list|)
operator|*
name|BITS_IN_EWORD
decl_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|len
condition|;
operator|++
name|k
operator|,
operator|++
name|pos
control|)
name|callback
argument_list|(
name|pos
argument_list|,
name|payload
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pos
operator|+=
name|rlw_get_running_len
argument_list|(
name|word
argument_list|)
operator|*
name|BITS_IN_EWORD
expr_stmt|;
block|}
operator|++
name|pointer
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|rlw_get_literal_words
argument_list|(
name|word
argument_list|)
condition|;
operator|++
name|k
control|)
block|{
name|int
name|c
decl_stmt|;
comment|/* todo: zero count optimization */
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|BITS_IN_EWORD
condition|;
operator|++
name|c
operator|,
operator|++
name|pos
control|)
block|{
if|if
condition|(
operator|(
name|self
operator|->
name|buffer
index|[
name|pointer
index|]
operator|&
operator|(
operator|(
name|eword_t
operator|)
literal|1
operator|<<
name|c
operator|)
operator|)
operator|!=
literal|0
condition|)
name|callback
argument_list|(
name|pos
argument_list|,
name|payload
argument_list|)
expr_stmt|;
block|}
operator|++
name|pointer
expr_stmt|;
block|}
block|}
block|}
end_function
begin_function
DECL|function|ewah_new
name|struct
name|ewah_bitmap
modifier|*
name|ewah_new
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|ewah_bitmap
modifier|*
name|self
decl_stmt|;
name|self
operator|=
name|ewah_malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ewah_bitmap
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|self
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|self
operator|->
name|buffer
operator|=
name|ewah_malloc
argument_list|(
literal|32
operator|*
sizeof|sizeof
argument_list|(
name|eword_t
argument_list|)
argument_list|)
expr_stmt|;
name|self
operator|->
name|alloc_size
operator|=
literal|32
expr_stmt|;
name|ewah_clear
argument_list|(
name|self
argument_list|)
expr_stmt|;
return|return
name|self
return|;
block|}
end_function
begin_function
DECL|function|ewah_clear
name|void
name|ewah_clear
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|self
parameter_list|)
block|{
name|self
operator|->
name|buffer_size
operator|=
literal|1
expr_stmt|;
name|self
operator|->
name|buffer
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|self
operator|->
name|bit_size
operator|=
literal|0
expr_stmt|;
name|self
operator|->
name|rlw
operator|=
name|self
operator|->
name|buffer
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ewah_free
name|void
name|ewah_free
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|self
parameter_list|)
block|{
if|if
condition|(
operator|!
name|self
condition|)
return|return;
if|if
condition|(
name|self
operator|->
name|alloc_size
condition|)
name|free
argument_list|(
name|self
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|self
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|read_new_rlw
specifier|static
name|void
name|read_new_rlw
parameter_list|(
name|struct
name|ewah_iterator
modifier|*
name|it
parameter_list|)
block|{
specifier|const
name|eword_t
modifier|*
name|word
init|=
name|NULL
decl_stmt|;
name|it
operator|->
name|literals
operator|=
literal|0
expr_stmt|;
name|it
operator|->
name|compressed
operator|=
literal|0
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|word
operator|=
operator|&
name|it
operator|->
name|buffer
index|[
name|it
operator|->
name|pointer
index|]
expr_stmt|;
name|it
operator|->
name|rl
operator|=
name|rlw_get_running_len
argument_list|(
name|word
argument_list|)
expr_stmt|;
name|it
operator|->
name|lw
operator|=
name|rlw_get_literal_words
argument_list|(
name|word
argument_list|)
expr_stmt|;
name|it
operator|->
name|b
operator|=
name|rlw_get_run_bit
argument_list|(
name|word
argument_list|)
expr_stmt|;
if|if
condition|(
name|it
operator|->
name|rl
operator|||
name|it
operator|->
name|lw
condition|)
return|return;
if|if
condition|(
name|it
operator|->
name|pointer
operator|<
name|it
operator|->
name|buffer_size
operator|-
literal|1
condition|)
block|{
name|it
operator|->
name|pointer
operator|++
expr_stmt|;
block|}
else|else
block|{
name|it
operator|->
name|pointer
operator|=
name|it
operator|->
name|buffer_size
expr_stmt|;
return|return;
block|}
block|}
block|}
end_function
begin_function
DECL|function|ewah_iterator_next
name|int
name|ewah_iterator_next
parameter_list|(
name|eword_t
modifier|*
name|next
parameter_list|,
name|struct
name|ewah_iterator
modifier|*
name|it
parameter_list|)
block|{
if|if
condition|(
name|it
operator|->
name|pointer
operator|>=
name|it
operator|->
name|buffer_size
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|it
operator|->
name|compressed
operator|<
name|it
operator|->
name|rl
condition|)
block|{
name|it
operator|->
name|compressed
operator|++
expr_stmt|;
operator|*
name|next
operator|=
name|it
operator|->
name|b
condition|?
call|(
name|eword_t
call|)
argument_list|(
operator|~
literal|0
argument_list|)
else|:
literal|0
expr_stmt|;
block|}
else|else
block|{
name|assert
argument_list|(
name|it
operator|->
name|literals
operator|<
name|it
operator|->
name|lw
argument_list|)
expr_stmt|;
name|it
operator|->
name|literals
operator|++
expr_stmt|;
name|it
operator|->
name|pointer
operator|++
expr_stmt|;
name|assert
argument_list|(
name|it
operator|->
name|pointer
operator|<
name|it
operator|->
name|buffer_size
argument_list|)
expr_stmt|;
operator|*
name|next
operator|=
name|it
operator|->
name|buffer
index|[
name|it
operator|->
name|pointer
index|]
expr_stmt|;
block|}
if|if
condition|(
name|it
operator|->
name|compressed
operator|==
name|it
operator|->
name|rl
operator|&&
name|it
operator|->
name|literals
operator|==
name|it
operator|->
name|lw
condition|)
block|{
if|if
condition|(
operator|++
name|it
operator|->
name|pointer
operator|<
name|it
operator|->
name|buffer_size
condition|)
name|read_new_rlw
argument_list|(
name|it
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function
begin_function
DECL|function|ewah_iterator_init
name|void
name|ewah_iterator_init
parameter_list|(
name|struct
name|ewah_iterator
modifier|*
name|it
parameter_list|,
name|struct
name|ewah_bitmap
modifier|*
name|parent
parameter_list|)
block|{
name|it
operator|->
name|buffer
operator|=
name|parent
operator|->
name|buffer
expr_stmt|;
name|it
operator|->
name|buffer_size
operator|=
name|parent
operator|->
name|buffer_size
expr_stmt|;
name|it
operator|->
name|pointer
operator|=
literal|0
expr_stmt|;
name|it
operator|->
name|lw
operator|=
literal|0
expr_stmt|;
name|it
operator|->
name|rl
operator|=
literal|0
expr_stmt|;
name|it
operator|->
name|compressed
operator|=
literal|0
expr_stmt|;
name|it
operator|->
name|literals
operator|=
literal|0
expr_stmt|;
name|it
operator|->
name|b
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|it
operator|->
name|pointer
operator|<
name|it
operator|->
name|buffer_size
condition|)
name|read_new_rlw
argument_list|(
name|it
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ewah_not
name|void
name|ewah_not
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|self
parameter_list|)
block|{
name|size_t
name|pointer
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|pointer
operator|<
name|self
operator|->
name|buffer_size
condition|)
block|{
name|eword_t
modifier|*
name|word
init|=
operator|&
name|self
operator|->
name|buffer
index|[
name|pointer
index|]
decl_stmt|;
name|size_t
name|literals
decl_stmt|,
name|k
decl_stmt|;
name|rlw_xor_run_bit
argument_list|(
name|word
argument_list|)
expr_stmt|;
operator|++
name|pointer
expr_stmt|;
name|literals
operator|=
name|rlw_get_literal_words
argument_list|(
name|word
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|literals
condition|;
operator|++
name|k
control|)
block|{
name|self
operator|->
name|buffer
index|[
name|pointer
index|]
operator|=
operator|~
name|self
operator|->
name|buffer
index|[
name|pointer
index|]
expr_stmt|;
operator|++
name|pointer
expr_stmt|;
block|}
block|}
block|}
end_function
begin_function
DECL|function|ewah_xor
name|void
name|ewah_xor
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|ewah_i
parameter_list|,
name|struct
name|ewah_bitmap
modifier|*
name|ewah_j
parameter_list|,
name|struct
name|ewah_bitmap
modifier|*
name|out
parameter_list|)
block|{
name|struct
name|rlw_iterator
name|rlw_i
decl_stmt|;
name|struct
name|rlw_iterator
name|rlw_j
decl_stmt|;
name|size_t
name|literals
decl_stmt|;
name|rlwit_init
argument_list|(
operator|&
name|rlw_i
argument_list|,
name|ewah_i
argument_list|)
expr_stmt|;
name|rlwit_init
argument_list|(
operator|&
name|rlw_j
argument_list|,
name|ewah_j
argument_list|)
expr_stmt|;
while|while
condition|(
name|rlwit_word_size
argument_list|(
operator|&
name|rlw_i
argument_list|)
operator|>
literal|0
operator|&&
name|rlwit_word_size
argument_list|(
operator|&
name|rlw_j
argument_list|)
operator|>
literal|0
condition|)
block|{
while|while
condition|(
name|rlw_i
operator|.
name|rlw
operator|.
name|running_len
operator|>
literal|0
operator|||
name|rlw_j
operator|.
name|rlw
operator|.
name|running_len
operator|>
literal|0
condition|)
block|{
name|struct
name|rlw_iterator
modifier|*
name|prey
decl_stmt|,
modifier|*
name|predator
decl_stmt|;
name|size_t
name|index
decl_stmt|;
name|int
name|negate_words
decl_stmt|;
if|if
condition|(
name|rlw_i
operator|.
name|rlw
operator|.
name|running_len
operator|<
name|rlw_j
operator|.
name|rlw
operator|.
name|running_len
condition|)
block|{
name|prey
operator|=
operator|&
name|rlw_i
expr_stmt|;
name|predator
operator|=
operator|&
name|rlw_j
expr_stmt|;
block|}
else|else
block|{
name|prey
operator|=
operator|&
name|rlw_j
expr_stmt|;
name|predator
operator|=
operator|&
name|rlw_i
expr_stmt|;
block|}
name|negate_words
operator|=
operator|!
operator|!
name|predator
operator|->
name|rlw
operator|.
name|running_bit
expr_stmt|;
name|index
operator|=
name|rlwit_discharge
argument_list|(
name|prey
argument_list|,
name|out
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
argument_list|,
name|negate_words
argument_list|)
expr_stmt|;
name|ewah_add_empty_words
argument_list|(
name|out
argument_list|,
name|negate_words
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
operator|-
name|index
argument_list|)
expr_stmt|;
name|rlwit_discard_first_words
argument_list|(
name|predator
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
argument_list|)
expr_stmt|;
block|}
name|literals
operator|=
name|min_size
argument_list|(
name|rlw_i
operator|.
name|rlw
operator|.
name|literal_words
argument_list|,
name|rlw_j
operator|.
name|rlw
operator|.
name|literal_words
argument_list|)
expr_stmt|;
if|if
condition|(
name|literals
condition|)
block|{
name|size_t
name|k
decl_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|literals
condition|;
operator|++
name|k
control|)
block|{
name|ewah_add
argument_list|(
name|out
argument_list|,
name|rlw_i
operator|.
name|buffer
index|[
name|rlw_i
operator|.
name|literal_word_start
operator|+
name|k
index|]
operator|^
name|rlw_j
operator|.
name|buffer
index|[
name|rlw_j
operator|.
name|literal_word_start
operator|+
name|k
index|]
argument_list|)
expr_stmt|;
block|}
name|rlwit_discard_first_words
argument_list|(
operator|&
name|rlw_i
argument_list|,
name|literals
argument_list|)
expr_stmt|;
name|rlwit_discard_first_words
argument_list|(
operator|&
name|rlw_j
argument_list|,
name|literals
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rlwit_word_size
argument_list|(
operator|&
name|rlw_i
argument_list|)
operator|>
literal|0
condition|)
name|rlwit_discharge
argument_list|(
operator|&
name|rlw_i
argument_list|,
name|out
argument_list|,
operator|~
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|rlwit_discharge
argument_list|(
operator|&
name|rlw_j
argument_list|,
name|out
argument_list|,
operator|~
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|out
operator|->
name|bit_size
operator|=
name|max_size
argument_list|(
name|ewah_i
operator|->
name|bit_size
argument_list|,
name|ewah_j
operator|->
name|bit_size
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ewah_and
name|void
name|ewah_and
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|ewah_i
parameter_list|,
name|struct
name|ewah_bitmap
modifier|*
name|ewah_j
parameter_list|,
name|struct
name|ewah_bitmap
modifier|*
name|out
parameter_list|)
block|{
name|struct
name|rlw_iterator
name|rlw_i
decl_stmt|;
name|struct
name|rlw_iterator
name|rlw_j
decl_stmt|;
name|size_t
name|literals
decl_stmt|;
name|rlwit_init
argument_list|(
operator|&
name|rlw_i
argument_list|,
name|ewah_i
argument_list|)
expr_stmt|;
name|rlwit_init
argument_list|(
operator|&
name|rlw_j
argument_list|,
name|ewah_j
argument_list|)
expr_stmt|;
while|while
condition|(
name|rlwit_word_size
argument_list|(
operator|&
name|rlw_i
argument_list|)
operator|>
literal|0
operator|&&
name|rlwit_word_size
argument_list|(
operator|&
name|rlw_j
argument_list|)
operator|>
literal|0
condition|)
block|{
while|while
condition|(
name|rlw_i
operator|.
name|rlw
operator|.
name|running_len
operator|>
literal|0
operator|||
name|rlw_j
operator|.
name|rlw
operator|.
name|running_len
operator|>
literal|0
condition|)
block|{
name|struct
name|rlw_iterator
modifier|*
name|prey
decl_stmt|,
modifier|*
name|predator
decl_stmt|;
if|if
condition|(
name|rlw_i
operator|.
name|rlw
operator|.
name|running_len
operator|<
name|rlw_j
operator|.
name|rlw
operator|.
name|running_len
condition|)
block|{
name|prey
operator|=
operator|&
name|rlw_i
expr_stmt|;
name|predator
operator|=
operator|&
name|rlw_j
expr_stmt|;
block|}
else|else
block|{
name|prey
operator|=
operator|&
name|rlw_j
expr_stmt|;
name|predator
operator|=
operator|&
name|rlw_i
expr_stmt|;
block|}
if|if
condition|(
name|predator
operator|->
name|rlw
operator|.
name|running_bit
operator|==
literal|0
condition|)
block|{
name|ewah_add_empty_words
argument_list|(
name|out
argument_list|,
literal|0
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
argument_list|)
expr_stmt|;
name|rlwit_discard_first_words
argument_list|(
name|prey
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
argument_list|)
expr_stmt|;
name|rlwit_discard_first_words
argument_list|(
name|predator
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|size_t
name|index
init|=
name|rlwit_discharge
argument_list|(
name|prey
argument_list|,
name|out
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|ewah_add_empty_words
argument_list|(
name|out
argument_list|,
literal|0
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
operator|-
name|index
argument_list|)
expr_stmt|;
name|rlwit_discard_first_words
argument_list|(
name|predator
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
argument_list|)
expr_stmt|;
block|}
block|}
name|literals
operator|=
name|min_size
argument_list|(
name|rlw_i
operator|.
name|rlw
operator|.
name|literal_words
argument_list|,
name|rlw_j
operator|.
name|rlw
operator|.
name|literal_words
argument_list|)
expr_stmt|;
if|if
condition|(
name|literals
condition|)
block|{
name|size_t
name|k
decl_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|literals
condition|;
operator|++
name|k
control|)
block|{
name|ewah_add
argument_list|(
name|out
argument_list|,
name|rlw_i
operator|.
name|buffer
index|[
name|rlw_i
operator|.
name|literal_word_start
operator|+
name|k
index|]
operator|&
name|rlw_j
operator|.
name|buffer
index|[
name|rlw_j
operator|.
name|literal_word_start
operator|+
name|k
index|]
argument_list|)
expr_stmt|;
block|}
name|rlwit_discard_first_words
argument_list|(
operator|&
name|rlw_i
argument_list|,
name|literals
argument_list|)
expr_stmt|;
name|rlwit_discard_first_words
argument_list|(
operator|&
name|rlw_j
argument_list|,
name|literals
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rlwit_word_size
argument_list|(
operator|&
name|rlw_i
argument_list|)
operator|>
literal|0
condition|)
name|rlwit_discharge_empty
argument_list|(
operator|&
name|rlw_i
argument_list|,
name|out
argument_list|)
expr_stmt|;
else|else
name|rlwit_discharge_empty
argument_list|(
operator|&
name|rlw_j
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|out
operator|->
name|bit_size
operator|=
name|max_size
argument_list|(
name|ewah_i
operator|->
name|bit_size
argument_list|,
name|ewah_j
operator|->
name|bit_size
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ewah_and_not
name|void
name|ewah_and_not
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|ewah_i
parameter_list|,
name|struct
name|ewah_bitmap
modifier|*
name|ewah_j
parameter_list|,
name|struct
name|ewah_bitmap
modifier|*
name|out
parameter_list|)
block|{
name|struct
name|rlw_iterator
name|rlw_i
decl_stmt|;
name|struct
name|rlw_iterator
name|rlw_j
decl_stmt|;
name|size_t
name|literals
decl_stmt|;
name|rlwit_init
argument_list|(
operator|&
name|rlw_i
argument_list|,
name|ewah_i
argument_list|)
expr_stmt|;
name|rlwit_init
argument_list|(
operator|&
name|rlw_j
argument_list|,
name|ewah_j
argument_list|)
expr_stmt|;
while|while
condition|(
name|rlwit_word_size
argument_list|(
operator|&
name|rlw_i
argument_list|)
operator|>
literal|0
operator|&&
name|rlwit_word_size
argument_list|(
operator|&
name|rlw_j
argument_list|)
operator|>
literal|0
condition|)
block|{
while|while
condition|(
name|rlw_i
operator|.
name|rlw
operator|.
name|running_len
operator|>
literal|0
operator|||
name|rlw_j
operator|.
name|rlw
operator|.
name|running_len
operator|>
literal|0
condition|)
block|{
name|struct
name|rlw_iterator
modifier|*
name|prey
decl_stmt|,
modifier|*
name|predator
decl_stmt|;
if|if
condition|(
name|rlw_i
operator|.
name|rlw
operator|.
name|running_len
operator|<
name|rlw_j
operator|.
name|rlw
operator|.
name|running_len
condition|)
block|{
name|prey
operator|=
operator|&
name|rlw_i
expr_stmt|;
name|predator
operator|=
operator|&
name|rlw_j
expr_stmt|;
block|}
else|else
block|{
name|prey
operator|=
operator|&
name|rlw_j
expr_stmt|;
name|predator
operator|=
operator|&
name|rlw_i
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|predator
operator|->
name|rlw
operator|.
name|running_bit
operator|&&
name|prey
operator|==
operator|&
name|rlw_i
operator|)
operator|||
operator|(
operator|!
name|predator
operator|->
name|rlw
operator|.
name|running_bit
operator|&&
name|prey
operator|!=
operator|&
name|rlw_i
operator|)
condition|)
block|{
name|ewah_add_empty_words
argument_list|(
name|out
argument_list|,
literal|0
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
argument_list|)
expr_stmt|;
name|rlwit_discard_first_words
argument_list|(
name|prey
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
argument_list|)
expr_stmt|;
name|rlwit_discard_first_words
argument_list|(
name|predator
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|size_t
name|index
decl_stmt|;
name|int
name|negate_words
decl_stmt|;
name|negate_words
operator|=
operator|(
operator|&
name|rlw_i
operator|!=
name|prey
operator|)
expr_stmt|;
name|index
operator|=
name|rlwit_discharge
argument_list|(
name|prey
argument_list|,
name|out
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
argument_list|,
name|negate_words
argument_list|)
expr_stmt|;
name|ewah_add_empty_words
argument_list|(
name|out
argument_list|,
name|negate_words
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
operator|-
name|index
argument_list|)
expr_stmt|;
name|rlwit_discard_first_words
argument_list|(
name|predator
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
argument_list|)
expr_stmt|;
block|}
block|}
name|literals
operator|=
name|min_size
argument_list|(
name|rlw_i
operator|.
name|rlw
operator|.
name|literal_words
argument_list|,
name|rlw_j
operator|.
name|rlw
operator|.
name|literal_words
argument_list|)
expr_stmt|;
if|if
condition|(
name|literals
condition|)
block|{
name|size_t
name|k
decl_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|literals
condition|;
operator|++
name|k
control|)
block|{
name|ewah_add
argument_list|(
name|out
argument_list|,
name|rlw_i
operator|.
name|buffer
index|[
name|rlw_i
operator|.
name|literal_word_start
operator|+
name|k
index|]
operator|&
operator|~
operator|(
name|rlw_j
operator|.
name|buffer
index|[
name|rlw_j
operator|.
name|literal_word_start
operator|+
name|k
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
name|rlwit_discard_first_words
argument_list|(
operator|&
name|rlw_i
argument_list|,
name|literals
argument_list|)
expr_stmt|;
name|rlwit_discard_first_words
argument_list|(
operator|&
name|rlw_j
argument_list|,
name|literals
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rlwit_word_size
argument_list|(
operator|&
name|rlw_i
argument_list|)
operator|>
literal|0
condition|)
name|rlwit_discharge
argument_list|(
operator|&
name|rlw_i
argument_list|,
name|out
argument_list|,
operator|~
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|rlwit_discharge_empty
argument_list|(
operator|&
name|rlw_j
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|out
operator|->
name|bit_size
operator|=
name|max_size
argument_list|(
name|ewah_i
operator|->
name|bit_size
argument_list|,
name|ewah_j
operator|->
name|bit_size
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ewah_or
name|void
name|ewah_or
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|ewah_i
parameter_list|,
name|struct
name|ewah_bitmap
modifier|*
name|ewah_j
parameter_list|,
name|struct
name|ewah_bitmap
modifier|*
name|out
parameter_list|)
block|{
name|struct
name|rlw_iterator
name|rlw_i
decl_stmt|;
name|struct
name|rlw_iterator
name|rlw_j
decl_stmt|;
name|size_t
name|literals
decl_stmt|;
name|rlwit_init
argument_list|(
operator|&
name|rlw_i
argument_list|,
name|ewah_i
argument_list|)
expr_stmt|;
name|rlwit_init
argument_list|(
operator|&
name|rlw_j
argument_list|,
name|ewah_j
argument_list|)
expr_stmt|;
while|while
condition|(
name|rlwit_word_size
argument_list|(
operator|&
name|rlw_i
argument_list|)
operator|>
literal|0
operator|&&
name|rlwit_word_size
argument_list|(
operator|&
name|rlw_j
argument_list|)
operator|>
literal|0
condition|)
block|{
while|while
condition|(
name|rlw_i
operator|.
name|rlw
operator|.
name|running_len
operator|>
literal|0
operator|||
name|rlw_j
operator|.
name|rlw
operator|.
name|running_len
operator|>
literal|0
condition|)
block|{
name|struct
name|rlw_iterator
modifier|*
name|prey
decl_stmt|,
modifier|*
name|predator
decl_stmt|;
if|if
condition|(
name|rlw_i
operator|.
name|rlw
operator|.
name|running_len
operator|<
name|rlw_j
operator|.
name|rlw
operator|.
name|running_len
condition|)
block|{
name|prey
operator|=
operator|&
name|rlw_i
expr_stmt|;
name|predator
operator|=
operator|&
name|rlw_j
expr_stmt|;
block|}
else|else
block|{
name|prey
operator|=
operator|&
name|rlw_j
expr_stmt|;
name|predator
operator|=
operator|&
name|rlw_i
expr_stmt|;
block|}
if|if
condition|(
name|predator
operator|->
name|rlw
operator|.
name|running_bit
condition|)
block|{
name|ewah_add_empty_words
argument_list|(
name|out
argument_list|,
literal|0
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
argument_list|)
expr_stmt|;
name|rlwit_discard_first_words
argument_list|(
name|prey
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
argument_list|)
expr_stmt|;
name|rlwit_discard_first_words
argument_list|(
name|predator
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|size_t
name|index
init|=
name|rlwit_discharge
argument_list|(
name|prey
argument_list|,
name|out
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|ewah_add_empty_words
argument_list|(
name|out
argument_list|,
literal|0
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
operator|-
name|index
argument_list|)
expr_stmt|;
name|rlwit_discard_first_words
argument_list|(
name|predator
argument_list|,
name|predator
operator|->
name|rlw
operator|.
name|running_len
argument_list|)
expr_stmt|;
block|}
block|}
name|literals
operator|=
name|min_size
argument_list|(
name|rlw_i
operator|.
name|rlw
operator|.
name|literal_words
argument_list|,
name|rlw_j
operator|.
name|rlw
operator|.
name|literal_words
argument_list|)
expr_stmt|;
if|if
condition|(
name|literals
condition|)
block|{
name|size_t
name|k
decl_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|literals
condition|;
operator|++
name|k
control|)
block|{
name|ewah_add
argument_list|(
name|out
argument_list|,
name|rlw_i
operator|.
name|buffer
index|[
name|rlw_i
operator|.
name|literal_word_start
operator|+
name|k
index|]
operator||
name|rlw_j
operator|.
name|buffer
index|[
name|rlw_j
operator|.
name|literal_word_start
operator|+
name|k
index|]
argument_list|)
expr_stmt|;
block|}
name|rlwit_discard_first_words
argument_list|(
operator|&
name|rlw_i
argument_list|,
name|literals
argument_list|)
expr_stmt|;
name|rlwit_discard_first_words
argument_list|(
operator|&
name|rlw_j
argument_list|,
name|literals
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rlwit_word_size
argument_list|(
operator|&
name|rlw_i
argument_list|)
operator|>
literal|0
condition|)
name|rlwit_discharge
argument_list|(
operator|&
name|rlw_i
argument_list|,
name|out
argument_list|,
operator|~
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|rlwit_discharge
argument_list|(
operator|&
name|rlw_j
argument_list|,
name|out
argument_list|,
operator|~
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|out
operator|->
name|bit_size
operator|=
name|max_size
argument_list|(
name|ewah_i
operator|->
name|bit_size
argument_list|,
name|ewah_j
operator|->
name|bit_size
argument_list|)
expr_stmt|;
block|}
end_function
begin_define
DECL|macro|BITMAP_POOL_MAX
define|#
directive|define
name|BITMAP_POOL_MAX
value|16
end_define
begin_decl_stmt
DECL|variable|bitmap_pool
specifier|static
name|struct
name|ewah_bitmap
modifier|*
name|bitmap_pool
index|[
name|BITMAP_POOL_MAX
index|]
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|bitmap_pool_size
specifier|static
name|size_t
name|bitmap_pool_size
decl_stmt|;
end_decl_stmt
begin_function
DECL|function|ewah_pool_new
name|struct
name|ewah_bitmap
modifier|*
name|ewah_pool_new
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|bitmap_pool_size
condition|)
return|return
name|bitmap_pool
index|[
operator|--
name|bitmap_pool_size
index|]
return|;
return|return
name|ewah_new
argument_list|()
return|;
block|}
end_function
begin_function
DECL|function|ewah_pool_free
name|void
name|ewah_pool_free
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|self
parameter_list|)
block|{
if|if
condition|(
name|self
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|bitmap_pool_size
operator|==
name|BITMAP_POOL_MAX
operator|||
name|self
operator|->
name|alloc_size
operator|==
literal|0
condition|)
block|{
name|ewah_free
argument_list|(
name|self
argument_list|)
expr_stmt|;
return|return;
block|}
name|ewah_clear
argument_list|(
name|self
argument_list|)
expr_stmt|;
name|bitmap_pool
index|[
name|bitmap_pool_size
operator|++
index|]
operator|=
name|self
expr_stmt|;
block|}
end_function
begin_function
DECL|function|ewah_checksum
name|uint32_t
name|ewah_checksum
parameter_list|(
name|struct
name|ewah_bitmap
modifier|*
name|self
parameter_list|)
block|{
specifier|const
name|uint8_t
modifier|*
name|p
init|=
operator|(
name|uint8_t
operator|*
operator|)
name|self
operator|->
name|buffer
decl_stmt|;
name|uint32_t
name|crc
init|=
operator|(
name|uint32_t
operator|)
name|self
operator|->
name|bit_size
decl_stmt|;
name|size_t
name|size
init|=
name|self
operator|->
name|buffer_size
operator|*
sizeof|sizeof
argument_list|(
name|eword_t
argument_list|)
decl_stmt|;
while|while
condition|(
name|size
operator|--
condition|)
name|crc
operator|=
operator|(
name|crc
operator|<<
literal|5
operator|)
operator|-
name|crc
operator|+
operator|(
name|uint32_t
operator|)
operator|*
name|p
operator|++
expr_stmt|;
return|return
name|crc
return|;
block|}
end_function
end_unit
