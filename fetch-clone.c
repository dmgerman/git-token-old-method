begin_unit
begin_include
include|#
directive|include
file|"cache.h"
end_include
begin_include
include|#
directive|include
file|"exec_cmd.h"
end_include
begin_include
include|#
directive|include
file|"pkt-line.h"
end_include
begin_include
include|#
directive|include
file|"sideband.h"
end_include
begin_include
include|#
directive|include
file|<sys/wait.h>
end_include
begin_function
DECL|function|setup_sideband
specifier|static
name|pid_t
name|setup_sideband
parameter_list|(
name|int
name|sideband
parameter_list|,
specifier|const
name|char
modifier|*
name|me
parameter_list|,
name|int
name|fd
index|[
literal|2
index|]
parameter_list|,
name|int
name|xd
index|[
literal|2
index|]
parameter_list|)
block|{
name|pid_t
name|side_pid
decl_stmt|;
if|if
condition|(
operator|!
name|sideband
condition|)
block|{
name|fd
index|[
literal|0
index|]
operator|=
name|xd
index|[
literal|0
index|]
expr_stmt|;
name|fd
index|[
literal|1
index|]
operator|=
name|xd
index|[
literal|1
index|]
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* xd[] is talking with upload-pack; subprocess reads from 	 * xd[0], spits out band#2 to stderr, and feeds us band#1 	 * through our fd[0]. 	 */
if|if
condition|(
name|pipe
argument_list|(
name|fd
argument_list|)
operator|<
literal|0
condition|)
name|die
argument_list|(
literal|"%s: unable to set up pipe"
argument_list|,
name|me
argument_list|)
expr_stmt|;
name|side_pid
operator|=
name|fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|side_pid
operator|<
literal|0
condition|)
name|die
argument_list|(
literal|"%s: unable to fork off sideband demultiplexer"
argument_list|,
name|me
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|side_pid
condition|)
block|{
comment|/* subprocess */
name|close
argument_list|(
name|fd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|xd
index|[
literal|0
index|]
operator|!=
name|xd
index|[
literal|1
index|]
condition|)
name|close
argument_list|(
name|xd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|recv_sideband
argument_list|(
name|me
argument_list|,
name|xd
index|[
literal|0
index|]
argument_list|,
name|fd
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|)
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|xd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|fd
index|[
literal|1
index|]
operator|=
name|xd
index|[
literal|1
index|]
expr_stmt|;
return|return
name|side_pid
return|;
block|}
end_function
begin_function
DECL|function|get_pack
specifier|static
name|int
name|get_pack
parameter_list|(
name|int
name|xd
index|[
literal|2
index|]
parameter_list|,
specifier|const
name|char
modifier|*
name|me
parameter_list|,
name|int
name|sideband
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|pid_t
name|pid
decl_stmt|,
name|side_pid
decl_stmt|;
name|int
name|fd
index|[
literal|2
index|]
decl_stmt|;
name|side_pid
operator|=
name|setup_sideband
argument_list|(
name|sideband
argument_list|,
name|me
argument_list|,
name|fd
argument_list|,
name|xd
argument_list|)
expr_stmt|;
name|pid
operator|=
name|fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|pid
operator|<
literal|0
condition|)
name|die
argument_list|(
literal|"%s: unable to fork off git-unpack-objects"
argument_list|,
name|me
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pid
condition|)
block|{
name|dup2
argument_list|(
name|fd
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|execv_git_cmd
argument_list|(
name|argv
argument_list|)
expr_stmt|;
name|die
argument_list|(
literal|"%s exec failed"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
name|waitpid
argument_list|(
name|pid
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EINTR
condition|)
name|die
argument_list|(
literal|"waiting for %s: %s"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|WIFEXITED
argument_list|(
name|status
argument_list|)
condition|)
block|{
name|int
name|code
init|=
name|WEXITSTATUS
argument_list|(
name|status
argument_list|)
decl_stmt|;
if|if
condition|(
name|code
condition|)
name|die
argument_list|(
literal|"%s died with error code %d"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|code
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|WIFSIGNALED
argument_list|(
name|status
argument_list|)
condition|)
block|{
name|int
name|sig
init|=
name|WTERMSIG
argument_list|(
name|status
argument_list|)
decl_stmt|;
name|die
argument_list|(
literal|"%s died of signal %d"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|sig
argument_list|)
expr_stmt|;
block|}
name|die
argument_list|(
literal|"%s died of unnatural causes %d"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|receive_unpack_pack
name|int
name|receive_unpack_pack
parameter_list|(
name|int
name|xd
index|[
literal|2
index|]
parameter_list|,
specifier|const
name|char
modifier|*
name|me
parameter_list|,
name|int
name|quiet
parameter_list|,
name|int
name|sideband
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|argv
index|[
literal|3
index|]
init|=
block|{
literal|"unpack-objects"
block|,
name|quiet
operator|?
literal|"-q"
operator|:
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
return|return
name|get_pack
argument_list|(
name|xd
argument_list|,
name|me
argument_list|,
name|sideband
argument_list|,
name|argv
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|receive_keep_pack
name|int
name|receive_keep_pack
parameter_list|(
name|int
name|xd
index|[
literal|2
index|]
parameter_list|,
specifier|const
name|char
modifier|*
name|me
parameter_list|,
name|int
name|quiet
parameter_list|,
name|int
name|sideband
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|argv
index|[
literal|5
index|]
init|=
block|{
literal|"index-pack"
block|,
literal|"--stdin"
block|,
literal|"--fix-thin"
block|,
name|quiet
operator|?
name|NULL
operator|:
literal|"-v"
block|,
name|NULL
block|}
decl_stmt|;
return|return
name|get_pack
argument_list|(
name|xd
argument_list|,
name|me
argument_list|,
name|sideband
argument_list|,
name|argv
argument_list|)
return|;
block|}
end_function
end_unit
