begin_unit
begin_comment
comment|/*  * Copyright (C) 2006, Fredrik Kuivinen<freku045@student.liu.se>  */
end_comment
begin_include
include|#
directive|include
file|<assert.h>
end_include
begin_include
include|#
directive|include
file|<time.h>
end_include
begin_include
include|#
directive|include
file|<sys/time.h>
end_include
begin_include
include|#
directive|include
file|<math.h>
end_include
begin_include
include|#
directive|include
file|"cache.h"
end_include
begin_include
include|#
directive|include
file|"refs.h"
end_include
begin_include
include|#
directive|include
file|"tag.h"
end_include
begin_include
include|#
directive|include
file|"commit.h"
end_include
begin_include
include|#
directive|include
file|"tree.h"
end_include
begin_include
include|#
directive|include
file|"blob.h"
end_include
begin_include
include|#
directive|include
file|"diff.h"
end_include
begin_include
include|#
directive|include
file|"diffcore.h"
end_include
begin_include
include|#
directive|include
file|"revision.h"
end_include
begin_include
include|#
directive|include
file|"xdiff-interface.h"
end_include
begin_define
DECL|macro|DEBUG
define|#
directive|define
name|DEBUG
value|0
end_define
begin_decl_stmt
DECL|variable|blame_usage
specifier|static
specifier|const
name|char
name|blame_usage
index|[]
init|=
literal|"git-blame [-c] [-l] [-t] [-S<revs-file>] [--] file [commit]\n"
literal|"  -c, --compatibility Use the same output mode as git-annotate (Default: off)\n"
literal|"  -l, --long          Show long commit SHA1 (Default: off)\n"
literal|"  -t, --time          Show raw timestamp (Default: off)\n"
literal|"  -S, --revs-file     Use revisions from revs-file instead of calling git-rev-list\n"
literal|"  -h, --help          This message"
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|blame_lines
specifier|static
name|struct
name|commit
modifier|*
modifier|*
name|blame_lines
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|num_blame_lines
specifier|static
name|int
name|num_blame_lines
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|blame_contents
specifier|static
name|char
modifier|*
name|blame_contents
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|blame_len
specifier|static
name|int
name|blame_len
decl_stmt|;
end_decl_stmt
begin_struct
DECL|struct|util_info
struct|struct
name|util_info
block|{
DECL|member|line_map
name|int
modifier|*
name|line_map
decl_stmt|;
DECL|member|sha1
name|unsigned
name|char
name|sha1
index|[
literal|20
index|]
decl_stmt|;
comment|/* blob sha, not commit! */
DECL|member|buf
name|char
modifier|*
name|buf
decl_stmt|;
DECL|member|size
name|unsigned
name|long
name|size
decl_stmt|;
DECL|member|num_lines
name|int
name|num_lines
decl_stmt|;
DECL|member|pathname
specifier|const
name|char
modifier|*
name|pathname
decl_stmt|;
DECL|member|topo_data
name|void
modifier|*
name|topo_data
decl_stmt|;
block|}
struct|;
end_struct
begin_struct
DECL|struct|chunk
struct|struct
name|chunk
block|{
DECL|member|off1
DECL|member|len1
name|int
name|off1
decl_stmt|,
name|len1
decl_stmt|;
comment|/* --- */
DECL|member|off2
DECL|member|len2
name|int
name|off2
decl_stmt|,
name|len2
decl_stmt|;
comment|/* +++ */
block|}
struct|;
end_struct
begin_struct
DECL|struct|patch
struct|struct
name|patch
block|{
DECL|member|chunks
name|struct
name|chunk
modifier|*
name|chunks
decl_stmt|;
DECL|member|num
name|int
name|num
decl_stmt|;
block|}
struct|;
end_struct
begin_function_decl
specifier|static
name|void
name|get_blob
parameter_list|(
name|struct
name|commit
modifier|*
name|commit
parameter_list|)
function_decl|;
end_function_decl
begin_comment
comment|/* Only used for statistics */
end_comment
begin_decl_stmt
DECL|variable|num_get_patch
specifier|static
name|int
name|num_get_patch
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|num_commits
specifier|static
name|int
name|num_commits
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|patch_time
specifier|static
name|int
name|patch_time
decl_stmt|;
end_decl_stmt
begin_struct
DECL|struct|blame_diff_state
struct|struct
name|blame_diff_state
block|{
DECL|member|xm
name|struct
name|xdiff_emit_state
name|xm
decl_stmt|;
DECL|member|ret
name|struct
name|patch
modifier|*
name|ret
decl_stmt|;
block|}
struct|;
end_struct
begin_function
DECL|function|process_u0_diff
specifier|static
name|void
name|process_u0_diff
parameter_list|(
name|void
modifier|*
name|state_
parameter_list|,
name|char
modifier|*
name|line
parameter_list|,
name|unsigned
name|long
name|len
parameter_list|)
block|{
name|struct
name|blame_diff_state
modifier|*
name|state
init|=
name|state_
decl_stmt|;
name|struct
name|chunk
modifier|*
name|chunk
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|4
operator|||
name|line
index|[
literal|0
index|]
operator|!=
literal|'@'
operator|||
name|line
index|[
literal|1
index|]
operator|!=
literal|'@'
condition|)
return|return;
if|if
condition|(
name|DEBUG
condition|)
name|printf
argument_list|(
literal|"chunk line: %.*s"
argument_list|,
operator|(
name|int
operator|)
name|len
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|state
operator|->
name|ret
operator|->
name|num
operator|++
expr_stmt|;
name|state
operator|->
name|ret
operator|->
name|chunks
operator|=
name|xrealloc
argument_list|(
name|state
operator|->
name|ret
operator|->
name|chunks
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|chunk
argument_list|)
operator|*
name|state
operator|->
name|ret
operator|->
name|num
argument_list|)
expr_stmt|;
name|chunk
operator|=
operator|&
name|state
operator|->
name|ret
operator|->
name|chunks
index|[
name|state
operator|->
name|ret
operator|->
name|num
operator|-
literal|1
index|]
expr_stmt|;
name|assert
argument_list|(
operator|!
name|strncmp
argument_list|(
name|line
argument_list|,
literal|"@@ -"
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|parse_hunk_header
argument_list|(
name|line
argument_list|,
name|len
argument_list|,
operator|&
name|chunk
operator|->
name|off1
argument_list|,
operator|&
name|chunk
operator|->
name|len1
argument_list|,
operator|&
name|chunk
operator|->
name|off2
argument_list|,
operator|&
name|chunk
operator|->
name|len2
argument_list|)
condition|)
block|{
name|state
operator|->
name|ret
operator|->
name|num
operator|--
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|chunk
operator|->
name|len1
operator|==
literal|0
condition|)
name|chunk
operator|->
name|off1
operator|++
expr_stmt|;
if|if
condition|(
name|chunk
operator|->
name|len2
operator|==
literal|0
condition|)
name|chunk
operator|->
name|off2
operator|++
expr_stmt|;
if|if
condition|(
name|chunk
operator|->
name|off1
operator|>
literal|0
condition|)
name|chunk
operator|->
name|off1
operator|--
expr_stmt|;
if|if
condition|(
name|chunk
operator|->
name|off2
operator|>
literal|0
condition|)
name|chunk
operator|->
name|off2
operator|--
expr_stmt|;
name|assert
argument_list|(
name|chunk
operator|->
name|off1
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|chunk
operator|->
name|off2
operator|>=
literal|0
argument_list|)
expr_stmt|;
block|}
end_function
begin_function
DECL|function|get_patch
specifier|static
name|struct
name|patch
modifier|*
name|get_patch
parameter_list|(
name|struct
name|commit
modifier|*
name|commit
parameter_list|,
name|struct
name|commit
modifier|*
name|other
parameter_list|)
block|{
name|struct
name|blame_diff_state
name|state
decl_stmt|;
name|xpparam_t
name|xpp
decl_stmt|;
name|xdemitconf_t
name|xecfg
decl_stmt|;
name|mmfile_t
name|file_c
decl_stmt|,
name|file_o
decl_stmt|;
name|xdemitcb_t
name|ecb
decl_stmt|;
name|struct
name|util_info
modifier|*
name|info_c
init|=
operator|(
expr|struct
name|util_info
operator|*
operator|)
name|commit
operator|->
name|util
decl_stmt|;
name|struct
name|util_info
modifier|*
name|info_o
init|=
operator|(
expr|struct
name|util_info
operator|*
operator|)
name|other
operator|->
name|util
decl_stmt|;
name|struct
name|timeval
name|tv_start
decl_stmt|,
name|tv_end
decl_stmt|;
name|get_blob
argument_list|(
name|commit
argument_list|)
expr_stmt|;
name|file_c
operator|.
name|ptr
operator|=
name|info_c
operator|->
name|buf
expr_stmt|;
name|file_c
operator|.
name|size
operator|=
name|info_c
operator|->
name|size
expr_stmt|;
name|get_blob
argument_list|(
name|other
argument_list|)
expr_stmt|;
name|file_o
operator|.
name|ptr
operator|=
name|info_o
operator|->
name|buf
expr_stmt|;
name|file_o
operator|.
name|size
operator|=
name|info_o
operator|->
name|size
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|tv_start
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|xpp
operator|.
name|flags
operator|=
name|XDF_NEED_MINIMAL
expr_stmt|;
name|xecfg
operator|.
name|ctxlen
operator|=
literal|0
expr_stmt|;
name|xecfg
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|ecb
operator|.
name|outf
operator|=
name|xdiff_outf
expr_stmt|;
name|ecb
operator|.
name|priv
operator|=
operator|&
name|state
expr_stmt|;
name|memset
argument_list|(
operator|&
name|state
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|state
argument_list|)
argument_list|)
expr_stmt|;
name|state
operator|.
name|xm
operator|.
name|consume
operator|=
name|process_u0_diff
expr_stmt|;
name|state
operator|.
name|ret
operator|=
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|patch
argument_list|)
argument_list|)
expr_stmt|;
name|state
operator|.
name|ret
operator|->
name|chunks
operator|=
name|NULL
expr_stmt|;
name|state
operator|.
name|ret
operator|->
name|num
operator|=
literal|0
expr_stmt|;
name|xdl_diff
argument_list|(
operator|&
name|file_c
argument_list|,
operator|&
name|file_o
argument_list|,
operator|&
name|xpp
argument_list|,
operator|&
name|xecfg
argument_list|,
operator|&
name|ecb
argument_list|)
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|tv_end
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|patch_time
operator|+=
literal|1000000
operator|*
operator|(
name|tv_end
operator|.
name|tv_sec
operator|-
name|tv_start
operator|.
name|tv_sec
operator|)
operator|+
name|tv_end
operator|.
name|tv_usec
operator|-
name|tv_start
operator|.
name|tv_usec
expr_stmt|;
name|num_get_patch
operator|++
expr_stmt|;
return|return
name|state
operator|.
name|ret
return|;
block|}
end_function
begin_function
DECL|function|free_patch
specifier|static
name|void
name|free_patch
parameter_list|(
name|struct
name|patch
modifier|*
name|p
parameter_list|)
block|{
name|free
argument_list|(
name|p
operator|->
name|chunks
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function
begin_function_decl
specifier|static
name|int
name|get_blob_sha1_internal
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
name|sha1
parameter_list|,
specifier|const
name|char
modifier|*
name|base
parameter_list|,
name|int
name|baselen
parameter_list|,
specifier|const
name|char
modifier|*
name|pathname
parameter_list|,
name|unsigned
name|mode
parameter_list|,
name|int
name|stage
parameter_list|)
function_decl|;
end_function_decl
begin_decl_stmt
DECL|variable|blob_sha1
specifier|static
name|unsigned
name|char
name|blob_sha1
index|[
literal|20
index|]
decl_stmt|;
end_decl_stmt
begin_decl_stmt
DECL|variable|blame_file
specifier|static
specifier|const
name|char
modifier|*
name|blame_file
decl_stmt|;
end_decl_stmt
begin_function
DECL|function|get_blob_sha1
specifier|static
name|int
name|get_blob_sha1
parameter_list|(
name|struct
name|tree
modifier|*
name|t
parameter_list|,
specifier|const
name|char
modifier|*
name|pathname
parameter_list|,
name|unsigned
name|char
modifier|*
name|sha1
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|pathspec
index|[
literal|2
index|]
decl_stmt|;
name|blame_file
operator|=
name|pathname
expr_stmt|;
name|pathspec
index|[
literal|0
index|]
operator|=
name|pathname
expr_stmt|;
name|pathspec
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|hashclr
argument_list|(
name|blob_sha1
argument_list|)
expr_stmt|;
name|read_tree_recursive
argument_list|(
name|t
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|pathspec
argument_list|,
name|get_blob_sha1_internal
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_null_sha1
argument_list|(
name|blob_sha1
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|hashcpy
argument_list|(
name|sha1
argument_list|,
name|blob_sha1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function
begin_function
DECL|function|get_blob_sha1_internal
specifier|static
name|int
name|get_blob_sha1_internal
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
name|sha1
parameter_list|,
specifier|const
name|char
modifier|*
name|base
parameter_list|,
name|int
name|baselen
parameter_list|,
specifier|const
name|char
modifier|*
name|pathname
parameter_list|,
name|unsigned
name|mode
parameter_list|,
name|int
name|stage
parameter_list|)
block|{
if|if
condition|(
name|S_ISDIR
argument_list|(
name|mode
argument_list|)
condition|)
return|return
name|READ_TREE_RECURSIVE
return|;
if|if
condition|(
name|strncmp
argument_list|(
name|blame_file
argument_list|,
name|base
argument_list|,
name|baselen
argument_list|)
operator|||
name|strcmp
argument_list|(
name|blame_file
operator|+
name|baselen
argument_list|,
name|pathname
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|hashcpy
argument_list|(
name|blob_sha1
argument_list|,
name|sha1
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function
begin_function
DECL|function|get_blob
specifier|static
name|void
name|get_blob
parameter_list|(
name|struct
name|commit
modifier|*
name|commit
parameter_list|)
block|{
name|struct
name|util_info
modifier|*
name|info
init|=
name|commit
operator|->
name|util
decl_stmt|;
name|char
name|type
index|[
literal|20
index|]
decl_stmt|;
if|if
condition|(
name|info
operator|->
name|buf
condition|)
return|return;
name|info
operator|->
name|buf
operator|=
name|read_sha1_file
argument_list|(
name|info
operator|->
name|sha1
argument_list|,
name|type
argument_list|,
operator|&
name|info
operator|->
name|size
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|!
name|strcmp
argument_list|(
name|type
argument_list|,
name|blob_type
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function
begin_comment
comment|/* For debugging only */
end_comment
begin_function
DECL|function|print_patch
specifier|static
name|void
name|print_patch
parameter_list|(
name|struct
name|patch
modifier|*
name|p
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"Num chunks: %d\n"
argument_list|,
name|p
operator|->
name|num
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
operator|->
name|num
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%d,%d %d,%d\n"
argument_list|,
name|p
operator|->
name|chunks
index|[
name|i
index|]
operator|.
name|off1
argument_list|,
name|p
operator|->
name|chunks
index|[
name|i
index|]
operator|.
name|len1
argument_list|,
name|p
operator|->
name|chunks
index|[
name|i
index|]
operator|.
name|off2
argument_list|,
name|p
operator|->
name|chunks
index|[
name|i
index|]
operator|.
name|len2
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_if
if|#
directive|if
name|DEBUG
end_if
begin_comment
comment|/* For debugging only */
end_comment
begin_function
DECL|function|print_map
specifier|static
name|void
name|print_map
parameter_list|(
name|struct
name|commit
modifier|*
name|cmit
parameter_list|,
name|struct
name|commit
modifier|*
name|other
parameter_list|)
block|{
name|struct
name|util_info
modifier|*
name|util
init|=
name|cmit
operator|->
name|util
decl_stmt|;
name|struct
name|util_info
modifier|*
name|util2
init|=
name|other
operator|->
name|util
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|max
init|=
name|util
operator|->
name|num_lines
operator|>
name|util2
operator|->
name|num_lines
condition|?
name|util
operator|->
name|num_lines
else|:
name|util2
operator|->
name|num_lines
decl_stmt|;
name|int
name|num
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"i: %d "
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|num
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|i
operator|<
name|util
operator|->
name|num_lines
condition|)
block|{
name|num
operator|=
name|util
operator|->
name|line_map
index|[
name|i
index|]
expr_stmt|;
name|printf
argument_list|(
literal|"%d\t"
argument_list|,
name|num
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
name|util2
operator|->
name|num_lines
condition|)
block|{
name|int
name|num2
init|=
name|util2
operator|->
name|line_map
index|[
name|i
index|]
decl_stmt|;
name|printf
argument_list|(
literal|"%d\t"
argument_list|,
name|num2
argument_list|)
expr_stmt|;
if|if
condition|(
name|num
operator|!=
operator|-
literal|1
operator|&&
name|num2
operator|!=
name|num
condition|)
name|printf
argument_list|(
literal|"---"
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/* p is a patch from commit to other. */
end_comment
begin_function
DECL|function|fill_line_map
specifier|static
name|void
name|fill_line_map
parameter_list|(
name|struct
name|commit
modifier|*
name|commit
parameter_list|,
name|struct
name|commit
modifier|*
name|other
parameter_list|,
name|struct
name|patch
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|util_info
modifier|*
name|util
init|=
name|commit
operator|->
name|util
decl_stmt|;
name|struct
name|util_info
modifier|*
name|util2
init|=
name|other
operator|->
name|util
decl_stmt|;
name|int
modifier|*
name|map
init|=
name|util
operator|->
name|line_map
decl_stmt|;
name|int
modifier|*
name|map2
init|=
name|util2
operator|->
name|line_map
decl_stmt|;
name|int
name|cur_chunk
init|=
literal|0
decl_stmt|;
name|int
name|i1
decl_stmt|,
name|i2
decl_stmt|;
if|if
condition|(
name|DEBUG
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|num
condition|)
name|print_patch
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"num lines 1: %d num lines 2: %d\n"
argument_list|,
name|util
operator|->
name|num_lines
argument_list|,
name|util2
operator|->
name|num_lines
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i1
operator|=
literal|0
operator|,
name|i2
operator|=
literal|0
init|;
name|i1
operator|<
name|util
operator|->
name|num_lines
condition|;
name|i1
operator|++
operator|,
name|i2
operator|++
control|)
block|{
name|struct
name|chunk
modifier|*
name|chunk
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|cur_chunk
operator|<
name|p
operator|->
name|num
condition|)
name|chunk
operator|=
operator|&
name|p
operator|->
name|chunks
index|[
name|cur_chunk
index|]
expr_stmt|;
if|if
condition|(
name|chunk
operator|&&
name|chunk
operator|->
name|off1
operator|==
name|i1
condition|)
block|{
if|if
condition|(
name|DEBUG
operator|&&
name|i2
operator|!=
name|chunk
operator|->
name|off2
condition|)
name|printf
argument_list|(
literal|"i2: %d off2: %d\n"
argument_list|,
name|i2
argument_list|,
name|chunk
operator|->
name|off2
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|i2
operator|==
name|chunk
operator|->
name|off2
argument_list|)
expr_stmt|;
name|i1
operator|--
expr_stmt|;
name|i2
operator|--
expr_stmt|;
if|if
condition|(
name|chunk
operator|->
name|len1
operator|>
literal|0
condition|)
name|i1
operator|+=
name|chunk
operator|->
name|len1
expr_stmt|;
if|if
condition|(
name|chunk
operator|->
name|len2
operator|>
literal|0
condition|)
name|i2
operator|+=
name|chunk
operator|->
name|len2
expr_stmt|;
name|cur_chunk
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|i2
operator|>=
name|util2
operator|->
name|num_lines
condition|)
break|break;
if|if
condition|(
name|map
index|[
name|i1
index|]
operator|!=
name|map2
index|[
name|i2
index|]
operator|&&
name|map
index|[
name|i1
index|]
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|DEBUG
condition|)
name|printf
argument_list|(
literal|"map: i1: %d %d %p i2: %d %d %p\n"
argument_list|,
name|i1
argument_list|,
name|map
index|[
name|i1
index|]
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|i1
operator|!=
operator|-
literal|1
condition|?
name|blame_lines
index|[
name|map
index|[
name|i1
index|]
index|]
else|:
name|NULL
operator|)
argument_list|,
name|i2
argument_list|,
name|map2
index|[
name|i2
index|]
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|i2
operator|!=
operator|-
literal|1
condition|?
name|blame_lines
index|[
name|map2
index|[
name|i2
index|]
index|]
else|:
name|NULL
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|map2
index|[
name|i2
index|]
operator|!=
operator|-
literal|1
operator|&&
name|blame_lines
index|[
name|map
index|[
name|i1
index|]
index|]
operator|&&
operator|!
name|blame_lines
index|[
name|map2
index|[
name|i2
index|]
index|]
condition|)
name|map
index|[
name|i1
index|]
operator|=
name|map2
index|[
name|i2
index|]
expr_stmt|;
block|}
if|if
condition|(
name|map
index|[
name|i1
index|]
operator|==
operator|-
literal|1
operator|&&
name|map2
index|[
name|i2
index|]
operator|!=
operator|-
literal|1
condition|)
name|map
index|[
name|i1
index|]
operator|=
name|map2
index|[
name|i2
index|]
expr_stmt|;
block|}
if|if
condition|(
name|DEBUG
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"l1: %d l2: %d i1: %d i2: %d\n"
argument_list|,
name|map
index|[
name|i1
index|]
argument_list|,
name|map2
index|[
name|i2
index|]
argument_list|,
name|i1
argument_list|,
name|i2
argument_list|)
expr_stmt|;
block|}
block|}
end_function
begin_function
DECL|function|map_line
specifier|static
name|int
name|map_line
parameter_list|(
name|struct
name|commit
modifier|*
name|commit
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|struct
name|util_info
modifier|*
name|info
init|=
name|commit
operator|->
name|util
decl_stmt|;
name|assert
argument_list|(
name|line
operator|>=
literal|0
operator|&&
name|line
operator|<
name|info
operator|->
name|num_lines
argument_list|)
expr_stmt|;
return|return
name|info
operator|->
name|line_map
index|[
name|line
index|]
return|;
block|}
end_function
begin_function
DECL|function|get_util
specifier|static
name|struct
name|util_info
modifier|*
name|get_util
parameter_list|(
name|struct
name|commit
modifier|*
name|commit
parameter_list|)
block|{
name|struct
name|util_info
modifier|*
name|util
init|=
name|commit
operator|->
name|util
decl_stmt|;
if|if
condition|(
name|util
condition|)
return|return
name|util
return|;
name|util
operator|=
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|util_info
argument_list|)
argument_list|)
expr_stmt|;
name|util
operator|->
name|buf
operator|=
name|NULL
expr_stmt|;
name|util
operator|->
name|size
operator|=
literal|0
expr_stmt|;
name|util
operator|->
name|line_map
operator|=
name|NULL
expr_stmt|;
name|util
operator|->
name|num_lines
operator|=
operator|-
literal|1
expr_stmt|;
name|util
operator|->
name|pathname
operator|=
name|NULL
expr_stmt|;
name|commit
operator|->
name|util
operator|=
name|util
expr_stmt|;
return|return
name|util
return|;
block|}
end_function
begin_function
DECL|function|fill_util_info
specifier|static
name|int
name|fill_util_info
parameter_list|(
name|struct
name|commit
modifier|*
name|commit
parameter_list|)
block|{
name|struct
name|util_info
modifier|*
name|util
init|=
name|commit
operator|->
name|util
decl_stmt|;
name|assert
argument_list|(
name|util
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|util
operator|->
name|pathname
argument_list|)
expr_stmt|;
return|return
operator|!
operator|!
name|get_blob_sha1
argument_list|(
name|commit
operator|->
name|tree
argument_list|,
name|util
operator|->
name|pathname
argument_list|,
name|util
operator|->
name|sha1
argument_list|)
return|;
block|}
end_function
begin_function
DECL|function|alloc_line_map
specifier|static
name|void
name|alloc_line_map
parameter_list|(
name|struct
name|commit
modifier|*
name|commit
parameter_list|)
block|{
name|struct
name|util_info
modifier|*
name|util
init|=
name|commit
operator|->
name|util
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|util
operator|->
name|line_map
condition|)
return|return;
name|get_blob
argument_list|(
name|commit
argument_list|)
expr_stmt|;
name|util
operator|->
name|num_lines
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|util
operator|->
name|size
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|util
operator|->
name|buf
index|[
name|i
index|]
operator|==
literal|'\n'
condition|)
name|util
operator|->
name|num_lines
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|util
operator|->
name|buf
index|[
name|util
operator|->
name|size
operator|-
literal|1
index|]
operator|!=
literal|'\n'
condition|)
name|util
operator|->
name|num_lines
operator|++
expr_stmt|;
name|util
operator|->
name|line_map
operator|=
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|*
name|util
operator|->
name|num_lines
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|util
operator|->
name|num_lines
condition|;
name|i
operator|++
control|)
name|util
operator|->
name|line_map
index|[
name|i
index|]
operator|=
operator|-
literal|1
expr_stmt|;
block|}
end_function
begin_function
DECL|function|init_first_commit
specifier|static
name|void
name|init_first_commit
parameter_list|(
name|struct
name|commit
modifier|*
name|commit
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|struct
name|util_info
modifier|*
name|util
init|=
name|commit
operator|->
name|util
decl_stmt|;
name|int
name|i
decl_stmt|;
name|util
operator|->
name|pathname
operator|=
name|filename
expr_stmt|;
if|if
condition|(
name|fill_util_info
argument_list|(
name|commit
argument_list|)
condition|)
name|die
argument_list|(
literal|"fill_util_info failed"
argument_list|)
expr_stmt|;
name|alloc_line_map
argument_list|(
name|commit
argument_list|)
expr_stmt|;
name|util
operator|=
name|commit
operator|->
name|util
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|util
operator|->
name|num_lines
condition|;
name|i
operator|++
control|)
name|util
operator|->
name|line_map
index|[
name|i
index|]
operator|=
name|i
expr_stmt|;
block|}
end_function
begin_function
DECL|function|process_commits
specifier|static
name|void
name|process_commits
parameter_list|(
name|struct
name|rev_info
modifier|*
name|rev
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|struct
name|commit
modifier|*
modifier|*
name|initial
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|util_info
modifier|*
name|util
decl_stmt|;
name|int
name|lines_left
decl_stmt|;
name|int
modifier|*
name|blame_p
decl_stmt|;
name|int
modifier|*
name|new_lines
decl_stmt|;
name|int
name|new_lines_len
decl_stmt|;
name|struct
name|commit
modifier|*
name|commit
init|=
name|get_revision
argument_list|(
name|rev
argument_list|)
decl_stmt|;
name|assert
argument_list|(
name|commit
argument_list|)
expr_stmt|;
name|init_first_commit
argument_list|(
name|commit
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|util
operator|=
name|commit
operator|->
name|util
expr_stmt|;
name|num_blame_lines
operator|=
name|util
operator|->
name|num_lines
expr_stmt|;
name|blame_lines
operator|=
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|commit
operator|*
argument_list|)
operator|*
name|num_blame_lines
argument_list|)
expr_stmt|;
name|blame_contents
operator|=
name|util
operator|->
name|buf
expr_stmt|;
name|blame_len
operator|=
name|util
operator|->
name|size
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_blame_lines
condition|;
name|i
operator|++
control|)
name|blame_lines
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|lines_left
operator|=
name|num_blame_lines
expr_stmt|;
name|blame_p
operator|=
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|*
name|num_blame_lines
argument_list|)
expr_stmt|;
name|new_lines
operator|=
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|*
name|num_blame_lines
argument_list|)
expr_stmt|;
do|do
block|{
name|struct
name|commit_list
modifier|*
name|parents
decl_stmt|;
name|int
name|num_parents
decl_stmt|;
name|struct
name|util_info
modifier|*
name|util
decl_stmt|;
if|if
condition|(
name|DEBUG
condition|)
name|printf
argument_list|(
literal|"\nProcessing commit: %d %s\n"
argument_list|,
name|num_commits
argument_list|,
name|sha1_to_hex
argument_list|(
name|commit
operator|->
name|object
operator|.
name|sha1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lines_left
operator|==
literal|0
condition|)
return|return;
name|num_commits
operator|++
expr_stmt|;
name|memset
argument_list|(
name|blame_p
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|*
name|num_blame_lines
argument_list|)
expr_stmt|;
name|new_lines_len
operator|=
literal|0
expr_stmt|;
name|num_parents
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|parents
operator|=
name|commit
operator|->
name|parents
init|;
name|parents
operator|!=
name|NULL
condition|;
name|parents
operator|=
name|parents
operator|->
name|next
control|)
name|num_parents
operator|++
expr_stmt|;
if|if
condition|(
name|num_parents
operator|==
literal|0
condition|)
operator|*
name|initial
operator|=
name|commit
expr_stmt|;
if|if
condition|(
name|fill_util_info
argument_list|(
name|commit
argument_list|)
condition|)
continue|continue;
name|alloc_line_map
argument_list|(
name|commit
argument_list|)
expr_stmt|;
name|util
operator|=
name|commit
operator|->
name|util
expr_stmt|;
for|for
control|(
name|parents
operator|=
name|commit
operator|->
name|parents
init|;
name|parents
operator|!=
name|NULL
condition|;
name|parents
operator|=
name|parents
operator|->
name|next
control|)
block|{
name|struct
name|commit
modifier|*
name|parent
init|=
name|parents
operator|->
name|item
decl_stmt|;
name|struct
name|patch
modifier|*
name|patch
decl_stmt|;
if|if
condition|(
name|parse_commit
argument_list|(
name|parent
argument_list|)
operator|<
literal|0
condition|)
name|die
argument_list|(
literal|"parse_commit error"
argument_list|)
expr_stmt|;
if|if
condition|(
name|DEBUG
condition|)
name|printf
argument_list|(
literal|"parent: %s\n"
argument_list|,
name|sha1_to_hex
argument_list|(
name|parent
operator|->
name|object
operator|.
name|sha1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fill_util_info
argument_list|(
name|parent
argument_list|)
condition|)
block|{
name|num_parents
operator|--
expr_stmt|;
continue|continue;
block|}
name|patch
operator|=
name|get_patch
argument_list|(
name|parent
argument_list|,
name|commit
argument_list|)
expr_stmt|;
name|alloc_line_map
argument_list|(
name|parent
argument_list|)
expr_stmt|;
name|fill_line_map
argument_list|(
name|parent
argument_list|,
name|commit
argument_list|,
name|patch
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|patch
operator|->
name|num
condition|;
name|i
operator|++
control|)
block|{
name|int
name|l
decl_stmt|;
for|for
control|(
name|l
operator|=
literal|0
init|;
name|l
operator|<
name|patch
operator|->
name|chunks
index|[
name|i
index|]
operator|.
name|len2
condition|;
name|l
operator|++
control|)
block|{
name|int
name|mapped_line
init|=
name|map_line
argument_list|(
name|commit
argument_list|,
name|patch
operator|->
name|chunks
index|[
name|i
index|]
operator|.
name|off2
operator|+
name|l
argument_list|)
decl_stmt|;
if|if
condition|(
name|mapped_line
operator|!=
operator|-
literal|1
condition|)
block|{
name|blame_p
index|[
name|mapped_line
index|]
operator|++
expr_stmt|;
if|if
condition|(
name|blame_p
index|[
name|mapped_line
index|]
operator|==
name|num_parents
condition|)
name|new_lines
index|[
name|new_lines_len
operator|++
index|]
operator|=
name|mapped_line
expr_stmt|;
block|}
block|}
block|}
name|free_patch
argument_list|(
name|patch
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|DEBUG
condition|)
name|printf
argument_list|(
literal|"parents: %d\n"
argument_list|,
name|num_parents
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|new_lines_len
condition|;
name|i
operator|++
control|)
block|{
name|int
name|mapped_line
init|=
name|new_lines
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|blame_lines
index|[
name|mapped_line
index|]
operator|==
name|NULL
condition|)
block|{
name|blame_lines
index|[
name|mapped_line
index|]
operator|=
name|commit
expr_stmt|;
name|lines_left
operator|--
expr_stmt|;
if|if
condition|(
name|DEBUG
condition|)
name|printf
argument_list|(
literal|"blame: mapped: %d i: %d\n"
argument_list|,
name|mapped_line
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
block|}
do|while
condition|(
operator|(
name|commit
operator|=
name|get_revision
argument_list|(
name|rev
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
do|;
block|}
end_function
begin_function
DECL|function|compare_tree_path
specifier|static
name|int
name|compare_tree_path
parameter_list|(
name|struct
name|rev_info
modifier|*
name|revs
parameter_list|,
name|struct
name|commit
modifier|*
name|c1
parameter_list|,
name|struct
name|commit
modifier|*
name|c2
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
specifier|const
name|char
modifier|*
name|paths
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|util_info
modifier|*
name|util
init|=
name|c2
operator|->
name|util
decl_stmt|;
name|paths
index|[
literal|0
index|]
operator|=
name|util
operator|->
name|pathname
expr_stmt|;
name|paths
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|diff_tree_setup_paths
argument_list|(
name|get_pathspec
argument_list|(
name|revs
operator|->
name|prefix
argument_list|,
name|paths
argument_list|)
argument_list|,
operator|&
name|revs
operator|->
name|pruning
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rev_compare_tree
argument_list|(
name|revs
argument_list|,
name|c1
operator|->
name|tree
argument_list|,
name|c2
operator|->
name|tree
argument_list|)
expr_stmt|;
name|diff_tree_release_paths
argument_list|(
operator|&
name|revs
operator|->
name|pruning
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function
begin_function
DECL|function|same_tree_as_empty_path
specifier|static
name|int
name|same_tree_as_empty_path
parameter_list|(
name|struct
name|rev_info
modifier|*
name|revs
parameter_list|,
name|struct
name|tree
modifier|*
name|t1
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
specifier|const
name|char
modifier|*
name|paths
index|[
literal|2
index|]
decl_stmt|;
name|paths
index|[
literal|0
index|]
operator|=
name|path
expr_stmt|;
name|paths
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|diff_tree_setup_paths
argument_list|(
name|get_pathspec
argument_list|(
name|revs
operator|->
name|prefix
argument_list|,
name|paths
argument_list|)
argument_list|,
operator|&
name|revs
operator|->
name|pruning
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rev_same_tree_as_empty
argument_list|(
name|revs
argument_list|,
name|t1
argument_list|)
expr_stmt|;
name|diff_tree_release_paths
argument_list|(
operator|&
name|revs
operator|->
name|pruning
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function
begin_function
DECL|function|find_rename
specifier|static
specifier|const
name|char
modifier|*
name|find_rename
parameter_list|(
name|struct
name|commit
modifier|*
name|commit
parameter_list|,
name|struct
name|commit
modifier|*
name|parent
parameter_list|)
block|{
name|struct
name|util_info
modifier|*
name|cutil
init|=
name|commit
operator|->
name|util
decl_stmt|;
name|struct
name|diff_options
name|diff_opts
decl_stmt|;
specifier|const
name|char
modifier|*
name|paths
index|[
literal|1
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|DEBUG
condition|)
block|{
name|printf
argument_list|(
literal|"find_rename commit: %s "
argument_list|,
name|sha1_to_hex
argument_list|(
name|commit
operator|->
name|object
operator|.
name|sha1
argument_list|)
argument_list|)
expr_stmt|;
name|puts
argument_list|(
name|sha1_to_hex
argument_list|(
name|parent
operator|->
name|object
operator|.
name|sha1
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|diff_setup
argument_list|(
operator|&
name|diff_opts
argument_list|)
expr_stmt|;
name|diff_opts
operator|.
name|recursive
operator|=
literal|1
expr_stmt|;
name|diff_opts
operator|.
name|detect_rename
operator|=
name|DIFF_DETECT_RENAME
expr_stmt|;
name|paths
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
name|diff_tree_setup_paths
argument_list|(
name|paths
argument_list|,
operator|&
name|diff_opts
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff_setup_done
argument_list|(
operator|&
name|diff_opts
argument_list|)
operator|<
literal|0
condition|)
name|die
argument_list|(
literal|"diff_setup_done failed"
argument_list|)
expr_stmt|;
name|diff_tree_sha1
argument_list|(
name|commit
operator|->
name|tree
operator|->
name|object
operator|.
name|sha1
argument_list|,
name|parent
operator|->
name|tree
operator|->
name|object
operator|.
name|sha1
argument_list|,
literal|""
argument_list|,
operator|&
name|diff_opts
argument_list|)
expr_stmt|;
name|diffcore_std
argument_list|(
operator|&
name|diff_opts
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|diff_queued_diff
operator|.
name|nr
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|diff_filepair
modifier|*
name|p
init|=
name|diff_queued_diff
operator|.
name|queue
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|status
operator|==
literal|'R'
operator|&&
operator|!
name|strcmp
argument_list|(
name|p
operator|->
name|one
operator|->
name|path
argument_list|,
name|cutil
operator|->
name|pathname
argument_list|)
condition|)
block|{
if|if
condition|(
name|DEBUG
condition|)
name|printf
argument_list|(
literal|"rename %s -> %s\n"
argument_list|,
name|p
operator|->
name|one
operator|->
name|path
argument_list|,
name|p
operator|->
name|two
operator|->
name|path
argument_list|)
expr_stmt|;
return|return
name|p
operator|->
name|two
operator|->
name|path
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function
begin_function
DECL|function|simplify_commit
specifier|static
name|void
name|simplify_commit
parameter_list|(
name|struct
name|rev_info
modifier|*
name|revs
parameter_list|,
name|struct
name|commit
modifier|*
name|commit
parameter_list|)
block|{
name|struct
name|commit_list
modifier|*
modifier|*
name|pp
decl_stmt|,
modifier|*
name|parent
decl_stmt|;
if|if
condition|(
operator|!
name|commit
operator|->
name|tree
condition|)
return|return;
if|if
condition|(
operator|!
name|commit
operator|->
name|parents
condition|)
block|{
name|struct
name|util_info
modifier|*
name|util
init|=
name|commit
operator|->
name|util
decl_stmt|;
if|if
condition|(
operator|!
name|same_tree_as_empty_path
argument_list|(
name|revs
argument_list|,
name|commit
operator|->
name|tree
argument_list|,
name|util
operator|->
name|pathname
argument_list|)
condition|)
name|commit
operator|->
name|object
operator|.
name|flags
operator||=
name|TREECHANGE
expr_stmt|;
return|return;
block|}
name|pp
operator|=
operator|&
name|commit
operator|->
name|parents
expr_stmt|;
while|while
condition|(
operator|(
name|parent
operator|=
operator|*
name|pp
operator|)
operator|!=
name|NULL
condition|)
block|{
name|struct
name|commit
modifier|*
name|p
init|=
name|parent
operator|->
name|item
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|object
operator|.
name|flags
operator|&
name|UNINTERESTING
condition|)
block|{
name|pp
operator|=
operator|&
name|parent
operator|->
name|next
expr_stmt|;
continue|continue;
block|}
name|parse_commit
argument_list|(
name|p
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|compare_tree_path
argument_list|(
name|revs
argument_list|,
name|p
argument_list|,
name|commit
argument_list|)
condition|)
block|{
case|case
name|REV_TREE_SAME
case|:
name|parent
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|commit
operator|->
name|parents
operator|=
name|parent
expr_stmt|;
name|get_util
argument_list|(
name|p
argument_list|)
operator|->
name|pathname
operator|=
name|get_util
argument_list|(
name|commit
argument_list|)
operator|->
name|pathname
expr_stmt|;
return|return;
case|case
name|REV_TREE_NEW
case|:
block|{
name|struct
name|util_info
modifier|*
name|util
init|=
name|commit
operator|->
name|util
decl_stmt|;
if|if
condition|(
name|revs
operator|->
name|remove_empty_trees
operator|&&
name|same_tree_as_empty_path
argument_list|(
name|revs
argument_list|,
name|p
operator|->
name|tree
argument_list|,
name|util
operator|->
name|pathname
argument_list|)
condition|)
block|{
specifier|const
name|char
modifier|*
name|new_name
init|=
name|find_rename
argument_list|(
name|commit
argument_list|,
name|p
argument_list|)
decl_stmt|;
if|if
condition|(
name|new_name
condition|)
block|{
name|struct
name|util_info
modifier|*
name|putil
init|=
name|get_util
argument_list|(
name|p
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|putil
operator|->
name|pathname
condition|)
name|putil
operator|->
name|pathname
operator|=
name|xstrdup
argument_list|(
name|new_name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|pp
operator|=
name|parent
operator|->
name|next
expr_stmt|;
continue|continue;
block|}
block|}
block|}
comment|/* fallthrough */
case|case
name|REV_TREE_DIFFERENT
case|:
name|pp
operator|=
operator|&
name|parent
operator|->
name|next
expr_stmt|;
if|if
condition|(
operator|!
name|get_util
argument_list|(
name|p
argument_list|)
operator|->
name|pathname
condition|)
name|get_util
argument_list|(
name|p
argument_list|)
operator|->
name|pathname
operator|=
name|get_util
argument_list|(
name|commit
argument_list|)
operator|->
name|pathname
expr_stmt|;
continue|continue;
block|}
name|die
argument_list|(
literal|"bad tree compare for commit %s"
argument_list|,
name|sha1_to_hex
argument_list|(
name|commit
operator|->
name|object
operator|.
name|sha1
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|commit
operator|->
name|object
operator|.
name|flags
operator||=
name|TREECHANGE
expr_stmt|;
block|}
end_function
begin_struct
DECL|struct|commit_info
struct|struct
name|commit_info
block|{
DECL|member|author
name|char
modifier|*
name|author
decl_stmt|;
DECL|member|author_mail
name|char
modifier|*
name|author_mail
decl_stmt|;
DECL|member|author_time
name|unsigned
name|long
name|author_time
decl_stmt|;
DECL|member|author_tz
name|char
modifier|*
name|author_tz
decl_stmt|;
block|}
struct|;
end_struct
begin_function
DECL|function|get_commit_info
specifier|static
name|void
name|get_commit_info
parameter_list|(
name|struct
name|commit
modifier|*
name|commit
parameter_list|,
name|struct
name|commit_info
modifier|*
name|ret
parameter_list|)
block|{
name|int
name|len
decl_stmt|;
name|char
modifier|*
name|tmp
decl_stmt|;
specifier|static
name|char
name|author_buf
index|[
literal|1024
index|]
decl_stmt|;
name|tmp
operator|=
name|strstr
argument_list|(
name|commit
operator|->
name|buffer
argument_list|,
literal|"\nauthor "
argument_list|)
operator|+
literal|8
expr_stmt|;
name|len
operator|=
name|strchr
argument_list|(
name|tmp
argument_list|,
literal|'\n'
argument_list|)
operator|-
name|tmp
expr_stmt|;
name|ret
operator|->
name|author
operator|=
name|author_buf
expr_stmt|;
name|memcpy
argument_list|(
name|ret
operator|->
name|author
argument_list|,
name|tmp
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|ret
operator|->
name|author
expr_stmt|;
name|tmp
operator|+=
name|len
expr_stmt|;
operator|*
name|tmp
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|tmp
operator|!=
literal|' '
condition|)
name|tmp
operator|--
expr_stmt|;
name|ret
operator|->
name|author_tz
operator|=
name|tmp
operator|+
literal|1
expr_stmt|;
operator|*
name|tmp
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|tmp
operator|!=
literal|' '
condition|)
name|tmp
operator|--
expr_stmt|;
name|ret
operator|->
name|author_time
operator|=
name|strtoul
argument_list|(
name|tmp
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
operator|*
name|tmp
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|tmp
operator|!=
literal|' '
condition|)
name|tmp
operator|--
expr_stmt|;
name|ret
operator|->
name|author_mail
operator|=
name|tmp
operator|+
literal|1
expr_stmt|;
operator|*
name|tmp
operator|=
literal|0
expr_stmt|;
block|}
end_function
begin_function
DECL|function|format_time
specifier|static
specifier|const
name|char
modifier|*
name|format_time
parameter_list|(
name|unsigned
name|long
name|time
parameter_list|,
specifier|const
name|char
modifier|*
name|tz_str
parameter_list|,
name|int
name|show_raw_time
parameter_list|)
block|{
specifier|static
name|char
name|time_buf
index|[
literal|128
index|]
decl_stmt|;
name|time_t
name|t
init|=
name|time
decl_stmt|;
name|int
name|minutes
decl_stmt|,
name|tz
decl_stmt|;
name|struct
name|tm
modifier|*
name|tm
decl_stmt|;
if|if
condition|(
name|show_raw_time
condition|)
block|{
name|sprintf
argument_list|(
name|time_buf
argument_list|,
literal|"%lu %s"
argument_list|,
name|time
argument_list|,
name|tz_str
argument_list|)
expr_stmt|;
return|return
name|time_buf
return|;
block|}
name|tz
operator|=
name|atoi
argument_list|(
name|tz_str
argument_list|)
expr_stmt|;
name|minutes
operator|=
name|tz
operator|<
literal|0
condition|?
operator|-
name|tz
else|:
name|tz
expr_stmt|;
name|minutes
operator|=
operator|(
name|minutes
operator|/
literal|100
operator|)
operator|*
literal|60
operator|+
operator|(
name|minutes
operator|%
literal|100
operator|)
expr_stmt|;
name|minutes
operator|=
name|tz
operator|<
literal|0
condition|?
operator|-
name|minutes
else|:
name|minutes
expr_stmt|;
name|t
operator|=
name|time
operator|+
name|minutes
operator|*
literal|60
expr_stmt|;
name|tm
operator|=
name|gmtime
argument_list|(
operator|&
name|t
argument_list|)
expr_stmt|;
name|strftime
argument_list|(
name|time_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|time_buf
argument_list|)
argument_list|,
literal|"%Y-%m-%d %H:%M:%S "
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|time_buf
argument_list|,
name|tz_str
argument_list|)
expr_stmt|;
return|return
name|time_buf
return|;
block|}
end_function
begin_function
DECL|function|topo_setter
specifier|static
name|void
name|topo_setter
parameter_list|(
name|struct
name|commit
modifier|*
name|c
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|util_info
modifier|*
name|util
init|=
name|c
operator|->
name|util
decl_stmt|;
name|util
operator|->
name|topo_data
operator|=
name|data
expr_stmt|;
block|}
end_function
begin_function
DECL|function|topo_getter
specifier|static
name|void
modifier|*
name|topo_getter
parameter_list|(
name|struct
name|commit
modifier|*
name|c
parameter_list|)
block|{
name|struct
name|util_info
modifier|*
name|util
init|=
name|c
operator|->
name|util
decl_stmt|;
return|return
name|util
operator|->
name|topo_data
return|;
block|}
end_function
begin_function
DECL|function|read_ancestry
specifier|static
name|int
name|read_ancestry
parameter_list|(
specifier|const
name|char
modifier|*
name|graft_file
parameter_list|,
name|unsigned
name|char
modifier|*
modifier|*
name|start_sha1
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
init|=
name|fopen
argument_list|(
name|graft_file
argument_list|,
literal|"r"
argument_list|)
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
return|return
operator|-
literal|1
return|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fp
argument_list|)
condition|)
block|{
comment|/* The format is just "Commit Parent1 Parent2 ...\n" */
name|int
name|len
init|=
name|strlen
argument_list|(
name|buf
argument_list|)
decl_stmt|;
name|struct
name|commit_graft
modifier|*
name|graft
init|=
name|read_graft_line
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
decl_stmt|;
name|register_commit_graft
argument_list|(
name|graft
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|start_sha1
condition|)
operator|*
name|start_sha1
operator|=
name|graft
operator|->
name|sha1
expr_stmt|;
block|}
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function
begin_function
DECL|function|main
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|commit
modifier|*
name|initial
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
name|sha1
index|[
literal|20
index|]
decl_stmt|,
modifier|*
name|sha1_p
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|filename
init|=
name|NULL
decl_stmt|,
modifier|*
name|commit
init|=
name|NULL
decl_stmt|;
name|char
name|filename_buf
index|[
literal|256
index|]
decl_stmt|;
name|int
name|sha1_len
init|=
literal|8
decl_stmt|;
name|int
name|compatibility
init|=
literal|0
decl_stmt|;
name|int
name|show_raw_time
init|=
literal|0
decl_stmt|;
name|int
name|options
init|=
literal|1
decl_stmt|;
name|struct
name|commit
modifier|*
name|start_commit
decl_stmt|;
specifier|const
name|char
modifier|*
name|args
index|[
literal|10
index|]
decl_stmt|;
name|struct
name|rev_info
name|rev
decl_stmt|;
name|struct
name|commit_info
name|ci
decl_stmt|;
specifier|const
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|max_digits
decl_stmt|;
name|int
name|longest_file
decl_stmt|,
name|longest_author
decl_stmt|;
name|int
name|found_rename
decl_stmt|;
specifier|const
name|char
modifier|*
name|prefix
init|=
name|setup_git_directory
argument_list|()
decl_stmt|;
name|git_config
argument_list|(
name|git_default_config
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|options
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-h"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--help"
argument_list|)
condition|)
name|usage
argument_list|(
name|blame_usage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-l"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--long"
argument_list|)
condition|)
block|{
name|sha1_len
operator|=
literal|40
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-c"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--compatibility"
argument_list|)
condition|)
block|{
name|compatibility
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-t"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--time"
argument_list|)
condition|)
block|{
name|show_raw_time
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-S"
argument_list|)
condition|)
block|{
if|if
condition|(
name|i
operator|+
literal|1
operator|<
name|argc
operator|&&
operator|!
name|read_ancestry
argument_list|(
name|argv
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
operator|&
name|sha1_p
argument_list|)
condition|)
block|{
name|compatibility
operator|=
literal|1
expr_stmt|;
name|i
operator|++
expr_stmt|;
continue|continue;
block|}
name|usage
argument_list|(
name|blame_usage
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"--"
argument_list|)
condition|)
block|{
name|options
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|argv
index|[
name|i
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
name|usage
argument_list|(
name|blame_usage
argument_list|)
expr_stmt|;
name|options
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|options
condition|)
block|{
if|if
condition|(
operator|!
name|filename
condition|)
name|filename
operator|=
name|argv
index|[
name|i
index|]
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|commit
condition|)
name|commit
operator|=
name|argv
index|[
name|i
index|]
expr_stmt|;
else|else
name|usage
argument_list|(
name|blame_usage
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|filename
condition|)
name|usage
argument_list|(
name|blame_usage
argument_list|)
expr_stmt|;
if|if
condition|(
name|commit
operator|&&
name|sha1_p
condition|)
name|usage
argument_list|(
name|blame_usage
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|commit
condition|)
name|commit
operator|=
literal|"HEAD"
expr_stmt|;
if|if
condition|(
name|prefix
condition|)
name|sprintf
argument_list|(
name|filename_buf
argument_list|,
literal|"%s%s"
argument_list|,
name|prefix
argument_list|,
name|filename
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|filename_buf
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|filename
operator|=
name|filename_buf
expr_stmt|;
if|if
condition|(
operator|!
name|sha1_p
condition|)
block|{
if|if
condition|(
name|get_sha1
argument_list|(
name|commit
argument_list|,
name|sha1
argument_list|)
condition|)
name|die
argument_list|(
literal|"get_sha1 failed, commit '%s' not found"
argument_list|,
name|commit
argument_list|)
expr_stmt|;
name|sha1_p
operator|=
name|sha1
expr_stmt|;
block|}
name|start_commit
operator|=
name|lookup_commit_reference
argument_list|(
name|sha1_p
argument_list|)
expr_stmt|;
name|get_util
argument_list|(
name|start_commit
argument_list|)
operator|->
name|pathname
operator|=
name|filename
expr_stmt|;
if|if
condition|(
name|fill_util_info
argument_list|(
name|start_commit
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s not found in %s\n"
argument_list|,
name|filename
argument_list|,
name|commit
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|init_revisions
argument_list|(
operator|&
name|rev
argument_list|,
name|setup_git_directory
argument_list|()
argument_list|)
expr_stmt|;
name|rev
operator|.
name|remove_empty_trees
operator|=
literal|1
expr_stmt|;
name|rev
operator|.
name|topo_order
operator|=
literal|1
expr_stmt|;
name|rev
operator|.
name|prune_fn
operator|=
name|simplify_commit
expr_stmt|;
name|rev
operator|.
name|topo_setter
operator|=
name|topo_setter
expr_stmt|;
name|rev
operator|.
name|topo_getter
operator|=
name|topo_getter
expr_stmt|;
name|rev
operator|.
name|parents
operator|=
literal|1
expr_stmt|;
name|rev
operator|.
name|limited
operator|=
literal|1
expr_stmt|;
name|commit_list_insert
argument_list|(
name|start_commit
argument_list|,
operator|&
name|rev
operator|.
name|commits
argument_list|)
expr_stmt|;
name|args
index|[
literal|0
index|]
operator|=
name|filename
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|diff_tree_setup_paths
argument_list|(
name|args
argument_list|,
operator|&
name|rev
operator|.
name|pruning
argument_list|)
expr_stmt|;
name|prepare_revision_walk
argument_list|(
operator|&
name|rev
argument_list|)
expr_stmt|;
name|process_commits
argument_list|(
operator|&
name|rev
argument_list|,
name|filename
argument_list|,
operator|&
name|initial
argument_list|)
expr_stmt|;
name|buf
operator|=
name|blame_contents
expr_stmt|;
for|for
control|(
name|max_digits
operator|=
literal|1
operator|,
name|i
operator|=
literal|10
init|;
name|i
operator|<=
name|num_blame_lines
operator|+
literal|1
condition|;
name|max_digits
operator|++
control|)
name|i
operator|*=
literal|10
expr_stmt|;
name|longest_file
operator|=
literal|0
expr_stmt|;
name|longest_author
operator|=
literal|0
expr_stmt|;
name|found_rename
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_blame_lines
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|commit
modifier|*
name|c
init|=
name|blame_lines
index|[
name|i
index|]
decl_stmt|;
name|struct
name|util_info
modifier|*
name|u
decl_stmt|;
if|if
condition|(
operator|!
name|c
condition|)
name|c
operator|=
name|initial
expr_stmt|;
name|u
operator|=
name|c
operator|->
name|util
expr_stmt|;
if|if
condition|(
operator|!
name|found_rename
operator|&&
name|strcmp
argument_list|(
name|filename
argument_list|,
name|u
operator|->
name|pathname
argument_list|)
condition|)
name|found_rename
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|longest_file
operator|<
name|strlen
argument_list|(
name|u
operator|->
name|pathname
argument_list|)
condition|)
name|longest_file
operator|=
name|strlen
argument_list|(
name|u
operator|->
name|pathname
argument_list|)
expr_stmt|;
name|get_commit_info
argument_list|(
name|c
argument_list|,
operator|&
name|ci
argument_list|)
expr_stmt|;
if|if
condition|(
name|longest_author
operator|<
name|strlen
argument_list|(
name|ci
operator|.
name|author
argument_list|)
condition|)
name|longest_author
operator|=
name|strlen
argument_list|(
name|ci
operator|.
name|author
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_blame_lines
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|commit
modifier|*
name|c
init|=
name|blame_lines
index|[
name|i
index|]
decl_stmt|;
name|struct
name|util_info
modifier|*
name|u
decl_stmt|;
if|if
condition|(
operator|!
name|c
condition|)
name|c
operator|=
name|initial
expr_stmt|;
name|u
operator|=
name|c
operator|->
name|util
expr_stmt|;
name|get_commit_info
argument_list|(
name|c
argument_list|,
operator|&
name|ci
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|sha1_to_hex
argument_list|(
name|c
operator|->
name|object
operator|.
name|sha1
argument_list|)
argument_list|,
name|sha1_len
argument_list|,
literal|1
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
name|compatibility
condition|)
block|{
name|printf
argument_list|(
literal|"\t(%10s\t%10s\t%d)"
argument_list|,
name|ci
operator|.
name|author
argument_list|,
name|format_time
argument_list|(
name|ci
operator|.
name|author_time
argument_list|,
name|ci
operator|.
name|author_tz
argument_list|,
name|show_raw_time
argument_list|)
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|found_rename
condition|)
name|printf
argument_list|(
literal|" %-*.*s"
argument_list|,
name|longest_file
argument_list|,
name|longest_file
argument_list|,
name|u
operator|->
name|pathname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" (%-*.*s %10s %*d) "
argument_list|,
name|longest_author
argument_list|,
name|longest_author
argument_list|,
name|ci
operator|.
name|author
argument_list|,
name|format_time
argument_list|(
name|ci
operator|.
name|author_time
argument_list|,
name|ci
operator|.
name|author_tz
argument_list|,
name|show_raw_time
argument_list|)
argument_list|,
name|max_digits
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
name|num_blame_lines
operator|-
literal|1
condition|)
block|{
name|fwrite
argument_list|(
name|buf
argument_list|,
name|blame_len
operator|-
operator|(
name|buf
operator|-
name|blame_contents
operator|)
argument_list|,
literal|1
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
name|blame_contents
index|[
name|blame_len
operator|-
literal|1
index|]
operator|!=
literal|'\n'
condition|)
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|next_buf
init|=
name|strchr
argument_list|(
name|buf
argument_list|,
literal|'\n'
argument_list|)
operator|+
literal|1
decl_stmt|;
name|fwrite
argument_list|(
name|buf
argument_list|,
name|next_buf
operator|-
name|buf
argument_list|,
literal|1
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|buf
operator|=
name|next_buf
expr_stmt|;
block|}
block|}
if|if
condition|(
name|DEBUG
condition|)
block|{
name|printf
argument_list|(
literal|"num get patch: %d\n"
argument_list|,
name|num_get_patch
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"num commits: %d\n"
argument_list|,
name|num_commits
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"patch time: %f\n"
argument_list|,
name|patch_time
operator|/
literal|1000000.0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"initial: %s\n"
argument_list|,
name|sha1_to_hex
argument_list|(
name|initial
operator|->
name|object
operator|.
name|sha1
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function
end_unit
