begin_unit
begin_include
include|#
directive|include
file|"cache.h"
end_include
begin_include
include|#
directive|include
file|"pack.h"
end_include
begin_function
DECL|function|verify_packfile
specifier|static
name|int
name|verify_packfile
parameter_list|(
name|struct
name|packed_git
modifier|*
name|p
parameter_list|)
block|{
name|unsigned
name|long
name|index_size
init|=
name|p
operator|->
name|index_size
decl_stmt|;
name|void
modifier|*
name|index_base
init|=
name|p
operator|->
name|index_base
decl_stmt|;
name|SHA_CTX
name|ctx
decl_stmt|;
name|unsigned
name|char
name|sha1
index|[
literal|20
index|]
decl_stmt|;
name|unsigned
name|long
name|pack_size
init|=
name|p
operator|->
name|pack_size
decl_stmt|;
name|void
modifier|*
name|pack_base
decl_stmt|;
name|struct
name|pack_header
modifier|*
name|hdr
decl_stmt|;
name|int
name|nr_objects
decl_stmt|;
name|hdr
operator|=
name|p
operator|->
name|pack_base
expr_stmt|;
if|if
condition|(
name|hdr
operator|->
name|hdr_signature
operator|!=
name|htonl
argument_list|(
name|PACK_SIGNATURE
argument_list|)
condition|)
return|return
name|error
argument_list|(
literal|"Packfile signature mismatch"
argument_list|,
name|p
operator|->
name|pack_name
argument_list|)
return|;
if|if
condition|(
name|hdr
operator|->
name|hdr_version
operator|!=
name|htonl
argument_list|(
name|PACK_VERSION
argument_list|)
condition|)
return|return
name|error
argument_list|(
literal|"Packfile version %d different from ours %d"
argument_list|,
name|ntohl
argument_list|(
name|hdr
operator|->
name|hdr_version
argument_list|)
argument_list|,
name|PACK_VERSION
argument_list|)
return|;
name|nr_objects
operator|=
name|ntohl
argument_list|(
name|hdr
operator|->
name|hdr_entries
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_packed_objects
argument_list|(
name|p
argument_list|)
operator|!=
name|nr_objects
condition|)
return|return
name|error
argument_list|(
literal|"Packfile claims to have %d objects, "
literal|"while idx size expects %d"
argument_list|,
name|nr_objects
argument_list|,
name|num_packed_objects
argument_list|(
name|p
argument_list|)
argument_list|)
return|;
name|SHA1_Init
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|pack_base
operator|=
name|p
operator|->
name|pack_base
expr_stmt|;
name|SHA1_Update
argument_list|(
operator|&
name|ctx
argument_list|,
name|pack_base
argument_list|,
name|pack_size
operator|-
literal|20
argument_list|)
expr_stmt|;
name|SHA1_Final
argument_list|(
name|sha1
argument_list|,
operator|&
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|sha1
argument_list|,
name|index_base
operator|+
name|index_size
operator|-
literal|40
argument_list|,
literal|20
argument_list|)
condition|)
return|return
name|error
argument_list|(
literal|"Packfile %s SHA1 mismatch with idx"
argument_list|,
name|p
operator|->
name|pack_name
argument_list|)
return|;
if|if
condition|(
name|memcmp
argument_list|(
name|sha1
argument_list|,
name|pack_base
operator|+
name|pack_size
operator|-
literal|20
argument_list|,
literal|20
argument_list|)
condition|)
return|return
name|error
argument_list|(
literal|"Packfile %s SHA1 mismatch with itself"
argument_list|,
name|p
operator|->
name|pack_name
argument_list|)
return|;
return|return
literal|0
return|;
block|}
end_function
begin_function
DECL|function|verify_pack
name|int
name|verify_pack
parameter_list|(
name|struct
name|packed_git
modifier|*
name|p
parameter_list|)
block|{
name|unsigned
name|long
name|index_size
init|=
name|p
operator|->
name|index_size
decl_stmt|;
name|void
modifier|*
name|index_base
init|=
name|p
operator|->
name|index_base
decl_stmt|;
name|SHA_CTX
name|ctx
decl_stmt|;
name|unsigned
name|char
name|sha1
index|[
literal|20
index|]
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* Verify SHA1 sum of the index file */
name|SHA1_Init
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|SHA1_Update
argument_list|(
operator|&
name|ctx
argument_list|,
name|index_base
argument_list|,
name|index_size
operator|-
literal|20
argument_list|)
expr_stmt|;
name|SHA1_Final
argument_list|(
name|sha1
argument_list|,
operator|&
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|sha1
argument_list|,
name|index_base
operator|+
name|index_size
operator|-
literal|20
argument_list|,
literal|20
argument_list|)
condition|)
return|return
name|error
argument_list|(
literal|"Packfile index for %s SHA1 mismatch"
argument_list|,
name|p
operator|->
name|pack_name
argument_list|)
return|;
comment|/* Verify pack file */
name|use_packed_git
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|ret
operator|=
name|verify_packfile
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|unuse_packed_git
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function
end_unit
